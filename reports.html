<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .step-header {
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }
        .form-check-group {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Universal Report Builder</h1>
            <div>
                <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
                <a href="/admin.html" class="btn btn-outline-secondary">Go to Admin Console</a>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <p class="text-muted">Define a universal data-table report for any Team and Category combination. This layout applies globally and generates an aggregated XLSX file with claim counts and other selected metrics.</p>
                
                <div class="row bg-light p-3 rounded mb-4 g-3">
                    <div class="col-md-4">
                        <label class="step-header">1. Select Team</label>
                        <select class="form-select" id="reportBuilderTeam"><option>Loading teams...</option></select>
                    </div>
                    <div class="col-md-4">
                        <label class="step-header">2. Select Category</label>
                        <select class="form-select" id="reportBuilderCategory" disabled><option>Select a team...</option></select>
                    </div>
                    <div class="col-md-4">
                        <label class="step-header">3. Select Client Config for Columns</label>
                        <select class="form-select" id="columnSourceConfig" disabled><option>Select team & category...</option></select>
                    </div>
                </div>

                <div id="builderContainer" class="d-none">
                    <h5 id="builderHeader"></h5>
                     <form id="reportBuilderForm">
                        <input type="hidden" id="teamReportConfigId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="step-header">4. Group By Columns</label>
                                <div id="teamReportColumns" class="form-check-group bg-white mb-3">
                                    <p class="text-muted small">Select a client configuration to see available columns.</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="step-header">5. Select Metrics</label>
                                <div id="teamReportMetrics" class="form-check-group bg-white mb-3">
                                    <p class="text-muted small">Select a client configuration to see available metrics.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="teamReportTitle" class="form-label"><b>6. Report Title Template (Optional)</b></label>
                            <input type="text" class="form-control" id="teamReportTitle" placeholder="{teamName} - {categoryName} Summary {date}">
                            <div class="form-text">This is currently not used in the XLSX output but can be stored for future use.</div>
                        </div>

                        <hr>
                        <button type="button" class="btn btn-primary" id="saveReportLayoutBtn">Save Report Layout</button>
                        <button type="button" class="btn btn-danger" id="deleteReportLayoutBtn" disabled>Delete This Layout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // API Endpoints
    const TEAMS_API = '/.netlify/functions/teams';
    const CATEGORIES_API = '/.netlify/functions/categories';
    const CONFIG_API = '/.netlify/functions/configurations';
    const TEAM_REPORTS_API = '/.netlify/functions/team-report-configs';

    // DOM Elements
    const reportBuilderTeam = document.getElementById('reportBuilderTeam');
    const reportBuilderCategory = document.getElementById('reportBuilderCategory');
    const columnSourceConfig = document.getElementById('columnSourceConfig');
    const builderContainer = document.getElementById('builderContainer');
    const builderHeader = document.getElementById('builderHeader');
    const reportBuilderForm = document.getElementById('reportBuilderForm');
    const teamReportConfigIdInput = document.getElementById('teamReportConfigId');
    const teamReportColumns = document.getElementById('teamReportColumns');
    const teamReportMetrics = document.getElementById('teamReportMetrics');
    const teamReportTitleInput = document.getElementById('teamReportTitle');
    const saveReportLayoutBtn = document.getElementById('saveReportLayoutBtn');
    const deleteReportLayoutBtn = document.getElementById('deleteReportLayoutBtn');

    // Global State
    let allTeams = [], allCategories = [], allClientConfigs = [], allTeamReportConfigs = [];

    const standardFields = [
        { key: 'claimId', displayName: 'Claim ID / Number' }, { key: 'age', displayName: 'Age (in days)' }, { key: 'netPayment', displayName: 'Net Payment Amount' }, { key: 'state', displayName: 'Claim State' }, { key: 'status', displayName: 'Claim Status' }, { key: 'networkStatus', displayName: 'Network Status' }, { key: 'providerName', displayName: 'Billing Provider Name' }, { key: 'edit', displayName: 'Claim Edits' }, { key: 'notes', displayName: 'Claim Notes' }, { key: 'totalCharges', displayName: 'Total Billed Amount' }, { key: 'dsnp', displayName: 'DSNP Status' }, { key: 'payer', displayName: 'Payer Name' }, { key: 'claimCategory', displayName: 'Category' }, { key: 'claimType', displayName: 'Claim Type' }, { key: 'receivedDate', displayName: 'Received Date' }, { key: 'billingProviderTaxId', displayName: 'Billing Provider Tax ID' }, { key: 'billingProviderNpi', displayName: 'Billing Provider NPI' }, { key: 'patientName', displayName: 'Patient Name' }, { key: 'subscriberId', displayName: 'Subscriber ID' }, { key: 'renderingProviderName', displayName: 'Rendering Provider Name' }, { key: 'renderingProviderNpi', displayName: 'Rendering Provider NPI' }, { key: 'dosFrom', displayName: 'Date of Service (From)' }, { key: 'dosTo', displayName: 'Date of Service (To)' }, { key: 'cleanAge', displayName: 'Clean Age' }, { key: 'pbpName', displayName: 'PBP Name' }, { key: 'planName', displayName: 'Plan Name' }, { key: 'activityLog', displayName: 'Activity Log Description' }, { key: 'activityUser', displayName: 'Activity Performed By' }, { key: 'activityDate', displayName: 'Activity Performed On' }
    ];

    // --- DATA LOADING ---
    async function loadAllData() {
        try {
            const [teamsRes, catRes, configRes, teamReportsRes] = await Promise.all([
                fetch(TEAMS_API), fetch(CATEGORIES_API), fetch(CONFIG_API), fetch(TEAM_REPORTS_API)
            ]);
            allTeams = await teamsRes.json();
            allCategories = await catRes.json();
            allClientConfigs = await configRes.json();
            allTeamReportConfigs = await teamReportsRes.json();
            
            // Populate Teams
            reportBuilderTeam.innerHTML = '<option value="">Select a team...</option>';
            allTeams.sort((a,b) => a.team_name.localeCompare(b.team_name)).forEach(team => {
                reportBuilderTeam.add(new Option(team.team_name, team.id));
            });
            
            // Populate Client Configs
            columnSourceConfig.innerHTML = '<option value="">Select a config...</option>';
            allClientConfigs.sort((a,b) => a.config_name.localeCompare(b.config_name)).forEach(config => {
                columnSourceConfig.add(new Option(config.config_name, config.id));
            });

        } catch (error) {
            console.error("Failed to load initial report builder data:", error);
            alert("Error loading data. Please check the console and refresh the page.");
        }
    }

    // --- UI RENDERING & LOGIC ---

    function populateColumnsAndMetrics() {
        const configId = columnSourceConfig.value;
        const selectedConfig = allClientConfigs.find(c => c.id == configId);
        teamReportColumns.innerHTML = '';
        teamReportMetrics.innerHTML = '';

        if (!selectedConfig || !selectedConfig.config_data.columnMappings) {
            teamReportColumns.innerHTML = '<p class="text-muted small">Select a client configuration to see available columns.</p>';
            teamReportMetrics.innerHTML = '<p class="text-muted small">Select a client configuration to see available metrics.</p>';
            return;
        }

        const mappedKeys = new Set(Object.keys(selectedConfig.config_data.columnMappings));
        
        // Populate Columns for Grouping
        standardFields.forEach(field => {
            if (mappedKeys.has(field.key)) {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `<input class="form-check-input" type="checkbox" value="${field.key}" id="col_${field.key}">
                                 <label class="form-check-label" for="col_${field.key}">${field.displayName}</label>`;
                teamReportColumns.appendChild(div);
            }
        });

        // Populate Metrics
        const availableMetrics = [
            { key: 'count', displayName: 'Count of Claims', required: ['claimId'] },
            { key: 'avgAge', displayName: 'Average Claim Age', required: ['age'] },
            { key: 'avgCleanAge', displayName: 'Average Clean Age', required: ['cleanAge'] }
        ];

        availableMetrics.forEach(metric => {
            const hasRequiredCols = metric.required.every(key => mappedKeys.has(key));
            if (hasRequiredCols) {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `<input class="form-check-input" type="checkbox" value="${metric.key}" id="met_${metric.key}">
                                 <label class="form-check-label" for="met_${metric.key}">${metric.displayName}</label>`;
                teamReportMetrics.appendChild(div);
            }
        });
        
        if (teamReportColumns.children.length === 0) {
             teamReportColumns.innerHTML = '<p class="text-danger small">The selected config has no columns mapped.</p>';
        }
        if (teamReportMetrics.children.length === 0) {
             teamReportMetrics.innerHTML = '<p class="text-danger small">The selected config lacks the required columns for any metrics (e.g., Age).</p>';
        }
    }

    function loadExistingReportConfig() {
        const teamId = reportBuilderTeam.value;
        const categoryId = reportBuilderCategory.value;

        // Reset and hide the main builder form first
        builderContainer.classList.add('d-none');
        reportBuilderForm.reset();
        teamReportConfigIdInput.value = '';
        deleteReportLayoutBtn.disabled = true;

        if (!teamId || !categoryId) {
            columnSourceConfig.disabled = true;
            return;
        }
        
        columnSourceConfig.disabled = false;
        const team = allTeams.find(t => t.id == teamId);
        const category = allCategories.find(c => c.id == categoryId);
        builderHeader.textContent = `Building Report For: ${team.team_name} â†’ ${category.category_name}`;

        const existingConfig = allTeamReportConfigs.find(c => c.team_id == teamId && c.category_id == categoryId);
        
        if (existingConfig) {
            const layout = existingConfig.report_config_data;
            teamReportConfigIdInput.value = existingConfig.id;
            teamReportTitleInput.value = layout.reportTitle || '';
            columnSourceConfig.value = layout.sourceConfigId || '';
            
            populateColumnsAndMetrics(); // Populate checkboxes based on saved config
            
            // Check the saved columns and metrics
            if (layout.groupBy) {
                layout.groupBy.forEach(key => {
                    const checkbox = document.getElementById(`col_${key}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            if (layout.metrics) {
                layout.metrics.forEach(key => {
                    const checkbox = document.getElementById(`met_${key}`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            deleteReportLayoutBtn.disabled = false;
        } else {
            // No existing config, just clear the form
            columnSourceConfig.value = '';
            populateColumnsAndMetrics();
        }
        
        builderContainer.classList.remove('d-none');
    }

    async function saveTeamReportLayout() {
        const teamId = reportBuilderTeam.value;
        const categoryId = reportBuilderCategory.value;
        const configId = teamReportConfigIdInput.value;
        const sourceConfigId = columnSourceConfig.value;

        if (!teamId || !categoryId || !sourceConfigId) {
            return alert('A team, category, and source client configuration must be selected.');
        }

        const selectedColumns = Array.from(teamReportColumns.querySelectorAll('input:checked')).map(cb => cb.value);
        const selectedMetrics = Array.from(teamReportMetrics.querySelectorAll('input:checked')).map(cb => cb.value);

        if (selectedColumns.length === 0) {
            return alert('Please select at least one column to group by.');
        }
        if (selectedMetrics.length === 0) {
            return alert('Please select at least one metric to calculate.');
        }

        const report_config_data = {
            sourceConfigId: sourceConfigId,
            reportTitle: teamReportTitleInput.value.trim(),
            groupBy: selectedColumns,
            metrics: selectedMetrics
        };
        
        const method = configId ? 'PUT' : 'POST';
        const url = configId ? `${TEAM_REPORTS_API}?id=${configId}` : TEAM_REPORTS_API;
        
        try {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ team_id: parseInt(teamId), category_id: parseInt(categoryId), report_config_data })
            });
            if (!res.ok) throw new Error(`Server responded with ${res.status}`);
            
            alert('Team report layout saved successfully!');
            // Reload configs and refresh UI
            const teamReportsRes = await fetch(TEAM_REPORTS_API);
            allTeamReportConfigs = await teamReportsRes.json();
            loadExistingReportConfig();

        } catch (error) {
            console.error('Failed to save team report layout:', error);
            alert(`Failed to save layout: ${error.message}`);
        }
    }

    async function deleteTeamReportLayout() {
        const configId = teamReportConfigIdInput.value;
        if (!configId || !confirm('Are you sure you want to delete this report layout?')) return;
        
        try {
            const res = await fetch(`${TEAM_REPORTS_API}?id=${configId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(`Server responded with ${res.status}`);
            alert('Report layout deleted.');
            
            // Reload configs and reset UI
            const teamReportsRes = await fetch(TEAM_REPORTS_API);
            allTeamReportConfigs = await teamReportsRes.json();
            loadExistingReportConfig();

        } catch (error) {
            console.error('Failed to delete team report layout:', error);
            alert(`Failed to delete layout: ${error.message}`);
        }
    }

    // --- EVENT LISTENERS ---
    reportBuilderTeam.addEventListener('change', () => {
        const teamId = parseInt(reportBuilderTeam.value, 10);
        builderContainer.classList.add('d-none');
        reportBuilderCategory.innerHTML = '<option>Select a team...</option>';
        reportBuilderCategory.disabled = true;
        columnSourceConfig.disabled = true;
        if (!teamId) return;
        
        const categoriesForTeam = allCategories.filter(c => c.team_id === teamId);
        reportBuilderCategory.innerHTML = '<option value="">Select a category...</option>';
        categoriesForTeam.sort((a,b) => a.category_name.localeCompare(b.category_name)).forEach(cat => {
            reportBuilderCategory.add(new Option(cat.category_name, cat.id));
        });
        reportBuilderCategory.disabled = false;
    });

    reportBuilderCategory.addEventListener('change', loadExistingReportConfig);
    columnSourceConfig.addEventListener('change', () => {
        // Repopulate columns, but don't check any boxes automatically
        populateColumnsAndMetrics();
        // User must re-select their columns if they change the source config
    });

    saveReportLayoutBtn.addEventListener('click', saveTeamReportLayout);
    deleteReportLayoutBtn.addEventListener('click', deleteTeamReportLayout);

    // --- INITIAL PAGE LOAD ---
    loadAllData();
});
</script>
</body>
</html>
