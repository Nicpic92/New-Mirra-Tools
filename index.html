<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Claims Dashboard & Analytics Engine</title>
    <!-- Libraries and CSS (unchanged) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Styles (unchanged) */
        body { font-family: system-ui, sans-serif; }
        .dashboard-card { border-left-width: 4px; }
        .metric-value { font-size: 2.25rem; font-weight: 700; }
        #work-queue-table th { background-color: #005A9C; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <!-- Header Section (unchanged) -->
        <header class="mb-4 d-flex justify-content-between align-items-center">
             <div>
                <img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAZCAYAAAC115MjAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAARRSURBVChTPZf/a9NXHMc/520kLg3L+m2DIsO2pKGv+i8u/AN2d9FNHHRwdr3sDqYru93VzU5XV7c3o05FmJ2YqW432B/A68qKVgN6KVoLqS11475c7nN/eR5+25f6eRy9Dw79dE/u+RzP53O+z+f+uD/wPz3uA1fC42BxeBQ8DheDh8HDZfD4WIKzVqv18wDXtrY25s2bx2tra4kX+n54s/M64N/gH5EHgP/7xGQSqe7u7lYhV3Z2Nua9vLzg6enpiF5fXxs/pW/gT+BvIF8A/gb+D3yKq4s/cIX2z/sT29vbH9s2fPLkSbS2trb68OHDH2uVSqXgVqv13wC/AwCgVCrl6unpATs7O9f5z3kK2d/fD6WlpQ9fXV3t5b3LsbGx/Nra2pIbnJ+f/w+Qy+W0W61Wqf56vR729/f/kYmRkZGMYwDwwv17eno251z5dCAQyC0Wi3k/Pz87f7+A0+m0f3Nzc3s4HF65yWZycnL24x+5XC4AIBqNQgUCAcDOzs7O1tZWvL+/P/F+f38/xGIxDAwM/JpZ1GAwSA+HQ6pQKMjJkycxsW6r1UoFAgEMDAwA1NbWwuLiYgwODsLl5eXoQSAQAAgEAhgYGPg1s6jBYJCeSqV0WCwWub+/H/f39+P8/HyPzwCgvb0dAICJiQmcTqflM2tO7+/vTxx+/vx5jMVi4OXl5X9+SAYGBgCcnZ2BIBAIkMvlYDAY/s1sKhgMkobD4Wr5fD6lVqs1Xl5exvX19b/X19e/19fX/4/5AOTz+QCA6urqIC4uDoFAIFqvzS0xMTHxh/sB+Xw+FkqlUqvVajWfz4eBgQF+s1+1Gg01GAxSTqcTYTabEY/HYWdnZ2fr6uoS4z0tPUfUajUrVqsVn88nAODs7AxxDeDk5IQpFAopFou1ZtfrNb7pSRQKEQ8fPhzL5/MBnJ2dgXg8/jX/Xzkcju/j8VguFotzTafTmUwmf3Z3d+f0ej0Wi8XpNEql0h+LRYIgCGf39/fLZ8kIBAKEgYGBFysUCgCAi4sLfL58eXl5GSA+Pj6W0+l0Xl5expw1qMVisVgs5tY8Gg22tbVlX1hY+EVFRUVnZ2fBbrd/+3a7/bN+s+v1erFcrvzr6+v/JpPJ4J35xIkTJ3p6eiKz2Xxar9e/+eXl5U8sFitfX1+PcXJyYtq2bQ+n0znnzMxMkMvlcnp6+o/v7+/r7e2t1Wr1u/b29n+1tbXlOI4vW1paHh8fD7lcrtfr9etLS0ufXlxc/PNf319fX//P/wKkUql0OByW0Wj8sFqtYLPZH38+n/+0XC6/n0wmP8lk8s/Z7HY7KBSK/1wul+8qlcq/Vqv1XygU/uX19fUvnU7n/Uaj8f9KpfI/oVDoX6PROBgM/m9sQ+w7g/8/l8sVsNls/qJSqb+lUumPFy9efF6r1T6bzeZ/stnsv6vV6h/X6/X/z6f3k0Ufgs2LwOLwCHgcrAaPw8Pgg/AhOM4X/n/D31/B/gU1Fh0wWlC6GgAAAABJRU5ErkJggg==' alt="Mirra Logo" style="height: 24px;">
                <h1>Claims Processing Dashboard</h1>
            </div>
            <a href="/admin.html" class="btn btn-outline-primary">Admin Console</a>
        </header>

        <!-- File Input & Options (unchanged) -->
        <div class="card p-3 mb-4 bg-light border-0">
            <h5>1. Upload Claims Data</h5>
            <input class="form-control" type="file" id="reportFile" accept=".xlsx, .csv">
        </div>
        <div class="card p-3 mb-4">
            <h5>2. Report Options</h5>
            <div class="row align-items-end">
                <div class="col-md-6 mb-3"><label for="configSelector" class="form-label small fw-bold">Select Report Configuration</label><select class="form-select" id="configSelector"><option>Loading...</option></select></div>
                <div class="col-md-6 mb-3"><label for="clientName" class="form-label small fw-bold">Client Name</label><input type="text" class="form-control" id="clientName" readonly></div>
            </div>
        </div>
        
        <div id="dashboardContent" style="display: none;">
            <!-- Download Buttons Section - UPDATED -->
            <div class="card p-3 mb-4">
                <h5 class="card-title fw-bold">3. Download Reports</h5>
                <div id="teamReportButtons" class="d-grid gap-2 d-md-flex">
                    <p class="text-muted">Process a file to generate download buttons.</p>
                </div>
                 <hr>
                 <button class="btn btn-dark w-100" id="generatePdfBtn">Download Detailed PDF Summary</button>
            </div>

            <!-- Tab Navigation (unchanged) -->
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboard-pane" type="button">Analytics Dashboard</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#work-queue-pane" type="button">Operational Work Queue</button></li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content border border-top-0 p-3 bg-white">
                <!-- Dashboard Pane (unchanged) -->
                <div class="tab-pane fade show active" id="dashboard-pane" role="tabpanel">
                     <!-- All charts and tables for the dashboard go here... -->
                </div>
                <!-- Work Queue Pane - UPDATED -->
                <div class="tab-pane fade" id="work-queue-pane" role="tabpanel">
                    <div class="card p-3 mb-3 bg-light border-0">
                        <label for="categoryFilter" class="form-label fw-bold">Filter by Category</label>
                        <select id="categoryFilter" class="form-select"></select>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="work-queue-table">
                            <thead>
                                <tr>
                                    <th data-sort="priorityScore">Priority Score</th>
                                    <th data-sort="category">Category</th>
                                    <th data-sort="source">Source</th> <!-- NEW COLUMN -->
                                    <th data-sort="teamName">Assigned Team</th>
                                    <th data-sort="claimId">Claim ID</th>
                                    <th data-sort="age">Age</th>
                                    <th data-sort="netPayment">Amount at Risk</th>
                                    <th data-sort="providerName">Billing Provider</th>
                                </tr>
                            </thead>
                            <tbody id="work-queue-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // --- Global Variables ---
    let allClaimsData = [];
    let aggregatedMetrics = {};
    let myCharts = {};
    let currentSort = { column: 'priorityScore', direction: 'desc' };
    let currentColumnMappings = {}; 
    let allConfigs = [];
    // UPDATED: More complex categorization config
    let categorizationConfig = {
        editRulesMap: new Map(),
        noteRulesMap: new Map()
    };

    // --- SMART getVal FUNCTION (Unchanged) ---
    const getVal = (claim, standardKey) => {
        const mappedKey = currentColumnMappings[standardKey];
        return (mappedKey && claim[mappedKey] !== undefined) ? claim[mappedKey] : undefined;
    };

    // --- DYNAMIC CATEGORIZATION LOGIC ---

    // UPDATED: Fetches both rule types
    async function loadCategorizationConfig() {
        try {
            const response = await fetch('/.netlify/functions/get-categorization-config');
            const config = await response.json();
            // Maps now store a full object with category and team info
            categorizationConfig.editRulesMap = new Map(config.editRules.map(r => [r.edit_text, { category: r.category_name, teamId: r.team_id, teamName: r.team_name }]));
            categorizationConfig.noteRulesMap = new Map(config.noteRules.map(r => [r.note_keyword, { category: r.category_name, teamId: r.team_id, teamName: r.team_name }]));
        } catch (error) { console.error("Could not load categorization rules:", error); }
    }

    // UPDATED: More sophisticated logic returning an object
    function getClaimCategory(claim) {
        const notes = (getVal(claim, 'notes') || '').toLowerCase();
        const edit = getVal(claim, 'edit');

        // 1. Check for a DB rule match in Claim Edits
        if (edit && categorizationConfig.editRulesMap.has(edit)) {
            const rule = categorizationConfig.editRulesMap.get(edit);
            return { ...rule, source: 'Edit Rule' };
        }

        // 2. Search for a keyword match in Claim Notes
        if (notes) {
            for (const [keyword, rule] of categorizationConfig.noteRulesMap.entries()) {
                if (notes.includes(keyword)) {
                    return { ...rule, source: 'Note Rule' };
                }
            }
        }
        
        // 3. Fallback logic
        const totalCharges = parseFloat(getVal(claim, 'totalCharges') || 0);
        if (totalCharges > 50000) return { category: 'On Hold: High Dollar Review', source: 'Fallback', teamName: 'High Dollar Review Team' };
        if (notes.includes('duplicate') || (edit || '').toLowerCase().includes('duplicate')) return { category: 'On Hold: Duplicate', source: 'Fallback', teamName: 'Onshore' };
        
        // 4. Default
        return { category: 'Needs Triage', source: 'Default', teamName: 'Onshore' };
    }

    // --- CONFIGURATION & EVENT LISTENERS ---
    async function populateConfigSelector() { /* Unchanged from previous full version */ }
    document.getElementById('configSelector').addEventListener('change', (e) => { /* Unchanged */ });

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportFile').addEventListener('change', (e) => handleFile(e, false));
        document.getElementById('generatePdfBtn').addEventListener('click', generateStructuredPDF);
        document.getElementById('work-queue-table').querySelector('thead').addEventListener('click', (e) => {
            const header = e.target.closest('th');
            if (header?.dataset.sort) {
                const sortKey = header.dataset.sort;
                currentSort.direction = (currentSort.column === sortKey && currentSort.direction === 'desc') ? 'asc' : 'desc';
                currentSort.column = sortKey;
                renderWorkQueue(allClaimsData);
            }
        });
        document.getElementById('categoryFilter').addEventListener('change', () => renderWorkQueue(allClaimsData));
        
        populateConfigSelector();
        loadCategorizationConfig();
    });

    // --- MAIN FILE HANDLING AND PROCESSING ---
    function handleFile(event, isReprocessing = false) { /* Unchanged from previous full version */ }
    
    // UPDATED: analyzeAndProcessClaims now stores team and source info
    function analyzeAndProcessClaims(data) {
        const metrics = { /* ... */ }; // All metric initializations are the same
        const claims = data.map(rawClaim => {
            const processedClaim = { /* ... all previous fields like state, status, age, etc. */ };
            
            processedClaim.isActionable = ['PEND', 'ONHOLD', 'MANAGEMENTREVIEW'].includes(processedClaim.state) || processedClaim.status === 'DENY';

            if (processedClaim.isActionable) {
                const categoryInfo = getClaimCategory(rawClaim);
                processedClaim.category = categoryInfo.category;
                processedClaim.source = categoryInfo.source;
                processedClaim.teamId = categoryInfo.teamId;
                processedClaim.teamName = categoryInfo.teamName;
                processedClaim.priorityScore = getPriorityScore(processedClaim);
            } else {
                // Set defaults for non-actionable claims
                processedClaim.category = 'N/A';
                processedClaim.source = 'N/A';
                processedClaim.teamName = 'N/A';
                processedClaim.priorityScore = -1;
            }
            return processedClaim;
        });
        // ... all metric calculations at the end remain the same
        return { claims, metrics };
    }

    function getPriorityScore(claim) { /* Unchanged */ }

    // --- UI RENDERING FUNCTIONS ---
    function renderDashboard(claims, metrics) {
        // ... a lot of code here, no changes needed from previous full version ...
        // It calls renderAgingTables, which is also unchanged.
        
        // NEW: Populate team download buttons
        populateTeamDownloadButtons(claims);
    }
    
    function renderAgingTables(data) { /* Unchanged */ }
    function createAgingTableHTML(data) { /* Unchanged */ }
    function populateCategoryFilter(claims) { /* Unchanged */ }

    // UPDATED: renderWorkQueue now includes the new "Source" column
    function renderWorkQueue(claims) {
        const selectedCategory = document.getElementById('categoryFilter').value;
        let actionable = claims.filter(c => c.isActionable);
        if (selectedCategory !== 'all') {
            actionable = actionable.filter(c => c.category === selectedCategory);
        }
        actionable.sort((a, b) => {
            // Sorting logic is unchanged
            const valA = a[currentSort.column], valB = b[currentSort.column];
            let comp = (valA > valB) ? 1 : (valA < valB) ? -1 : 0;
            return currentSort.direction === 'asc' ? comp : -comp;
        });

        // Added the new `<td>` for claim.source
        document.getElementById('work-queue-body').innerHTML = actionable.map(claim => 
            `<tr>
                <td>${claim.priorityScore}</td>
                <td>${claim.category || 'N/A'}</td>
                <td>${claim.source || 'N/A'}</td>
                <td>${claim.teamName || 'N/A'}</td>
                <td>${claim.claimId || 'N/A'}</td>
                <td>${claim.age || 0}</td>
                <td>$${(claim.netPayment || 0).toFixed(2)}</td>
                <td>${claim.providerName || 'N/A'}</td>
            </tr>`
        ).join('');
    }

    // --- NEW DOWNLOAD LOGIC ---
    function populateTeamDownloadButtons(claims) {
        const container = document.getElementById('teamReportButtons');
        const actionableClaims = claims.filter(c => c.isActionable && c.teamName);
        
        const teams = [...new Set(actionableClaims.map(c => c.teamName))];
        
        container.innerHTML = ''; // Clear previous buttons
        if(teams.length === 0) {
            container.innerHTML = '<p class="text-muted">No actionable claims found for any team.</p>';
            return;
        }

        teams.sort().forEach(teamName => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-success';
            btn.innerHTML = `<i class="bi bi-download"></i> Download ${teamName} Report`;
            btn.onclick = () => downloadTeamReport(teamName, actionableClaims);
            container.appendChild(btn);
        });
    }

    function downloadTeamReport(teamName, allActionableClaims) {
        const teamClaims = allActionableClaims.filter(c => c.teamName === teamName);
        if (teamClaims.length === 0) {
            alert(`No claims found for team: ${teamName}`);
            return;
        }
        
        // Group claims by their category
        const claimsByCategory = teamClaims.reduce((acc, claim) => {
            const category = claim.category;
            if (!acc[category]) acc[category] = [];
            // We want the original raw data plus our new processed fields for the report
            acc[category].push({
                ...claim.original,
                'Priority Score': claim.priorityScore,
                'Assigned Team': claim.teamName,
                'Category': claim.category,
                'Categorization Source': claim.source
            });
            return acc;
        }, {});

        const wb = XLSX.utils.book_new();
        const today = new Date().toISOString().slice(0, 10);

        // Create a new sheet for each category
        for (const categoryName in claimsByCategory) {
            const claimsInCat = claimsByCategory[categoryName];
            const ws = XLSX.utils.json_to_sheet(claimsInCat);
            
            // Sanitize sheet name (max 31 chars, no invalid chars)
            const safeSheetName = categoryName.replace(/[\/\\?*\[\]]/g, '').substring(0, 31);
            XLSX.utils.book_append_sheet(wb, ws, safeSheetName);
        }

        // Trigger the download
        const clientName = document.getElementById('clientName').value.trim().replace(/ /g, '_') || 'Client';
        const safeTeamName = teamName.replace(/ /g, '_');
        const fileName = `${clientName}_${safeTeamName}_Report_${today}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
    
    // PDF Generation (Unchanged)
    async function generateStructuredPDF() { /* Unchanged from previous full version */ }
    </script>
</body>
</html>
