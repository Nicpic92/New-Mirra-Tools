<!-- The HTML structure for index.html does not need any changes. -->
<!-- Paste the entire HTML from your previous version. -->
<!-- The only changes are in the JavaScript block below. -->

<script>
    // --- Global Variables ---
    let allClaimsData = [];
    let aggregatedMetrics = {};
    let myCharts = {};
    let currentSort = { column: 'priorityScore', direction: 'desc' };
    let currentColumnMappings = {}; 
    let allConfigs = [];
    // UPDATED: Simplied categorization config
    let categorizationConfig = { editRulesMap: new Map() };

    // --- SMART getVal FUNCTION (Unchanged) ---
    const getVal = (claim, standardKey) => {
        const mappedKey = currentColumnMappings[standardKey];
        return (mappedKey && claim[mappedKey] !== undefined) ? claim[mappedKey] : undefined;
    };

    // --- NEW/UPDATED FUNCTIONS ---

    // UPDATED: Fetches simplified categorization rules
    async function loadCategorizationConfig() {
        try {
            const response = await fetch('/.netlify/functions/get-categorization-config');
            if (!response.ok) throw new Error('Failed to fetch categorization config');
            const config = await response.json();
            
            // Convert array to a Map for efficient lookups
            categorizationConfig.editRulesMap = new Map(config.editRules.map(r => [r.edit_text, r.category_name]));
        } catch (error) {
            console.error("Could not load categorization rules:", error);
        }
    }

    // UPDATED: Simplified categorization logic
    function getClaimCategory(claim) {
        const notes = (getVal(claim, 'notes') || '').toLowerCase();
        const edit = getVal(claim, 'edit'); // Use original case for exact matching

        // 1. Check for a DB rule match in Claim Edits (highest priority)
        if (edit && categorizationConfig.editRulesMap.has(edit)) {
            return categorizationConfig.editRulesMap.get(edit);
        }

        // 2. Fallback to original hardcoded logic for critical items not in rules
        if (notes.includes('w9')) return 'Action Required: Missing W9';
        const totalCharges = parseFloat(getVal(claim, 'totalCharges') || 0);
        if (totalCharges > 50000) return 'On Hold: High Dollar Review';
        if (notes.includes('duplicate') || (edit || '').toLowerCase().includes('duplicate')) return 'On Hold: Duplicate';

        // 3. Default category if no other rule applies
        return 'Needs Triage';
    }

    // --- CONFIGURATION & EVENT LISTENERS (Unchanged from previous version) ---
    async function populateConfigSelector() { /* ... no changes ... */ }
    document.getElementById('configSelector').addEventListener('change', (e) => { /* ... no changes ... */ });
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportFile').addEventListener('change', (e) => handleFile(e, false));
        // All other event listeners for PDF generation, sorting, etc. remain here...

        populateConfigSelector();
        loadCategorizationConfig();
    });

    // All other functions (handleFile, analyzeAndProcessClaims, renderDashboard, etc.)
    // remain EXACTLY the same as the previous version. The only function that
    // needed modification was getClaimCategory, which is updated above.
</script>
