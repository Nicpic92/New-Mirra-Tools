<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .mapping-table th { width: 30%; }
        .list-group-item h6 { margin-bottom: 0; }
        .table-responsive-sm { max-height: 400px; overflow-y: auto; }
        .rule-text { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-delete-rule { line-height: 1; }
        .config-name { cursor: pointer; text-decoration: none; }
        .config-name:hover { text-decoration: underline; }
        .pdf-widget { cursor: grab; }
        .l1-indicator { font-size: 0.75rem; font-weight: bold; color: #6f42c1; margin-left: 8px; }
        .triage-step { border-left: 3px solid #dee2e6; padding-left: 15px; }
        .triage-step.active { border-left-color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Admin Console</h1>
            <div>
                 <a href="/reports.html" class="btn btn-info">Go to Report Builder</a>
                 <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
            </div>
        </div>
        
        <!-- Client Configuration Management Card -->
        <div class="row g-5">
            <div class="col-12">
                <div class="card">
                     <div class="card-body">
                        <h2>Client Configurations</h2>
                        <p class="text-muted">Manage settings for individual clients, their column mappings, and a **default** PDF report layout.</p>
                         <div class="row">
                            <div class="col-md-7">
                                <form id="configForm">
                                    <input type="hidden" id="configId">
                                    <h5>Step 1: Basic Information</h5>
                                    <div class="mb-3"><label for="configName" class="form-label">Configuration Name</label><input type="text" class="form-control" id="configName" required></div>
                                    <div class="mb-3"><label for="clientName" class="form-label">Client Name (for PDF Reports)</label><input type="text" class="form-control" id="clientName"></div>
                                    <hr>
                                    <h5>Step 2: Upload to Map Columns</h5>
                                    <div class="d-flex align-items-end">
                                        <div class="flex-grow-1">
                                            <label for="reportUploader" class="form-label">Upload XLSX File</label>
                                            <input class="form-control" type="file" id="reportUploader" accept=".xlsx">
                                        </div>
                                        <div class="ms-3 text-center">
                                            <span class="text-muted d-block mb-1 small">OR</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#copyMappingModal">
                                                <i class="bi bi-clipboard-plus"></i> Copy from...
                                            </button>
                                        </div>
                                    </div>
                                    <div id="mappingSection" class="mt-4" style="display: none;">
                                        <h6 id="mappingHeader">Map Your Fields to Detected Headers:</h6>
                                        <div id="mapping-alert" class="alert alert-info d-none"></div>
                                        <table class="table table-bordered table-sm mapping-table">
                                            <thead class="table-light"><tr><th>Standard Field</th><th>Client's Column Header</th></tr></thead>
                                            <tbody id="mappingTableBody"></tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <h5>Step 3: Default PDF Report Builder</h5>
                                    <p class="small text-muted">This layout will be used if a more specific universal Team/Category layout is not found.</p>
                                    <div class="mb-3">
                                        <label for="pdfReportTitle" class="form-label">PDF Report Title Template</label>
                                        <input type="text" class="form-control" id="pdfReportTitle" placeholder="{clientName} Daily Summary Report {date}">
                                        <div class="form-text">Use placeholders like {clientName} and {date}.</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6>Available Widgets</h6>
                                                <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#customWidgetModal">
                                                    <i class="bi bi-plus-circle"></i> Create Custom
                                                </button>
                                            </div>
                                            <ul class="list-group" id="availableWidgets"></ul>
                                        </div>
                                        <div class="col-6">
                                            <h6>Report Layout</h6>
                                            <ul class="list-group" id="reportLayout">
                                                <li class="list-group-item text-muted">Add widgets from the left.</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <hr>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                    <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                                </form>
                            </div>
                            <div class="col-md-5">
                                <h5>Existing Configurations</h5>
                                <p class="small text-muted">Click a name to edit.</p>
                                <ul class="list-group" id="configList"></ul>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Categorization Rules Section -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Client-Specific Categorization & Team Management</h2>
                        <p class="text-muted">Manage teams and categories globally, then create rules for each client to automatically assign claims.</p>
                        
                        <ul class="nav nav-tabs" id="ruleTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover-pane" type="button" role="tab">Discover, Assign & Triage</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-pane" type="button" role="tab">Manage Existing Rules</button>
                            </li>
                        </ul>

                        <div class="tab-content pt-3">
                            <!-- DISCOVER NEW RULES PANE -->
                            <div class="tab-pane fade show active" id="discover-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h5>1. Manage Teams & Categories</h5>
                                        <h6>Teams</h6>
                                        <ul class="list-group mb-3" id="teamList"></ul>
                                        <form id="newTeamForm" class="d-flex mb-4"><input type="text" id="newTeamName" class="form-control me-2" placeholder="New Team Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></form>
                                        
                                        <h6>Categories</h6>
                                        <div class="mb-3"><select class="form-select" id="teamCategorySelect"><option>Select team...</option></select></div>
                                        <form id="newCategoryForm">
                                            <div class="d-flex"><input type="text" id="newCategoryName" class="form-control me-2" placeholder="New Category Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="l1MonitorCheckbox">
                                                <label class="form-check-label" for="l1MonitorCheckbox">
                                                    Also include in L1 Monitor Report
                                                </label>
                                            </div>
                                        </form>
                                        <div id="categoryListContainer" class="mt-3"></div>
                                        
                                        <hr class="my-4">
                                        <h5>2. Manage Client-Team Associations</h5>
                                        <div class="mb-3">
                                            <label for="clientTeamConfigSelector" class="form-label">Select Client</label>
                                            <select class="form-select" id="clientTeamConfigSelector"><option>Select a client...</option></select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Select Associated Teams</label>
                                            <div id="clientTeamChecklist" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                                <small class="text-muted">Select a client to see teams.</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-success" id="saveClientTeamAssocsBtn">Save Associations</button>
                                    </div>
                                    <div class="col-md-8">
                                        <h5>3. Discover & Assign Rules</h5>
                                        <p class="text-muted small"><strong>Important:</strong> This is the primary method for discovering new categorization rules for a client.</p>
                                        <div class="row bg-light p-3 rounded mb-3">
                                            <div class="col-md-6"><label class="form-label fw-bold">Select Client</label><select class="form-select" id="categorizationConfigSelector"><option>Load configs...</option></select></div>
                                            <div class="col-md-6"><label class="form-label fw-bold">Upload Report</label><input class="form-control" type="file" id="categorizationReportUploader" accept=".xlsx" disabled></div>
                                        </div>
                                        <div id="rulesAssignmentContainer" style="display: none;">
                                            <button class="btn btn-success mb-3 save-rules-btn">Save All Rule Assignments</button>
                                            <div class="table-responsive-sm">
                                                <h6>Uncategorized Claim Edits</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Edit Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedEditsTable"></tbody></table>
                                            </div>
                                            <div class="table-responsive-sm mt-4">
                                                <h6 class="mt-4">Uncategorized Claim Notes</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Full Note Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedNotesTable"></tbody></table>
                                            </div>
                                            <button class="btn btn-success mt-3 save-rules-btn">Save All Rule Assignments</button>
                                        </div>
                                        <div id="noRulesFound" class="alert alert-info">Upload a file to begin.</div>
                                        
                                        <hr class="my-4">

                                        <h5>4. W9 Triage (from uploaded report)</h5>
                                        <p class="text-muted small">After assigning new rules, you can optionally upload the MRW9 report here to identify and re-assign W9-related claims from the main report you just uploaded.</p>
                                        <div id="w9TriageSection" style="display: none;">
                                            <div class="mb-3">
                                                <label for="triageMrw9Uploader" class="form-label fw-bold">Upload MRW9 Report</label>
                                                <input class="form-control" type="file" id="triageMrw9Uploader" accept=".xlsx,.csv">
                                            </div>
                                            <div id="triageResultsContainer" class="d-none">
                                                <p id="triageSummary"></p>
                                                <div class="table-responsive-sm border mb-3">
                                                    <table class="table table-sm table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Claim ID</th>
                                                                <th>Provider Name</th>
                                                                <th>Provider TIN</th>
                                                                <th>TIN Has W9?</th>
                                                                <th>Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="triageTableBody"></tbody>
                                                    </table>
                                                </div>
                                                <button class="btn btn-primary" id="generateAssignmentReportsBtn">Generate Assignment Reports</button>
                                            </div>
                                            <div id="triagePlaceholder" class="alert alert-secondary">
                                                Upload an MRW9 report to begin the triage process.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MANAGE EXISTING RULES PANE -->
                            <div class="tab-pane fade" id="manage-pane" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h5>Manage Existing Rules</h5>
                                        <p class="mb-0">Re-assign a rule to a different category or delete it permanently.</p>
                                    </div>
                                    <div class="d-flex align-items-end">
                                        <div class="me-3">
                                            <label for="clientRuleFilter" class="form-label">Filter by Client</label>
                                            <select class="form-select form-select-sm" id="clientRuleFilter">
                                                <option value="">Select a Client...</option>
                                            </select>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" id="downloadRulesBtn" disabled>
                                                <i class="bi bi-download"></i> Download Rules
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" id="copyRulesBtn" disabled data-bs-toggle="modal" data-bs-target="#copyRulesModal">
                                                <i class="bi bi-clipboard-plus"></i> Copy From...
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <button id="saveExistingChangesBtn" class="btn btn-success mb-3">Save All Changes to Existing Rules</button>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Claim Edit Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Edit Text</th><th>Assigned Category (Team)</th><th></th></tr></thead>
                                                <tbody id="existingEditsTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Claim Note Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Full Note Text</th><th>Assigned Category (Team)</th><th></th></tr></thead>
                                                <tbody id="existingNotesTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Modal for Copying Mappings -->
    <div class="modal fade" id="copyMappingModal" tabindex="-1" aria-labelledby="copyMappingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="copyMappingModalLabel">Copy Mappings From Existing Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select a configuration to copy its column mappings into the current form. This will replace any existing mappings in the form.</p>
                    <div class="mb-3">
                        <label for="copySourceConfig" class="form-label">Source Configuration</label>
                        <select id="copySourceConfig" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmCopyBtn">Copy Mappings</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Copying Client Rules -->
    <div class="modal fade" id="copyRulesModal" tabindex="-1" aria-labelledby="copyRulesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="copyRulesModalLabel">Copy Rules From Another Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">This will copy rules from the source client that do not already exist in the current client. It will not overwrite or delete existing rules.</p>
                    <div class="mb-3">
                        <label for="copyRulesSourceConfig" class="form-label fw-bold">1. Select Source Client</label>
                        <select id="copyRulesSourceConfig" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Select Rule Types to Copy</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="copyEditsCheckbox" checked>
                            <label class="form-check-label" for="copyEditsCheckbox">Claim Edit Rules</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="copyNotesCheckbox" checked>
                            <label class="form-check-label" for="copyNotesCheckbox">Claim Note Rules</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmCopyRulesBtn">Confirm Copy</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Custom Widget Creation Modal -->
    <div class="modal fade" id="customWidgetModal" tabindex="-1" aria-labelledby="customWidgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customWidgetModalLabel">Create Custom Report Widget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customWidgetForm">
                        <div class="mb-3">
                            <label for="widgetName" class="form-label">Widget Name</label>
                            <input type="text" class="form-control" id="widgetName" placeholder="e.g., Claims Count by Payer" required>
                        </div>
                        <div class="mb-3">
                            <label for="groupByColumn" class="form-label">Group Data By (Dimension)</label>
                            <select class="form-select" id="groupByColumn" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="metricType" class="form-label">Calculate (Metric)</label>
                            <select class="form-select" id="metricType">
                                <option value="count">Count of Claims</option>
                                <option value="sum">Sum of a Column</option>
                            </select>
                        </div>
                        <div class="mb-3" id="metricColumnContainer" style="display: none;">
                            <label for="metricColumn" class="form-label">Column to Sum</label>
                            <select class="form-select" id="metricColumn"></select>
                        </div>
                        <hr>
                        <h6>PDF Table Headers</h6>
                        <div class="mb-3">
                            <label for="tableHeader1" class="form-label">Header for Grouping Column</label>
                            <input type="text" class="form-control" id="tableHeader1" placeholder="e.g., Payer Name" required>
                        </div>
                        <div class="mb-3">
                            <label for="tableHeader2" class="form-label">Header for Metric Column</label>
                            <input type="text" class="form-control" id="tableHeader2" placeholder="e.g., Number of Claims" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveWidgetBtn">Save Widget</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- All JavaScript logic is now in an external file, loaded as a module. -->
<script src="admin.js" type="module"></script>
</body>
</html>
