<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .mapping-table th { width: 30%; }
        .list-group-item h6 { margin-bottom: 0; }
        .table-responsive-sm { max-height: 400px; overflow-y: auto; }
        .rule-text { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-delete-rule { line-height: 1; }
        .config-name { cursor: pointer; text-decoration: none; }
        .config-name:hover { text-decoration: underline; }
        .pdf-widget { cursor: grab; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Admin Console</h1>
            <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
        </div>
        
        <!-- Client Configuration Management Card -->
        <div class="row g-5">
            <div class="col-12">
                <div class="card">
                     <div class="card-body">
                        <h2>Client Configurations</h2>
                        <p class="text-muted">Manage settings for individual clients, their column mappings, and PDF report layouts.</p>
                         <div class="row">
                            <div class="col-md-7">
                                <form id="configForm">
                                    <input type="hidden" id="configId">
                                    <h5>Step 1: Basic Information</h5>
                                    <div class="mb-3"><label for="configName" class="form-label">Configuration Name</label><input type="text" class="form-control" id="configName" required></div>
                                    <div class="mb-3"><label for="clientName" class="form-label">Client Name (for PDF Reports)</label><input type="text" class="form-control" id="clientName"></div>
                                    <hr>
                                    <h5>Step 2: Upload to Map Columns</h5>
                                     <div class="mb-3"><label for="reportUploader" class="form-label">Upload XLSX File</label><input class="form-control" type="file" id="reportUploader" accept=".xlsx"></div>
                                    <div id="mappingSection" class="mt-4" style="display: none;">
                                        <h6 id="mappingHeader">Map Your Fields to Detected Headers:</h6>
                                        <div id="mapping-alert" class="alert alert-info d-none"></div>
                                        <table class="table table-bordered table-sm mapping-table">
                                            <thead class="table-light"><tr><th>Standard Field</th><th>Client's Column Header</th></tr></thead>
                                            <tbody id="mappingTableBody"></tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <h5>Step 3: PDF Report Builder</h5>
                                    <div class="mb-3">
                                        <label for="pdfReportTitle" class="form-label">PDF Report Title Template</label>
                                        <input type="text" class="form-control" id="pdfReportTitle" placeholder="{clientName} Daily Summary Report {date}">
                                        <div class="form-text">Use placeholders like {clientName} and {date}.</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6>Available Widgets</h6>
                                                <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#customWidgetModal">
                                                    <i class="bi bi-plus-circle"></i> Create Custom
                                                </button>
                                            </div>
                                            <ul class="list-group" id="availableWidgets"></ul>
                                        </div>
                                        <div class="col-6">
                                            <h6>Report Layout</h6>
                                            <ul class="list-group" id="reportLayout">
                                                <li class="list-group-item text-muted">Add widgets from the left.</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <hr>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                    <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                                </form>
                            </div>
                            <div class="col-md-5">
                                <h5>Existing Configurations</h5>
                                <p class="small text-muted">Click a name to edit.</p>
                                <ul class="list-group" id="configList"></ul>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Categorization Rules Section -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Global Categorization & Team Management</h2>
                        <p class="text-muted">Manage teams, define categories for each team, and create rules to automatically assign claims.</p>
                        
                        <ul class="nav nav-tabs" id="ruleTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover-pane" type="button" role="tab">Discover & Assign New Rules</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-pane" type="button" role="tab">Manage Existing Rules</button>
                            </li>
                        </ul>

                        <div class="tab-content pt-3">
                            <!-- DISCOVER NEW RULES PANE -->
                            <div class="tab-pane fade show active" id="discover-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h5>1. Manage Teams & Categories</h5>
                                        <h6>Teams</h6>
                                        <ul class="list-group mb-3" id="teamList"></ul>
                                        <form id="newTeamForm" class="d-flex mb-4"><input type="text" id="newTeamName" class="form-control me-2" placeholder="New Team Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></form>
                                        
                                        <h6>Categories</h6>
                                        <div class="mb-3"><select class="form-select" id="teamCategorySelect"><option>Select team...</option></select></div>
                                        <form id="newCategoryForm" class="d-flex"><input type="text" id="newCategoryName" class="form-control me-2" placeholder="New Category Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></form>
                                        <div id="categoryListContainer" class="mt-3"></div>
                                    </div>
                                    <div class="col-md-8">
                                        <h5>2. Discover & Assign Rules</h5>
                                        <div class="row bg-light p-3 rounded mb-3">
                                            <div class="col-md-6"><label class="form-label fw-bold">Select Config</label><select class="form-select" id="categorizationConfigSelector"><option>Load configs...</option></select></div>
                                            <div class="col-md-6"><label class="form-label fw-bold">Upload Report</label><input class="form-control" type="file" id="categorizationReportUploader" accept=".xlsx" disabled></div>
                                        </div>
                                        <div id="rulesAssignmentContainer" style="display: none;">
                                            <button class="btn btn-success mb-3 save-rules-btn">Save All Rule Assignments</button>
                                            <div class="table-responsive-sm">
                                                <h6>Uncategorized Claim Edits</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Edit Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedEditsTable"></tbody></table>
                                            </div>
                                            <div class="table-responsive-sm mt-4">
                                                <h6 class="mt-4">Uncategorized Claim Notes</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Full Note Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedNotesTable"></tbody></table>
                                            </div>
                                            <button class="btn btn-success mt-3 save-rules-btn">Save All Rule Assignments</button>
                                        </div>
                                        <div id="noRulesFound" class="alert alert-info">Upload a file to begin.</div>
                                    </div>
                                </div>
                            </div>

                            <!-- MANAGE EXISTING RULES PANE -->
                            <div class="tab-pane fade" id="manage-pane" role="tabpanel">
                                <h5>Manage Existing Rules</h5>
                                <p>Re-assign a rule to a different category or delete it permanently.</p>
                                <button id="saveExistingChangesBtn" class="btn btn-success mb-3">Save All Changes to Existing Rules</button>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Claim Edit Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Edit Text</th><th>Assigned Category</th><th></th></tr></thead>
                                                <tbody id="existingEditsTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Claim Note Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Full Note Text</th><th>Assigned Category</th><th></th></tr></thead>
                                                <tbody id="existingNotesTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Widget Creation Modal -->
    <div class="modal fade" id="customWidgetModal" tabindex="-1" aria-labelledby="customWidgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customWidgetModalLabel">Create Custom Report Widget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customWidgetForm">
                        <div class="mb-3">
                            <label for="widgetName" class="form-label">Widget Name</label>
                            <input type="text" class="form-control" id="widgetName" placeholder="e.g., Claims Count by Payer" required>
                        </div>
                        <div class="mb-3">
                            <label for="groupByColumn" class="form-label">Group Data By (Dimension)</label>
                            <select class="form-select" id="groupByColumn" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="metricType" class="form-label">Calculate (Metric)</label>
                            <select class="form-select" id="metricType">
                                <option value="count">Count of Claims</option>
                                <option value="sum">Sum of a Column</option>
                            </select>
                        </div>
                        <div class="mb-3" id="metricColumnContainer" style="display: none;">
                            <label for="metricColumn" class="form-label">Column to Sum</label>
                            <select class="form-select" id="metricColumn"></select>
                        </div>
                        <hr>
                        <h6>PDF Table Headers</h6>
                        <div class="mb-3">
                            <label for="tableHeader1" class="form-label">Header for Grouping Column</label>
                            <input type="text" class="form-control" id="tableHeader1" placeholder="e.g., Payer Name" required>
                        </div>
                        <div class="mb-3">
                            <label for="tableHeader2" class="form-label">Header for Metric Column</label>
                            <input type="text" class="form-control" id="tableHeader2" placeholder="e.g., Number of Claims" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveWidgetBtn">Save Widget</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // API Endpoints
    const CONFIG_API = '/.netlify/functions/configurations', TEAMS_API = '/.netlify/functions/teams', CATEGORIES_API = '/.netlify/functions/categories', RULES_API = '/.netlify/functions/rules';

    // DOM Elements
    const configForm = document.getElementById('configForm'), configIdInput = document.getElementById('configId'), configNameInput = document.getElementById('configName'), clientNameInput = document.getElementById('clientName'), clearBtn = document.getElementById('clearBtn'), reportUploader = document.getElementById('reportUploader'), mappingSection = document.getElementById('mappingSection'), mappingTableBody = document.getElementById('mappingTableBody'), mappingHeader = document.getElementById('mappingHeader'), mappingAlert = document.getElementById('mapping-alert'), configList = document.getElementById('configList');
    const teamList = document.getElementById('teamList'), newTeamForm = document.getElementById('newTeamForm'), newTeamNameInput = document.getElementById('newTeamName'), teamCategorySelect = document.getElementById('teamCategorySelect'), categoryListContainer = document.getElementById('categoryListContainer'), newCategoryForm = document.getElementById('newCategoryForm'), newCategoryNameInput = document.getElementById('newCategoryName');
    const categorizationConfigSelector = document.getElementById('categorizationConfigSelector'), categorizationReportUploader = document.getElementById('categorizationReportUploader'), rulesAssignmentContainer = document.getElementById('rulesAssignmentContainer'), uncategorizedEditsTable = document.getElementById('uncategorizedEditsTable'), uncategorizedNotesTable = document.getElementById('uncategorizedNotesTable'), noRulesFoundDiv = document.getElementById('noRulesFound');
    const existingEditsTableBody = document.getElementById('existingEditsTableBody'), existingNotesTableBody = document.getElementById('existingNotesTableBody'), saveExistingChangesBtn = document.getElementById('saveExistingChangesBtn');
    const pdfReportTitleInput = document.getElementById('pdfReportTitle'), availableWidgetsList = document.getElementById('availableWidgets'), reportLayoutList = document.getElementById('reportLayout');
    const customWidgetForm = document.getElementById('customWidgetForm'), customWidgetModalEl = document.getElementById('customWidgetModal'), customWidgetModal = new bootstrap.Modal(customWidgetModalEl), saveWidgetBtn = document.getElementById('saveWidgetBtn'), metricTypeSelect = document.getElementById('metricType'), metricColumnContainer = document.getElementById('metricColumnContainer');

    // Global State
    let allTeams = [], allCategories = [], detectedHeaders = [], columnMappingsForCategorization = {}, mappingsForEditing = {}, currentCustomWidgets = [];
    let existingEditRules = new Map(), existingNoteRules = new Map();
    const standardFields = [
        { key: 'claimId', displayName: 'Claim ID / Number', required: true, type: 'string' }, { key: 'age', displayName: 'Age (in days)', required: true, type: 'number' }, { key: 'netPayment', displayName: 'Net Payment Amount', required: true, type: 'number' }, { key: 'state', displayName: 'Claim State', required: true, type: 'string' }, { key: 'status', displayName: 'Claim Status', required: true, type: 'string' }, { key: 'networkStatus', displayName: 'Network Status', required: true, type: 'string' }, { key: 'providerName', displayName: 'Billing Provider Name', required: true, type: 'string' }, { key: 'edit', displayName: 'Claim Edits', required: true, type: 'string' }, { key: 'notes', displayName: 'Claim Notes', required: true, type: 'string' }, { key: 'totalCharges', displayName: 'Total Billed Amount', required: false, type: 'number' }, { key: 'dsnp', displayName: 'DSNP Status', required: false, type: 'string' }, { key: 'payer', displayName: 'Payer Name', required: false, type: 'string' }, { key: 'claimCategory', displayName: 'Category', required: false, type: 'string' }, { key: 'claimType', displayName: 'Claim Type', required: false, type: 'string' }, { key: 'receivedDate', displayName: 'Received Date', required: false, type: 'date' }, { key: 'billingProviderTaxId', displayName: 'Billing Provider Tax ID', required: false, type: 'string' }, { key: 'billingProviderNpi', displayName: 'Billing Provider NPI', required: false, type: 'string' }, { key: 'patientName', displayName: 'Patient Name', required: false, type: 'string' }, { key: 'subscriberId', displayName: 'Subscriber ID', required: false, type: 'string' }, { key: 'renderingProviderName', displayName: 'Rendering Provider Name', required: false, type: 'string' }, { key: 'renderingProviderNpi', displayName: 'Rendering Provider NPI', required: false, type: 'string' }, { key: 'dosFrom', displayName: 'Date of Service (From)', required: false, type: 'date' }, { key: 'dosTo', displayName: 'Date of Service (To)', required: false, type: 'date' }, { key: 'cleanAge', displayName: 'Clean Age', required: false, type: 'number' }, { key: 'pbpName', displayName: 'PBP Name', required: false, type: 'string' }, { key: 'planName', displayName: 'Plan Name', required: false, type: 'string' }, { key: 'activityLog', displayName: 'Activity Log Description', required: false, type: 'string' }, { key: 'activityUser', displayName: 'Activity Performed By', required: false, type: 'string' }, { key: 'activityDate', displayName: 'Activity Performed On', required: false, type: 'date' }
    ];
    
    // --- NEW: Expanded list of available standard widgets ---
    const availablePdfWidgets = [
        { id: 'summary', name: 'Executive Summary Cards', type: 'summary' },
        { id: 'claimsByFinalStatus', name: 'Claims by Final Status', type: 'table', dataSource: 'claimsByFinalStatus', columns: [{ header: 'Status', dataKey: 'label' }, { header: 'Count', dataKey: 'data' }] },
        { id: 'claimsByWorkflowState', name: 'Claims by Workflow State', type: 'table', dataSource: 'claimsByWorkflowState', columns: [{ header: 'State', dataKey: 'label' }, { header: 'Count', dataKey: 'data' }] },
        { id: 'topEdits', name: 'Top 10 Claim Edits', type: 'table', dataSource: 'topEdits', columns: [{ header: 'Edit Rule', dataKey: 'label' }, { header: 'Count', dataKey: 'data' }] },
        { id: 'topProvidersOverall', name: 'Top 10 Providers (Overall)', type: 'table', dataSource: 'topProvidersOverall', columns: [{ header: 'Provider Name', dataKey: 'label' }, { header: 'Count', dataKey: 'data' }] },
        { id: 'agingCombined', name: 'Aging Analysis (Combined)', type: 'aging_table' },
        { id: 'agingActive', name: 'Aging Analysis (Active)', type: 'aging_table' },
        { id: 'agingPrebatch', name: 'Aging Analysis (Prebatch)', type: 'aging_table' }
    ];
    
    // --- CORE DATA LOADING ---
    async function loadConfigurations() {
        try {
            const response = await fetch(CONFIG_API);
            const configs = await response.json();
            window.allClientConfigs = configs;
            configList.innerHTML = configs.length ? '' : '<li class="list-group-item">No configurations found.</li>';
            categorizationConfigSelector.innerHTML = '<option selected disabled value="">Select a configuration...</option>';
            configs.forEach(config => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                const nameLink = document.createElement('a');
                nameLink.href = '#';
                nameLink.className = 'config-name flex-grow-1';
                nameLink.dataset.configId = config.id;
                nameLink.textContent = config.config_name;
                li.appendChild(nameLink);
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';
                btnGroup.role = 'group';
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-outline-secondary btn-sm';
                downloadBtn.textContent = 'Download';
                downloadBtn.onclick = () => downloadConfigAsXLSX(config);
                btnGroup.appendChild(downloadBtn);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteConfig(config.id);
                btnGroup.appendChild(deleteBtn);
                li.appendChild(btnGroup);
                configList.appendChild(li);
                categorizationConfigSelector.add(new Option(config.config_name, config.id));
            });
        } catch (error) { console.error('Error loading configurations:', error); }
    }
    
    async function loadTeams() {
        const response = await fetch(TEAMS_API);
        allTeams = await response.json();
    }
    
    async function loadCategories() {
        const response = await fetch(CATEGORIES_API);
        allCategories = await response.json();
    }

    async function loadRules() {
        const [editRes, noteRes] = await Promise.all([ fetch(`${RULES_API}?type=edit`), fetch(`${RULES_API}?type=note`) ]);
        const editRulesData = await editRes.json();
        const noteRulesData = await noteRes.json();
        existingEditRules = new Map(editRulesData.map(r => [r.text, { category_id: r.category_id, category_name: r.category_name, team_name: r.team_name }]));
        existingNoteRules = new Map(noteRulesData.map(r => [r.text, { category_id: r.category_id, category_name: r.category_name, team_name: r.team_name }]));
    }
    
    async function loadAllData() {
        try {
            await Promise.all([
                loadTeams(),
                loadCategories(),
                loadRules(),
                loadConfigurations()
            ]);
            renderTeamList();
            populateTeamDropdown();
            renderCategoryList();
            renderExistingRulesTables();
        } catch (error) {
            console.error("Failed to load initial admin data:", error);
            alert("Error loading administrative data. Please check the console and refresh the page.");
        }
    }

    // --- CLIENT CONFIGURATION LOGIC ---
    function editConfig(configId) {
        const config = (window.allClientConfigs || []).find(c => c.id === configId);
        if (!config) return;
        
        clearConfigForm();
        
        configIdInput.value = config.id;
        configNameInput.value = config.config_name;
        clientNameInput.value = config.config_data.clientName || '';
        mappingsForEditing = config.config_data.columnMappings || {};
        currentCustomWidgets = config.config_data.pdfConfig?.customWidgets || [];
        
        mappingSection.style.display = 'block';
        mappingTableBody.innerHTML = '';
        mappingAlert.textContent = 'Upload a file to view or change the column mappings for this configuration.';
        mappingAlert.classList.remove('d-none');
        mappingHeader.innerHTML = 'Map Your Fields to Detected Headers:';
        
        populateAvailableWidgets();
        renderPdfLayout(config.config_data.pdfConfig);
    }

    function renderMappingUI() {
        mappingHeader.innerHTML = `Map Your Fields to Detected Headers: <span class="badge bg-secondary">${detectedHeaders.length} columns found</span>`;
        mappingAlert.classList.add('d-none');
        mappingTableBody.innerHTML = '';
        
        standardFields.forEach(field => {
            const row = mappingTableBody.insertRow();
            row.insertCell().innerHTML = `${field.displayName}${field.required ? ' <span class="text-danger">*</span>' : ''}`;
            const cell2 = row.insertCell();
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm';
            select.dataset.standardKey = field.key;
            select.add(new Option(field.required ? 'Select header...' : 'Optional', ''));
            
            let bestGuess = '';
            const savedMapping = mappingsForEditing[field.key];
            if (savedMapping && detectedHeaders.includes(savedMapping)) {
                bestGuess = savedMapping;
            } else if (detectedHeaders.includes(field.displayName)) {
                bestGuess = field.displayName;
            } else if (detectedHeaders.includes(field.key)) {
                bestGuess = field.key;
            }
            
            detectedHeaders.forEach(header => {
                const option = new Option(header, header);
                if (header === bestGuess) option.selected = true;
                select.add(option);
            });
            cell2.appendChild(select);
        });
        mappingSection.style.display = 'block';
    }

    async function deleteConfig(id) {
        if (!confirm('Are you sure you want to delete this configuration? This cannot be undone.')) return;
        try {
            await fetch(`${CONFIG_API}?id=${id}`, { method: 'DELETE' });
            alert('Configuration deleted successfully.');
            loadConfigurations();
        } catch (error) { alert('Failed to delete configuration.'); }
    }

    function downloadConfigAsXLSX(config) {
        const wb = XLSX.utils.book_new();
        const summaryData = [ { Key: 'Configuration Name', Value: config.config_name }, { Key: 'Client Name (for PDF)', Value: config.config_data.clientName || 'Not Set' } ];
        const wsSummary = XLSX.utils.json_to_sheet(summaryData, { skipHeader: true });
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
        const mappingData = standardFields.map(field => ({ 'Standard Field': field.displayName, 'Required': field.required ? 'Yes' : 'No', 'Mapped Client Header': config.config_data.columnMappings[field.key] || '--- NOT MAPPED ---' }));
        const wsMappings = XLSX.utils.json_to_sheet(mappingData);
        XLSX.utils.book_append_sheet(wb, wsMappings, 'Column Mappings');
        wsSummary['!cols'] = [{ wch: 25 }, { wch: 50 }];
        wsMappings['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 50 }];
        const fileName = `Config_${config.config_name.replace(/ /g, '_')}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
    
    // --- TEAM & CATEGORY LOGIC ---
    function renderTeamList() {
        teamList.innerHTML = allTeams.length ? '' : '<li class="list-group-item">No teams defined.</li>';
        allTeams.forEach(team => {
            const li = document.createElement('li');
            li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
            li.textContent = team.team_name;
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1 btn-delete-rule';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = () => deleteTeam(team.id);
            li.appendChild(deleteBtn);
            teamList.appendChild(li);
        });
    }

    function populateTeamDropdown() {
        teamCategorySelect.innerHTML = '<option value="">Select a team to add to...</option>';
        allTeams.sort((a, b) => a.team_name.localeCompare(b.team_name)).forEach(team => teamCategorySelect.add(new Option(team.team_name, team.id)));
    }
    
    async function deleteTeam(id) {
        if (!confirm('Are you sure? This will unassign categories from this team.')) return;
        try {
            await fetch(`${TEAMS_API}?id=${id}`, { method: 'DELETE' });
            await loadAllData();
        } catch (error) { alert('Failed to delete team.'); }
    }
    
    function renderCategoryList() {
        categoryListContainer.innerHTML = '';
        const grouped = allCategories.reduce((acc, cat) => {
            const teamName = cat.team_name || 'Unassigned';
            if (!acc[teamName]) acc[teamName] = [];
            acc[teamName].push(cat);
            return acc;
        }, {});
        Object.keys(grouped).sort().forEach(teamName => {
            const card = document.createElement('div');
            card.className = 'card mb-2';
            card.innerHTML = `<div class="card-header py-1">${teamName}</div>`;
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            grouped[teamName].sort((a,b) => a.category_name.localeCompare(b.category_name)).forEach(cat => {
                const li = document.createElement('li');
                li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
                li.textContent = cat.category_name;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1 btn-delete-rule';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => deleteCategory(cat.id);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
            card.appendChild(list);
            categoryListContainer.appendChild(card);
        });
    }

    async function deleteCategory(id) {
        if (!confirm('Are you sure? This also deletes associated rules.')) return;
        try {
            await fetch(`${CATEGORIES_API}?id=${id}`, { method: 'DELETE' });
            await loadAllData();
        } catch (error) { alert('Failed to delete category.'); }
    }
    
    // --- PDF & WIDGET BUILDER LOGIC ---
    function initializeWidgetCreator() {
        const groupBySelect = document.getElementById('groupByColumn');
        const metricColSelect = document.getElementById('metricColumn');
        groupBySelect.innerHTML = '<option value="" disabled selected>Select a column...</option>';
        metricColSelect.innerHTML = '<option value="" disabled selected>Select a column...</option>';

        standardFields.filter(f => f.type === 'string' || f.type === 'date').forEach(field => {
            groupBySelect.add(new Option(field.displayName, field.key));
        });
        standardFields.filter(f => f.type === 'number').forEach(field => {
            metricColSelect.add(new Option(field.displayName, field.key));
        });
        
        metricTypeSelect.addEventListener('change', () => {
            metricColumnContainer.style.display = metricTypeSelect.value === 'sum' ? 'block' : 'none';
        });

        saveWidgetBtn.addEventListener('click', () => {
            if (!customWidgetForm.checkValidity()) {
                customWidgetForm.reportValidity();
                return;
            }
            const newWidget = {
                id: `custom_${Date.now()}`,
                name: document.getElementById('widgetName').value,
                type: 'custom_table',
                groupBy: document.getElementById('groupByColumn').value,
                metricType: document.getElementById('metricType').value,
                metricColumn: metricTypeSelect.value === 'sum' ? document.getElementById('metricColumn').value : null,
                columns: [
                    { header: document.getElementById('tableHeader1').value, dataKey: 'label' },
                    { header: document.getElementById('tableHeader2').value, dataKey: 'data' }
                ]
            };
            if(metricTypeSelect.value === 'sum' && !newWidget.metricColumn) {
                alert('Please select a column to sum.');
                return;
            }
            currentCustomWidgets.push(newWidget);
            populateAvailableWidgets();
            customWidgetModal.hide();
        });

        customWidgetModalEl.addEventListener('hidden.bs.modal', () => {
             customWidgetForm.reset();
             metricColumnContainer.style.display = 'none';
        });
    }

    function populateAvailableWidgets() {
        availableWidgetsList.innerHTML = '';
        const allWidgets = [...availablePdfWidgets, ...currentCustomWidgets];
        allWidgets.forEach(widget => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = widget.name;
            const btnGroup = document.createElement('div');
            if (widget.type === 'custom_table') {
                 const deleteBtn = document.createElement('button');
                 deleteBtn.type = 'button';
                 deleteBtn.className = 'btn btn-sm btn-outline-danger me-1';
                 deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                 deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    currentCustomWidgets = currentCustomWidgets.filter(w => w.id !== widget.id);
                    populateAvailableWidgets();
                 };
                 btnGroup.appendChild(deleteBtn);
            }
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'btn btn-sm btn-outline-primary';
            addBtn.innerHTML = '<i class="bi bi-plus"></i> Add';
            addBtn.onclick = () => addWidgetToLayout(widget);
            btnGroup.appendChild(addBtn);
            li.appendChild(btnGroup);
            availableWidgetsList.appendChild(li);
        });
    }
    
    function addWidgetToLayout(widget, customTitle = '') { if (reportLayoutList.querySelector('.text-muted')) { reportLayoutList.innerHTML = ''; } const li = document.createElement('li'); li.className = 'list-group-item pdf-widget'; li.dataset.widgetId = widget.id; li.innerHTML = `<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">${widget.name}</span><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">&times;</button></div><input type="text" class="form-control form-control-sm mt-2" value="${customTitle}" placeholder="Enter custom title (optional)">`; reportLayoutList.appendChild(li); }
    function renderPdfLayout(pdfConfig) { reportLayoutList.innerHTML = ''; pdfReportTitleInput.value = pdfConfig?.reportTitle || ''; if (pdfConfig?.sections?.length > 0) { pdfConfig.sections.forEach(section => { const allWidgets = [...availablePdfWidgets, ...currentCustomWidgets]; const baseWidget = allWidgets.find(w => w.id === section.id); if (baseWidget) { addWidgetToLayout(baseWidget, section.title); } }); } else { reportLayoutList.innerHTML = '<li class="list-group-item text-muted">Add widgets from the left.</li>'; } }
    function serializePdfLayout() {
        const sections = Array.from(reportLayoutList.querySelectorAll('.pdf-widget')).map(li => {
            const widgetId = li.dataset.widgetId;
            const allWidgets = [...availablePdfWidgets, ...currentCustomWidgets];
            const baseWidget = allWidgets.find(w => w.id === widgetId);
            const customTitle = li.querySelector('input').value.trim();
            const definition = baseWidget.type === 'custom_table' ? baseWidget : null;
            return { id: widgetId, type: baseWidget.type, title: customTitle || baseWidget.name, definition };
        });
        return {
            reportTitle: pdfReportTitleInput.value.trim() || '{clientName} Daily Summary Report {date}',
            customWidgets: currentCustomWidgets,
            sections
        };
    }

    // --- RULE MANAGEMENT LOGIC ---
    function processUploadedReport(data) { const detectedEdits = new Set(), detectedNotes = new Set(); const { edit: editColumn, notes: notesColumn } = columnMappingsForCategorization; data.forEach(row => { const editValue = (row[editColumn] || '').toString().trim(); if (editValue && !existingEditRules.has(editValue)) detectedEdits.add(editValue); const noteValue = (row[notesColumn] || '').toString().trim(); if (noteValue && !existingNoteRules.has(noteValue)) detectedNotes.add(noteValue); }); const sortedEdits = Array.from(detectedEdits).sort((a, b) => a.localeCompare(b)); const sortedNotes = Array.from(detectedNotes).sort((a, b) => a.localeCompare(b)); uncategorizedEditsTable.innerHTML = ''; sortedEdits.forEach(text => { const row = uncategorizedEditsTable.insertRow(); row.insertCell().innerHTML = `<div class="rule-text" title="${text}">${text}</div>`; row.cells[0].firstChild.dataset.text = text; row.insertCell().innerHTML = createCategoryDropdown().outerHTML; }); uncategorizedNotesTable.innerHTML = ''; sortedNotes.forEach(noteText => { const row = uncategorizedNotesTable.insertRow(); row.insertCell().innerHTML = `<div class="rule-text" title="${noteText}">${noteText}</div>`; row.cells[0].firstChild.dataset.text = noteText; row.insertCell().innerHTML = createCategoryDropdown().outerHTML; }); const hasRules = sortedEdits.length > 0 || sortedNotes.length > 0; rulesAssignmentContainer.style.display = hasRules ? 'block' : 'none'; noRulesFoundDiv.textContent = hasRules ? '' : 'No new, uncategorized items were found in the uploaded file.'; noRulesFoundDiv.style.display = hasRules ? 'none' : 'block'; }
    function createCategoryDropdown(selectedId = '') { const select = document.createElement('select'); select.className = 'form-select form-select-sm'; select.add(new Option('Select category...', '')); allCategories.sort((a,b) => (a.team_name || 'Z').localeCompare(b.team_name || 'Z') || a.category_name.localeCompare(b.category_name)).forEach(cat => select.add(new Option(`${cat.team_name || 'Unassigned'} -> ${cat.category_name}`, cat.id))); if (selectedId) { select.value = selectedId; } return select; }
    async function saveNewRules() { const getRulesFromTable = (table) => Array.from(table.rows).map(row => ({ row: row, text: row.querySelector('.rule-text').dataset.text, category_id: row.cells[1].querySelector('select').value })).filter(rule => rule.category_id); const editRulesToSave = getRulesFromTable(uncategorizedEditsTable); const noteRulesToSave = getRulesFromTable(uncategorizedNotesTable); if (editRulesToSave.length === 0 && noteRulesToSave.length === 0) return alert('No new rules were assigned to a category.'); try { const bodyEdit = JSON.stringify(editRulesToSave.map(({ row, ...rest }) => rest)); const bodyNote = JSON.stringify(noteRulesToSave.map(({ row, ...rest }) => rest)); await Promise.all([ editRulesToSave.length > 0 ? fetch(`${RULES_API}?type=edit`, { method: 'POST', body: bodyEdit }) : Promise.resolve(), noteRulesToSave.length > 0 ? fetch(`${RULES_API}?type=note`, { method: 'POST', body: bodyNote }) : Promise.resolve() ]); alert('Rules saved successfully!'); editRulesToSave.forEach(rule => rule.row.remove()); noteRulesToSave.forEach(rule => rule.row.remove()); await loadRules(); renderExistingRulesTables(); if (uncategorizedEditsTable.rows.length === 0 && uncategorizedNotesTable.rows.length === 0) { rulesAssignmentContainer.style.display = 'none'; noRulesFoundDiv.textContent = 'Upload a file to begin.'; noRulesFoundDiv.style.display = 'block'; } } catch (error) { alert(`Failed to save rules: ${error.message}`); } }
    function renderExistingRulesTables() { existingEditsTableBody.innerHTML = ''; Array.from(existingEditRules.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([text, rule]) => { const row = existingEditsTableBody.insertRow(); row.dataset.text = text; row.insertCell().innerHTML = `<div class="rule-text" title="${text}">${text}</div>`; row.insertCell().innerHTML = createCategoryDropdown(rule.category_id).outerHTML; row.insertCell().innerHTML = `<button class="btn btn-danger btn-sm py-0 px-1 btn-delete-rule" data-type="edit" data-text="${encodeURIComponent(text)}">&times;</button>`; }); existingNotesTableBody.innerHTML = ''; Array.from(existingNoteRules.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([text, rule]) => { const row = existingNotesTableBody.insertRow(); row.dataset.text = text; row.insertCell().innerHTML = `<div class="rule-text" title="${text}">${text}</div>`; row.insertCell().innerHTML = createCategoryDropdown(rule.category_id).outerHTML; row.insertCell().innerHTML = `<button class="btn btn-danger btn-sm py-0 px-1 btn-delete-rule" data-type="note" data-text="${encodeURIComponent(text)}">&times;</button>`; }); }
    async function deleteRule(type, text) { if (!confirm(`Are you sure you want to delete this rule?\n\nTYPE: ${type}\nRULE: ${text}`)) return; try { const response = await fetch(`${RULES_API}?type=${type}`, { method: 'DELETE', body: JSON.stringify({ text }) }); if (!response.ok) throw new Error('Delete failed on server.'); const tableBody = type === 'edit' ? existingEditsTableBody : existingNotesTableBody; tableBody.querySelector(`tr[data-text="${text}"]`)?.remove(); const stateMap = type === 'edit' ? existingEditRules : existingNoteRules; stateMap.delete(text); alert('Rule deleted.'); } catch(error) { alert(`Error deleting rule: ${error.message}`); } };
    async function saveExistingRuleChanges() { const getChangedRules = (tableBody) => Array.from(tableBody.rows).map(row => ({ text: row.dataset.text, category_id: row.querySelector('select').value })); const editRulesToUpdate = getChangedRules(existingEditsTableBody); const noteRulesToUpdate = getChangedRules(existingNotesTableBody); try { await Promise.all([ editRulesToUpdate.length > 0 ? fetch(`${RULES_API}?type=edit`, { method: 'POST', body: JSON.stringify(editRulesToUpdate) }) : Promise.resolve(), noteRulesToUpdate.length > 0 ? fetch(`${RULES_API}?type=note`, { method: 'POST', body: JSON.stringify(noteRulesToUpdate) }) : Promise.resolve() ]); alert('Existing rule changes saved successfully!'); await loadRules(); renderExistingRulesTables(); } catch(error) { alert(`Error saving changes: ${error.message}`); } }
    function clearConfigForm() { configForm.reset(); configIdInput.value = ''; mappingSection.style.display = 'none'; mappingAlert.classList.add('d-none'); mappingsForEditing = {}; reportUploader.value = ''; currentCustomWidgets = []; populateAvailableWidgets(); renderPdfLayout({}); }

    // --- EVENT LISTENERS ---
    configList.addEventListener('click', (e) => { if (e.target.classList.contains('config-name')) { e.preventDefault(); const configId = parseInt(e.target.dataset.configId, 10); editConfig(configId); } });
    configForm.addEventListener('submit', async (e) => { e.preventDefault(); const columnMappings = {}; mappingTableBody.querySelectorAll('select').forEach(sel => { if (sel.value) columnMappings[sel.dataset.standardKey] = sel.value; }); const id = configIdInput.value; const pdfConfig = serializePdfLayout(); const config_data = { clientName: clientNameInput.value, columnMappings, pdfConfig }; const method = id ? 'PUT' : 'POST'; const url = id ? `${CONFIG_API}?id=${id}` : CONFIG_API; try { const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config_name: configNameInput.value, config_data }) }); if(!res.ok) throw new Error(`Server responded with ${res.status}`); alert(`Configuration ${id ? 'updated' : 'created'} successfully!`); clearConfigForm(); await loadConfigurations(); } catch (error) { console.error('Failed to save config:', error); alert(`Failed to save configuration: ${error.message}`); } });
    reportUploader.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const sheet = workbook.Sheets[workbook.SheetNames[0]]; if (!sheet) throw new Error("Sheet not found."); const json = XLSX.utils.sheet_to_json(sheet, { header: 1 }); detectedHeaders = (json[0] || []).filter(h => h != null && h.toString().trim() !== ''); if (detectedHeaders.length === 0) { alert("Could not detect any column headers in the uploaded file. Please ensure the first row contains the column names."); return; } renderMappingUI(); } catch (err) { alert(`Error processing file: ${err.message}`); console.error(err); } }; reader.readAsArrayBuffer(file); });
    clearBtn.addEventListener('click', clearConfigForm);
    newTeamForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = newTeamNameInput.value.trim(); if (!name) return; try { await fetch(TEAMS_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team_name: name }) }); newTeamNameInput.value = ''; await loadAllData(); } catch (error) { alert('Failed to add team. It may already exist.'); } });
    newCategoryForm.addEventListener('submit', async (e) => { e.preventDefault(); const category_name = newCategoryNameInput.value.trim(); const team_id = parseInt(teamCategorySelect.value, 10); if (!category_name || !team_id) return alert('Please select a team and enter a category name.'); try { await fetch(CATEGORIES_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category_name, team_id }) }); newCategoryNameInput.value = ''; await loadAllData(); } catch (error) { alert('Failed to add category. It may already exist.'); } });
    categorizationConfigSelector.addEventListener('change', () => { const selectedId = parseInt(categorizationConfigSelector.value, 10); const config = (window.allClientConfigs || []).find(c => c.id === selectedId); if (config?.config_data?.columnMappings) { columnMappingsForCategorization = config.config_data.columnMappings; const hasRequiredCols = columnMappingsForCategorization.edit && columnMappingsForCategorization.notes; categorizationReportUploader.disabled = !hasRequiredCols; if(!hasRequiredCols) alert('Selected config must map both "Claim Edits" and "Claim Notes" to discover new rules.') } });
    categorizationReportUploader.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const dataJson = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); processUploadedReport(dataJson); }; reader.readAsArrayBuffer(file); });
    document.querySelectorAll('.save-rules-btn').forEach(btn => btn.addEventListener('click', saveNewRules));
    saveExistingChangesBtn.addEventListener('click', saveExistingRuleChanges);
    document.getElementById('manage-pane').addEventListener('click', (e) => { if (e.target.classList.contains('btn-delete-rule')) { const type = e.target.dataset.type; const text = decodeURIComponent(e.target.dataset.text); deleteRule(type, text); } });

    // --- INITIAL PAGE LOAD ---
    loadAllData();
    initializeWidgetCreator();
    populateAvailableWidgets();
});
</script>
</body>
</html>
