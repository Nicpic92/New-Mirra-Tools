<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .mapping-table th { width: 30%; }
        .list-group-item h6 { margin-bottom: 0; }
        .table-responsive-sm { max-height: 400px; overflow-y: auto; }
        .rule-text { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-delete-rule { line-height: 1; }
        .config-name { cursor: pointer; text-decoration: none; }
        .config-name:hover { text-decoration: underline; }
        .pdf-widget { cursor: grab; }
        .l1-indicator { font-size: 0.75rem; font-weight: bold; color: #6f42c1; margin-left: 8px; }
        .triage-step { border-left: 3px solid #dee2e6; padding-left: 15px; }
        .triage-step.active { border-left-color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Admin Console</h1>
            <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
        </div>
        
        <!-- Client Configuration Management Card -->
        <div class="row g-5">
            <div class="col-12">
                <div class="card">
                     <div class="card-body">
                        <h2>Client Configurations</h2>
                        <p class="text-muted">Manage settings for individual clients, their column mappings, and PDF report layouts.</p>
                         <div class="row">
                            <div class="col-md-7">
                                <form id="configForm">
                                    <input type="hidden" id="configId">
                                    <h5>Step 1: Basic Information</h5>
                                    <div class="mb-3"><label for="configName" class="form-label">Configuration Name</label><input type="text" class="form-control" id="configName" required></div>
                                    <div class="mb-3"><label for="clientName" class="form-label">Client Name (for PDF Reports)</label><input type="text" class="form-control" id="clientName"></div>
                                    <hr>
                                    <h5>Step 2: Upload to Map Columns</h5>
                                     <div class="mb-3"><label for="reportUploader" class="form-label">Upload XLSX File</label><input class="form-control" type="file" id="reportUploader" accept=".xlsx"></div>
                                    <div id="mappingSection" class="mt-4" style="display: none;">
                                        <h6 id="mappingHeader">Map Your Fields to Detected Headers:</h6>
                                        <div id="mapping-alert" class="alert alert-info d-none"></div>
                                        <table class="table table-bordered table-sm mapping-table">
                                            <thead class="table-light"><tr><th>Standard Field</th><th>Client's Column Header</th></tr></thead>
                                            <tbody id="mappingTableBody"></tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <h5>Step 3: PDF Report Builder</h5>
                                    <div class="mb-3">
                                        <label for="pdfReportTitle" class="form-label">PDF Report Title Template</label>
                                        <input type="text" class="form-control" id="pdfReportTitle" placeholder="{clientName} Daily Summary Report {date}">
                                        <div class="form-text">Use placeholders like {clientName} and {date}.</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6>Available Widgets</h6>
                                                <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#customWidgetModal">
                                                    <i class="bi bi-plus-circle"></i> Create Custom
                                                </button>
                                            </div>
                                            <ul class="list-group" id="availableWidgets"></ul>
                                        </div>
                                        <div class="col-6">
                                            <h6>Report Layout</h6>
                                            <ul class="list-group" id="reportLayout">
                                                <li class="list-group-item text-muted">Add widgets from the left.</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <hr>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                    <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                                </form>
                            </div>
                            <div class="col-md-5">
                                <h5>Existing Configurations</h5>
                                <p class="small text-muted">Click a name to edit.</p>
                                <ul class="list-group" id="configList"></ul>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Categorization Rules Section -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Client-Specific Categorization & Team Management</h2>
                        <p class="text-muted">Manage teams and categories globally, then create rules for each client to automatically assign claims.</p>
                        
                        <ul class="nav nav-tabs" id="ruleTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover-pane" type="button" role="tab">Discover, Assign & Triage</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="report-builder-tab" data-bs-toggle="tab" data-bs-target="#report-builder-pane" type="button" role="tab">Team Report Builder</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-pane" type="button" role="tab">Manage Existing Rules</button>
                            </li>
                        </ul>

                        <div class="tab-content pt-3">
                            <!-- DISCOVER NEW RULES PANE -->
                            <div class="tab-pane fade show active" id="discover-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h5>1. Manage Teams & Categories</h5>
                                        <h6>Teams</h6>
                                        <ul class="list-group mb-3" id="teamList"></ul>
                                        <form id="newTeamForm" class="d-flex mb-4"><input type="text" id="newTeamName" class="form-control me-2" placeholder="New Team Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></form>
                                        
                                        <h6>Categories</h6>
                                        <div class="mb-3"><select class="form-select" id="teamCategorySelect"><option>Select team...</option></select></div>
                                        <form id="newCategoryForm">
                                            <div class="d-flex"><input type="text" id="newCategoryName" class="form-control me-2" placeholder="New Category Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="l1MonitorCheckbox">
                                                <label class="form-check-label" for="l1MonitorCheckbox">
                                                    Also include in L1 Monitor Report
                                                </label>
                                            </div>
                                        </form>
                                        <div id="categoryListContainer" class="mt-3"></div>
                                        
                                        <hr class="my-4">
                                        <h5>2. Manage Client-Team Associations</h5>
                                        <div class="mb-3">
                                            <label for="clientTeamConfigSelector" class="form-label">Select Client</label>
                                            <select class="form-select" id="clientTeamConfigSelector"><option>Select a client...</option></select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Select Associated Teams</label>
                                            <div id="clientTeamChecklist" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                                <small class="text-muted">Select a client to see teams.</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-success" id="saveClientTeamAssocsBtn">Save Associations</button>
                                    </div>
                                    <div class="col-md-8">
                                        <h5>3. Discover & Assign Rules</h5>
                                        <div class="row bg-light p-3 rounded mb-3">
                                            <div class="col-md-6"><label class="form-label fw-bold">Select Client</label><select class="form-select" id="categorizationConfigSelector"><option>Load configs...</option></select></div>
                                            <div class="col-md-6"><label class="form-label fw-bold">Upload Report</label><input class="form-control" type="file" id="categorizationReportUploader" accept=".xlsx" disabled></div>
                                        </div>
                                        <div id="rulesAssignmentContainer" style="display: none;">
                                            <button class="btn btn-success mb-3 save-rules-btn">Save All Rule Assignments</button>
                                            <div class="table-responsive-sm">
                                                <h6>Uncategorized Claim Edits</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Edit Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedEditsTable"></tbody></table>
                                            </div>
                                            <div class="table-responsive-sm mt-4">
                                                <h6 class="mt-4">Uncategorized Claim Notes</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Full Note Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedNotesTable"></tbody></table>
                                            </div>
                                            <button class="btn btn-success mt-3 save-rules-btn">Save All Rule Assignments</button>
                                        </div>
                                        <div id="noRulesFound" class="alert alert-info">Upload a file to begin.</div>
                                        
                                        <hr class="my-4">

                                        <h5>4. W9 Triage (from uploaded report)</h5>
                                        <p class="text-muted small">After assigning new rules, you can optionally upload the MRW9 report here to identify and re-assign W9-related claims from the main report you just uploaded.</p>
                                        <div id="w9TriageSection" style="display: none;">
                                            <div class="mb-3">
                                                <label for="triageMrw9Uploader" class="form-label fw-bold">Upload MRW9 Report</label>
                                                <input class="form-control" type="file" id="triageMrw9Uploader" accept=".xlsx,.csv">
                                            </div>
                                            <div id="triageResultsContainer" class="d-none">
                                                <p id="triageSummary"></p>
                                                <div class="table-responsive-sm border mb-3">
                                                    <table class="table table-sm table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Claim ID</th>
                                                                <th>Provider Name</th>
                                                                <th>Provider TIN</th>
                                                                <th>TIN Has W9?</th>
                                                                <th>Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="triageTableBody"></tbody>
                                                    </table>
                                                </div>
                                                <button class="btn btn-primary" id="generateAssignmentReportsBtn">Generate Assignment Reports</button>
                                            </div>
                                            <div id="triagePlaceholder" class="alert alert-secondary">
                                                Upload an MRW9 report to begin the triage process.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- TEAM REPORT BUILDER PANE -->
                            <div class="tab-pane fade" id="report-builder-pane" role="tabpanel">
                                <h5>Build Custom Team Report Layouts</h5>
                                <p class="text-muted">For specific categories, define how the data should be grouped and which columns should appear in the downloaded Excel report. Reports without a custom layout will use a default format.</p>
                                <div class="row">
                                    <div class="col-md-5">
                                        <form id="reportBuilderForm">
                                            <div class="mb-3">
                                                <label for="reportBuilderTeam" class="form-label fw-bold">1. Select a Team</label>
                                                <select id="reportBuilderTeam" class="form-select"></select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="reportBuilderCategory" class="form-label fw-bold">2. Select a Category</label>
                                                <select id="reportBuilderCategory" class="form-select" disabled></select>
                                            </div>
                                            <div id="builder-container" class="d-none mt-4">
                                                <div class="mb-3">
                                                     <label class="form-label fw-bold">3. Select Columns to Group By</label>
                                                     <p class="small text-muted mb-1">The report will create one row for each unique combination of these values (like a pivot table).</p>
                                                     <div id="reportBuilderGroupByChecklist" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;"></div>
                                                </div>
                                                <div class="mb-3">
                                                     <label class="form-label fw-bold">4. Add Calculated Columns</label>
                                                     <div id="reportBuilderMetricsChecklist">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="claimCount" id="metricClaimCount" checked>
                                                            <label class="form-check-label" for="metricClaimCount">
                                                                Count of Claims
                                                            </label>
                                                        </div>
                                                     </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Save Report Layout</button>
                                                <button type="button" class="btn btn-outline-danger" id="deleteReportLayoutBtn" disabled>Delete Layout</button>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-md-7">
                                        <h6>Existing Custom Report Layouts</h6>
                                        <div id="existingReportLayoutsList" class="list-group">
                                            <div class="list-group-item">No custom layouts created yet.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MANAGE EXISTING RULES PANE -->
                            <div class="tab-pane fade" id="manage-pane" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h5>Manage Existing Rules</h5>
                                        <p class="mb-0">Re-assign a rule to a different category or delete it permanently.</p>
                                    </div>
                                    <div class="w-25">
                                        <label for="clientRuleFilter" class="form-label">Filter by Client</label>
                                        <select class="form-select form-select-sm" id="clientRuleFilter">
                                            <option value="">Select a Client...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="saveExistingChangesBtn" class="btn btn-success mb-3">Save All Changes to Existing Rules</button>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Claim Edit Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Edit Text</th><th>Assigned Category (Team)</th><th></th></tr></thead>
                                                <tbody id="existingEditsTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Claim Note Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Full Note Text</th><th>Assigned Category (Team)</th><th></th></tr></thead>
                                                <tbody id="existingNotesTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Widget Creation Modal -->
    <div class="modal fade" id="customWidgetModal" tabindex="-1" aria-labelledby="customWidgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customWidgetModalLabel">Create Custom Report Widget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customWidgetForm">
                        <div class="mb-3">
                            <label for="widgetName" class="form-label">Widget Name</label>
                            <input type="text" class="form-control" id="widgetName" placeholder="e.g., Claims Count by Payer" required>
                        </div>
                        <div class="mb-3">
                            <label for="groupByColumn" class="form-label">Group Data By (Dimension)</label>
                            <select class="form-select" id="groupByColumn" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="metricType" class="form-label">Calculate (Metric)</label>
                            <select class="form-select" id="metricType">
                                <option value="count">Count of Claims</option>
                                <option value="sum">Sum of a Column</option>
                            </select>
                        </div>
                        <div class="mb-3" id="metricColumnContainer" style="display: none;">
                            <label for="metricColumn" class="form-label">Column to Sum</label>
                            <select class="form-select" id="metricColumn"></select>
                        </div>
                        <hr>
                        <h6>PDF Table Headers</h6>
                        <div class="mb-3">
                            <label for="tableHeader1" class="form-label">Header for Grouping Column</label>
                            <input type="text" class="form-control" id="tableHeader1" placeholder="e.g., Payer Name" required>
                        </div>
                        <div class="mb-3">
                            <label for="tableHeader2" class="form-label">Header for Metric Column</label>
                            <input type="text" class="form-control" id="tableHeader2" placeholder="e.g., Number of Claims" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveWidgetBtn">Save Widget</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // API Endpoints
    const CONFIG_API = '/.netlify/functions/configurations';
    const TEAMS_API = '/.netlify/functions/teams';
    const CATEGORIES_API = '/.netlify/functions/categories';
    const RULES_API = '/.netlify/functions/client-rules';
    const CLIENT_TEAM_API = '/.netlify/functions/client-team-associations';
    const REPORT_CONFIG_API = '/.netlify/functions/team-report-configs';

    // DOM Elements
    const configForm = document.getElementById('configForm'), configIdInput = document.getElementById('configId'), configNameInput = document.getElementById('configName'), clientNameInput = document.getElementById('clientName'), clearBtn = document.getElementById('clearBtn'), reportUploader = document.getElementById('reportUploader'), mappingSection = document.getElementById('mappingSection'), mappingTableBody = document.getElementById('mappingTableBody'), mappingHeader = document.getElementById('mappingHeader'), mappingAlert = document.getElementById('mapping-alert'), configList = document.getElementById('configList');
    const teamList = document.getElementById('teamList'), newTeamForm = document.getElementById('newTeamForm'), newTeamNameInput = document.getElementById('newTeamName'), teamCategorySelect = document.getElementById('teamCategorySelect'), categoryListContainer = document.getElementById('categoryListContainer'), newCategoryForm = document.getElementById('newCategoryForm'), newCategoryNameInput = document.getElementById('newCategoryName'), l1MonitorCheckbox = document.getElementById('l1MonitorCheckbox');
    const categorizationConfigSelector = document.getElementById('categorizationConfigSelector'), categorizationReportUploader = document.getElementById('categorizationReportUploader'), rulesAssignmentContainer = document.getElementById('rulesAssignmentContainer'), uncategorizedEditsTable = document.getElementById('uncategorizedEditsTable'), uncategorizedNotesTable = document.getElementById('uncategorizedNotesTable'), noRulesFoundDiv = document.getElementById('noRulesFound');
    const existingEditsTableBody = document.getElementById('existingEditsTableBody'), existingNotesTableBody = document.getElementById('existingNotesTableBody'), saveExistingChangesBtn = document.getElementById('saveExistingChangesBtn');
    const pdfReportTitleInput = document.getElementById('pdfReportTitle'), availableWidgetsList = document.getElementById('availableWidgets'), reportLayoutList = document.getElementById('reportLayout');
    const customWidgetForm = document.getElementById('customWidgetForm'), customWidgetModalEl = document.getElementById('customWidgetModal'), customWidgetModal = new bootstrap.Modal(customWidgetModalEl), saveWidgetBtn = document.getElementById('saveWidgetBtn'), metricTypeSelect = document.getElementById('metricType'), metricColumnContainer = document.getElementById('metricColumnContainer');
    const clientTeamConfigSelector = document.getElementById('clientTeamConfigSelector'), clientTeamChecklist = document.getElementById('clientTeamChecklist'), saveClientTeamAssocsBtn = document.getElementById('saveClientTeamAssocsBtn');
    const clientRuleFilter = document.getElementById('clientRuleFilter');
    const w9TriageSection = document.getElementById('w9TriageSection'), triageMrw9Uploader = document.getElementById('triageMrw9Uploader'), triageResultsContainer = document.getElementById('triageResultsContainer'), triagePlaceholder = document.getElementById('triagePlaceholder'), triageTableBody = document.getElementById('triageTableBody'), generateAssignmentReportsBtn = document.getElementById('generateAssignmentReportsBtn'), triageSummary = document.getElementById('triageSummary');
    const reportBuilderForm = document.getElementById('reportBuilderForm'), reportBuilderTeam = document.getElementById('reportBuilderTeam'), reportBuilderCategory = document.getElementById('reportBuilderCategory'), builderContainer = document.getElementById('builder-container'), reportBuilderGroupByChecklist = document.getElementById('reportBuilderGroupByChecklist'), existingReportLayoutsList = document.getElementById('existingReportLayoutsList'), deleteReportLayoutBtn = document.getElementById('deleteReportLayoutBtn');

    // Global State
    let allTeams = [], allCategories = [], allClientConfigs = [], allClientTeamAssociations = [], detectedHeaders = [], columnMappingsForCategorization = {}, mappingsForEditing = {}, currentCustomWidgets = [];
    let activeEditRules = [], activeNoteRules = [];
    let configSpecificRules = { editRulesMap: new Map(), noteRulesMap: new Map() };
    let uncategorizedEdits = [], uncategorizedNotes = [];
    let mainReportFullData = [], triageClaimsData = [];
    let allReportConfigs = [];

    const standardFields = [
        { key: 'claimId', displayName: 'Claim ID / Number', required: true, type: 'string' }, { key: 'age', displayName: 'Age (in days)', required: true, type: 'number' }, { key: 'netPayment', displayName: 'Net Payment Amount', required: true, type: 'number' }, { key: 'state', displayName: 'Claim State', required: true, type: 'string' }, { key: 'status', displayName: 'Claim Status', required: true, type: 'string' }, { key: 'networkStatus', displayName: 'Network Status', required: true, type: 'string' }, { key: 'providerName', displayName: 'Billing Provider Name', required: true, type: 'string' }, { key: 'edit', displayName: 'Claim Edits', required: true, type: 'string' }, { key: 'notes', displayName: 'Claim Notes', required: true, type: 'string' }, { key: 'totalCharges', displayName: 'Total Billed Amount', required: false, type: 'number' }, { key: 'dsnp', displayName: 'DSNP Status', required: false, type: 'string' }, { key: 'payer', displayName: 'Payer Name', required: false, type: 'string' }, { key: 'claimCategory', displayName: 'Category', required: false, type: 'string' }, { key: 'claimType', displayName: 'Claim Type', required: false, type: 'string' }, { key: 'receivedDate', displayName: 'Received Date', required: false, type: 'date' }, { key: 'billingProviderTaxId', displayName: 'Billing Provider Tax ID', required: false, type: 'string' }, { key: 'billingProviderNpi', displayName: 'Billing Provider NPI', required: false, type: 'string' }, { key: 'patientName', displayName: 'Patient Name', required: false, type: 'string' }, { key: 'subscriberId', displayName: 'Subscriber ID', required: false, type: 'string' }, { key: 'renderingProviderName', displayName: 'Rendering Provider Name', required: false, type: 'string' }, { key: 'renderingProviderNpi', displayName: 'Rendering Provider NPI', required: false, type: 'string' }, { key: 'dosFrom', displayName: 'Date of Service (From)', required: false, type: 'date' }, { key: 'dosTo', displayName: 'Date of Service (To)', required: false, type: 'date' }, { key: 'cleanAge', displayName: 'Clean Age', required: false, type: 'number' }, { key: 'pbpName', displayName: 'PBP Name', required: false, type: 'string' }, { key: 'planName', displayName: 'Plan Name', required: false, type: 'string' }, { key: 'activityLog', displayName: 'Activity Log Description', required: false, type: 'string' }, { key: 'activityUser', displayName: 'Activity Performed By', required: false, type: 'string' }, { key: 'activityDate', displayName: 'Activity Performed On', required: false, type: 'date' }
    ];

    // --- CORE DATA LOADING & RENDERING ---
    async function loadConfigurations() {
        try {
            const response = await fetch(CONFIG_API);
            if (!response.ok) throw new Error('Failed to fetch configurations');
            allClientConfigs = await response.json();
            configList.innerHTML = allClientConfigs.length ? '' : '<li class="list-group-item">No configurations found.</li>';
            
            const selectors = [categorizationConfigSelector, clientTeamConfigSelector, clientRuleFilter];
            selectors.forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = '<option selected disabled value="">Select a configuration...</option>';
                allClientConfigs.forEach(config => sel.add(new Option(config.config_name, config.id)));
                if (allClientConfigs.some(c => c.id == currentVal)) sel.value = currentVal;
            });

            allClientConfigs.forEach(config => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                const nameLink = document.createElement('a');
                nameLink.href = '#'; nameLink.className = 'config-name flex-grow-1'; nameLink.dataset.configId = config.id; nameLink.textContent = config.config_name;
                li.appendChild(nameLink);
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group'; btnGroup.role = 'group';
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm'; deleteBtn.textContent = 'Delete'; deleteBtn.onclick = () => deleteConfig(config.id);
                btnGroup.appendChild(deleteBtn);
                li.appendChild(btnGroup);
                configList.appendChild(li);
            });
        } catch (error) { console.error('Error loading configurations:', error); }
    }
    
    async function loadTeams() { const response = await fetch(TEAMS_API); if (response.ok) allTeams = await response.json(); }
    async function loadCategories() { const response = await fetch(CATEGORIES_API); if (response.ok) allCategories = await response.json(); }
    async function loadRulesForConfig(configId) {
        if (!configId) { activeEditRules = []; activeNoteRules = []; return; }
        const [editRes, noteRes] = await Promise.all([fetch(`${RULES_API}?type=edit&config_id=${configId}`), fetch(`${RULES_API}?type=note&config_id=${configId}`)]);
        if (editRes.ok) activeEditRules = await editRes.json();
        if (noteRes.ok) activeNoteRules = await noteRes.json();
    }
    async function loadClientTeamAssociations() { const response = await fetch(CLIENT_TEAM_API); if(response.ok) allClientTeamAssociations = await response.json(); }
    async function loadReportConfigs() { const response = await fetch(REPORT_CONFIG_API); if (response.ok) allReportConfigs = await response.json(); }
    
    function renderTeamList() {
        teamList.innerHTML = allTeams.length ? '' : '<li class="list-group-item">No teams defined.</li>';
        allTeams.forEach(team => {
            const li = document.createElement('li');
            li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
            li.textContent = team.team_name;
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1 btn-delete-rule';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = () => deleteTeam(team.id);
            li.appendChild(deleteBtn);
            teamList.appendChild(li);
        });
    }

    function populateTeamDropdown() {
        teamCategorySelect.innerHTML = '<option value="">Select a team to add to...</option>';
        allTeams.sort((a, b) => a.team_name.localeCompare(b.team_name)).forEach(team => teamCategorySelect.add(new Option(team.team_name, team.id)));
    }

    function renderCategoryList() {
        categoryListContainer.innerHTML = '';
        const grouped = allCategories.reduce((acc, cat) => {
            const teamName = cat.team_name || 'Unassigned';
            if (!acc[teamName]) acc[teamName] = [];
            acc[teamName].push(cat);
            return acc;
        }, {});
        Object.keys(grouped).sort().forEach(teamName => {
            const card = document.createElement('div');
            card.className = 'card mb-2';
            card.innerHTML = `<div class="card-header py-1">${teamName}</div>`;
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            grouped[teamName].sort((a,b) => a.category_name.localeCompare(b.category_name)).forEach(cat => {
                const li = document.createElement('li');
                li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = cat.category_name;
                if (cat.send_to_l1_monitor) {
                    const l1Span = document.createElement('span');
                    l1Span.className = 'l1-indicator';
                    l1Span.textContent = '(L1 Monitor)';
                    nameSpan.appendChild(l1Span);
                }
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1 btn-delete-rule';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => deleteCategory(cat.id);
                li.appendChild(nameSpan);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
            card.appendChild(list);
            categoryListContainer.appendChild(card);
        });
    }

    async function loadAllData() {
        try {
            await Promise.all([ loadTeams(), loadCategories(), loadConfigurations(), loadClientTeamAssociations(), loadReportConfigs() ]);
            renderTeamList();
            populateTeamDropdown();
            renderCategoryList();
            populateReportBuilderTeams();
            renderExistingReportLayouts();
        } catch (error) { console.error("Failed to load initial admin data:", error); }
    }

    // --- REPORT BUILDER LOGIC ---
    function populateReportBuilderTeams() {
        reportBuilderTeam.innerHTML = '<option value="" selected disabled>Select a team...</option>';
        allTeams.sort((a, b) => a.team_name.localeCompare(b.team_name)).forEach(team => {
            reportBuilderTeam.add(new Option(team.team_name, team.id));
        });
    }

    function renderExistingReportLayouts() {
        existingReportLayoutsList.innerHTML = '';
        if (allReportConfigs.length === 0) {
            existingReportLayoutsList.innerHTML = '<div class="list-group-item">No custom layouts created yet.</div>';
            return;
        }
        allReportConfigs.forEach(config => {
            const team = allTeams.find(t => t.id === config.team_id);
            const category = allCategories.find(c => c.id === config.category_id);
            if (!team || !category) return;

            const li = document.createElement('a');
            li.href = '#';
            li.className = 'list-group-item list-group-item-action';
            li.dataset.teamId = team.id;
            li.dataset.categoryId = category.id;
            li.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${team.team_name} &rarr; ${category.category_name}</h6>
                </div>
                <p class="mb-1 small text-muted">Groups by: ${config.report_config_data.groupBy.map(f => f.displayName).join(', ')}</p>
            `;
            li.addEventListener('click', (e) => {
                e.preventDefault();
                reportBuilderTeam.value = e.currentTarget.dataset.teamId;
                reportBuilderTeam.dispatchEvent(new Event('change'));
                setTimeout(() => {
                     reportBuilderCategory.value = e.currentTarget.dataset.categoryId;
                     reportBuilderCategory.dispatchEvent(new Event('change'));
                }, 100);
            });
            existingReportLayoutsList.appendChild(li);
        });
    }

    function populateBuilderChecklist() {
        reportBuilderGroupByChecklist.innerHTML = '';
        standardFields.filter(f => f.type === 'string').sort((a,b) => a.displayName.localeCompare(b.displayName)).forEach(field => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `<input class="form-check-input" type="checkbox" value="${field.key}" id="group_${field.key}"><label class="form-check-label" for="group_${field.key}">${field.displayName}</label>`;
            reportBuilderGroupByChecklist.appendChild(div);
        });
    }

    // --- (All other functions from previous steps are below) ---
    function editConfig(configId) { /* ... same as before ... */ }
    async function deleteConfig(id) { /* ... same as before ... */ }
    async function deleteTeam(id) { /* ... same as before ... */ }
    async function deleteCategory(id) { /* ... same as before ... */ }
    function processUploadedReport(data) {
        const allowedStatuses = ['PEND', 'MANAGEMENTREVIEW', 'ONHOLD'];
        const { edit: editColumn, notes: notesColumn, status: statusColumn } = columnMappingsForCategorization;

        if (!statusColumn) {
            alert("Action Required: To discover new rules, the 'Claim Status' standard field must be mapped in this client's configuration.");
            categorizationReportUploader.value = '';
            return;
        }
        const detectedEdits = new Set(), detectedNotes = new Set();
        data.forEach(row => {
            const claimStatus = (row[statusColumn] || '').toString().toUpperCase().trim();
            if (allowedStatuses.includes(claimStatus)) {
                const editValue = (row[editColumn] || '').toString().trim();
                if (editValue && !activeEditRules.some(r => r.text === editValue)) detectedEdits.add(editValue);
                const noteValue = (row[notesColumn] || '').toString().trim();
                if (noteValue && !activeNoteRules.some(r => r.text === noteValue)) detectedNotes.add(noteValue);
            }
        });
        uncategorizedEdits = Array.from(detectedEdits).sort((a, b) => a.localeCompare(b));
        uncategorizedNotes = Array.from(detectedNotes).sort((a, b) => a.localeCompare(b));
        renderUncategorizedRulesTables();
    }
    function renderUncategorizedRulesTables() {
        uncategorizedEditsTable.innerHTML = '';
        uncategorizedEdits.forEach(text => {
            const row = uncategorizedEditsTable.insertRow();
            row.insertCell().innerHTML = `<div class="rule-text" title="${text}">${text}</div>`; row.cells[0].firstChild.dataset.text = text;
            row.insertCell().innerHTML = createCategoryDropdown().outerHTML;
        });
        uncategorizedNotesTable.innerHTML = '';
        uncategorizedNotes.forEach(noteText => {
            const row = uncategorizedNotesTable.insertRow();
            row.insertCell().innerHTML = `<div class="rule-text" title="${noteText}">${noteText}</div>`; row.cells[0].firstChild.dataset.text = noteText;
            row.insertCell().innerHTML = createCategoryDropdown().outerHTML;
        });
        const hasRules = uncategorizedEdits.length > 0 || uncategorizedNotes.length > 0;
        rulesAssignmentContainer.style.display = hasRules ? 'block' : 'none';
        noRulesFoundDiv.textContent = hasRules ? '' : 'No new, uncategorized items were found in the uploaded file matching the required statuses (Pend, Management Review, On Hold).';
        noRulesFoundDiv.style.display = hasRules ? 'none' : 'block';
    }
    function createCategoryDropdown(selectedId = '') { const select = document.createElement('select'); select.className = 'form-select form-select-sm'; select.add(new Option('Select category...', '')); allCategories.sort((a,b) => (a.team_name || 'Z').localeCompare(b.team_name || 'Z') || a.category_name.localeCompare(b.category_name)).forEach(cat => select.add(new Option(`${cat.team_name || 'Unassigned'} -> ${cat.category_name}`, cat.id))); if (selectedId) { select.value = selectedId; } return select; }
    async function saveNewRules() {
        const configId = categorizationConfigSelector.value;
        if (!configId) return alert('Cannot save rules without a selected configuration.');
        const getRules = (table) => Array.from(table.rows).map(row => ({ text: row.querySelector('.rule-text').dataset.text, category_id: row.cells[1].querySelector('select').value })).filter(rule => rule.category_id);
        const editRulesToSave = getRules(uncategorizedEditsTable);
        const noteRulesToSave = getRules(uncategorizedNotesTable);
        if (editRulesToSave.length === 0 && noteRulesToSave.length === 0) return alert('No new rules were assigned to a category.');
        try {
            await Promise.all([
                editRulesToSave.length > 0 ? fetch(`${RULES_API}?type=edit&config_id=${configId}`, { method: 'POST', body: JSON.stringify(editRulesToSave) }) : Promise.resolve(),
                noteRulesToSave.length > 0 ? fetch(`${RULES_API}?type=note&config_id=${configId}`, { method: 'POST', body: JSON.stringify(noteRulesToSave) }) : Promise.resolve()
            ]);
            alert('Rules saved successfully!');
            await loadRulesForConfig(configId);
            uncategorizedEdits = uncategorizedEdits.filter(edit => !editRulesToSave.some(saved => saved.text === edit));
            uncategorizedNotes = uncategorizedNotes.filter(note => !noteRulesToSave.some(saved => saved.text === note));
            renderUncategorizedRulesTables(); 
            renderExistingRulesTables(activeEditRules, activeNoteRules);
        } catch (error) { alert(`Failed to save rules: ${error.message}`); }
    }
    function renderExistingRulesTables(editRules = [], noteRules = []) { /* ... same as before ... */ }
    async function deleteRule(type, text) { /* ... same as before ... */ }
    async function saveExistingRuleChanges() { /* ... same as before ... */ }
    function clearConfigForm() { /* ... same as before ... */ }
    function readFile(file) { return new Promise((resolve, reject) => { /* ... same as before ... */ }); }
    // All other functions and event listeners are assumed to be complete here.
    
    // --- EVENT LISTENERS ---
    reportBuilderTeam.addEventListener('change', () => {
        const teamId = parseInt(reportBuilderTeam.value, 10);
        reportBuilderCategory.innerHTML = '<option value="" selected disabled>Select a category...</option>';
        builderContainer.classList.add('d-none');
        if (!teamId) return;
        allCategories.filter(c => c.team_id === teamId).sort((a, b) => a.category_name.localeCompare(b.category_name)).forEach(cat => reportBuilderCategory.add(new Option(cat.category_name, cat.id)));
        reportBuilderCategory.disabled = false;
    });

    reportBuilderCategory.addEventListener('change', () => {
        const teamId = parseInt(reportBuilderTeam.value, 10);
        const categoryId = parseInt(reportBuilderCategory.value, 10);
        builderContainer.classList.add('d-none');
        reportBuilderForm.reset();
        document.getElementById('metricClaimCount').checked = true;

        if (!teamId || !categoryId) return;
        
        populateBuilderChecklist();

        const existingConfig = allReportConfigs.find(c => c.team_id === teamId && c.category_id === categoryId);
        if (existingConfig) {
            existingConfig.report_config_data.groupBy.forEach(field => {
                const chk = document.getElementById(`group_${field.key}`);
                if (chk) chk.checked = true;
            });
            deleteReportLayoutBtn.dataset.configId = existingConfig.id;
            deleteReportLayoutBtn.disabled = false;
        } else {
            deleteReportLayoutBtn.disabled = true;
            deleteReportLayoutBtn.removeAttribute('data-config-id');
        }
        builderContainer.classList.remove('d-none');
    });

    reportBuilderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const team_id = parseInt(reportBuilderTeam.value, 10);
        const category_id = parseInt(reportBuilderCategory.value, 10);
        const groupBy = Array.from(reportBuilderGroupByChecklist.querySelectorAll('input:checked')).map(chk => {
            const field = standardFields.find(f => f.key === chk.value);
            return { key: field.key, displayName: field.displayName };
        });

        if (groupBy.length === 0) return alert('Please select at least one column to group by.');
        
        const report_config_data = { groupBy, metrics: ['claimCount'] };
        try {
            const res = await fetch(REPORT_CONFIG_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team_id, category_id, report_config_data }) });
            if (!res.ok) throw new Error('Failed to save layout.');
            alert('Report layout saved successfully!');
            await loadAllData();
        } catch (error) { alert(`Error: ${error.message}`); }
    });

    deleteReportLayoutBtn.addEventListener('click', async (e) => {
        const id = parseInt(e.currentTarget.dataset.configId, 10);
        if (!id || !confirm('Are you sure you want to delete this report layout?')) return;
        
        try {
            const res = await fetch(REPORT_CONFIG_API, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
            if (!res.ok) throw new Error('Failed to delete layout.');
            alert('Report layout deleted.');
            await loadAllData();
            reportBuilderForm.reset();
            builderContainer.classList.add('d-none');
        } catch (error) { alert(`Error: ${error.message}`); }
    });

    // ... All other event listeners for forms, buttons, etc.
    
    // Initial Load Call
    loadAllData();
});
</script>
</body>
</html>
