<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .mapping-table th { width: 30%; }
        .list-group-item h6 { margin-bottom: 0; }
        .table-responsive-sm { max-height: 400px; overflow-y: auto; }
        .rule-text { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-delete-rule { line-height: 1; }
        .config-name { cursor: pointer; text-decoration: none; }
        .config-name:hover { text-decoration: underline; }
        .pdf-widget { cursor: grab; }
        .l1-indicator { font-size: 0.75rem; font-weight: bold; color: #6f42c1; margin-left: 8px; }
        .triage-step { border-left: 3px solid #dee2e6; padding-left: 15px; }
        .triage-step.active { border-left-color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Admin Console</h1>
            <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
        </div>
        
        <!-- Client Configuration Management Card -->
        <div class="row g-5">
            <div class="col-12">
                <div class="card">
                     <div class="card-body">
                        <h2>Client Configurations</h2>
                        <p class="text-muted">Manage settings for individual clients, their column mappings, and a **default** PDF report layout.</p>
                         <div class="row">
                            <div class="col-md-7">
                                <form id="configForm">
                                    <input type="hidden" id="configId">
                                    <h5>Step 1: Basic Information</h5>
                                    <div class="mb-3"><label for="configName" class="form-label">Configuration Name</label><input type="text" class="form-control" id="configName" required></div>
                                    <div class="mb-3"><label for="clientName" class="form-label">Client Name (for PDF Reports)</label><input type="text" class="form-control" id="clientName"></div>
                                    <hr>
                                    <h5>Step 2: Upload to Map Columns</h5>
                                    <div class="d-flex align-items-end">
                                        <div class="flex-grow-1">
                                            <label for="reportUploader" class="form-label">Upload XLSX File</label>
                                            <input class="form-control" type="file" id="reportUploader" accept=".xlsx">
                                        </div>
                                        <div class="ms-3 text-center">
                                            <span class="text-muted d-block mb-1 small">OR</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#copyMappingModal">
                                                <i class="bi bi-clipboard-plus"></i> Copy from...
                                            </button>
                                        </div>
                                    </div>
                                    <div id="mappingSection" class="mt-4" style="display: none;">
                                        <h6 id="mappingHeader">Map Your Fields to Detected Headers:</h6>
                                        <div id="mapping-alert" class="alert alert-info d-none"></div>
                                        <table class="table table-bordered table-sm mapping-table">
                                            <thead class="table-light"><tr><th>Standard Field</th><th>Client's Column Header</th></tr></thead>
                                            <tbody id="mappingTableBody"></tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <h5>Step 3: Default PDF Report Builder</h5>
                                    <p class="small text-muted">This layout will be used if a more specific universal Team/Category layout is not found.</p>
                                    <div class="mb-3">
                                        <label for="pdfReportTitle" class="form-label">PDF Report Title Template</label>
                                        <input type="text" class="form-control" id="pdfReportTitle" placeholder="{clientName} Daily Summary Report {date}">
                                        <div class="form-text">Use placeholders like {clientName} and {date}.</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6>Available Widgets</h6>
                                                <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#customWidgetModal">
                                                    <i class="bi bi-plus-circle"></i> Create Custom
                                                </button>
                                            </div>
                                            <ul class="list-group" id="availableWidgets"></ul>
                                        </div>
                                        <div class="col-6">
                                            <h6>Report Layout</h6>
                                            <ul class="list-group" id="reportLayout">
                                                <li class="list-group-item text-muted">Add widgets from the left.</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <hr>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                    <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                                </form>
                            </div>
                            <div class="col-md-5">
                                <h5>Existing Configurations</h5>
                                <p class="small text-muted">Click a name to edit.</p>
                                <ul class="list-group" id="configList"></ul>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CORRECTED: UNIVERSAL TEAM REPORT BUILDER SECTION -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Universal Team Report Builder</h2>
                        <p class="text-muted">Define a universal report layout for any Team and Category combination. This layout applies globally, regardless of the client.</p>
                        
                        <div class="row bg-light p-3 rounded mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">1. Select Team</label>
                                <select class="form-select" id="reportBuilderTeam"><option>Loading teams...</option></select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">2. Select Category</label>
                                <select class="form-select" id="reportBuilderCategory" disabled><option>Select a team...</option></select>
                            </div>
                        </div>

                        <div id="builderContainer" class="d-none">
                            <h5 id="builderHeader"></h5>
                             <form id="reportBuilderForm">
                                <input type="hidden" id="teamReportConfigId">
                                <div class="mb-3">
                                    <label for="teamPdfReportTitle" class="form-label">Report Title Template</label>
                                    <input type="text" class="form-control" id="teamPdfReportTitle" placeholder="{teamName} - {categoryName} Summary {date}">
                                    <div class="form-text">Placeholders: {teamName}, {categoryName}, {date}.</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Report Layout</h6>
                                        <ul class="list-group" id="teamReportLayout">
                                            <li class="list-group-item text-muted">Add widgets from the right.</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                         <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6>Available Widgets</h6>
                                        </div>
                                        <ul class="list-group" id="teamAvailableWidgets"></ul>
                                    </div>
                                </div>
                                <hr>
                                <button type="button" class="btn btn-primary" id="saveReportLayoutBtn">Save Report Layout</button>
                                <button type="button" class="btn btn-danger" id="deleteReportLayoutBtn" disabled>Delete This Layout</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Categorization Rules Section -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Client-Specific Categorization & Team Management</h2>
                        <p class="text-muted">Manage teams and categories globally, then create rules for each client to automatically assign claims.</p>
                        
                        <ul class="nav nav-tabs" id="ruleTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover-pane" type="button" role="tab">Discover, Assign & Triage</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-pane" type="button" role="tab">Manage Existing Rules</button>
                            </li>
                        </ul>

                        <div class="tab-content pt-3">
                            <!-- DISCOVER NEW RULES PANE -->
                            <div class="tab-pane fade show active" id="discover-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h5>1. Manage Teams & Categories</h5>
                                        <h6>Teams</h6>
                                        <ul class="list-group mb-3" id="teamList"></ul>
                                        <form id="newTeamForm" class="d-flex mb-4"><input type="text" id="newTeamName" class="form-control me-2" placeholder="New Team Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></form>
                                        
                                        <h6>Categories</h6>
                                        <div class="mb-3"><select class="form-select" id="teamCategorySelect"><option>Select team...</option></select></div>
                                        <form id="newCategoryForm">
                                            <div class="d-flex"><input type="text" id="newCategoryName" class="form-control me-2" placeholder="New Category Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="l1MonitorCheckbox">
                                                <label class="form-check-label" for="l1MonitorCheckbox">
                                                    Also include in L1 Monitor Report
                                                </label>
                                            </div>
                                        </form>
                                        <div id="categoryListContainer" class="mt-3"></div>
                                        
                                        <hr class="my-4">
                                        <h5>2. Manage Client-Team Associations</h5>
                                        <div class="mb-3">
                                            <label for="clientTeamConfigSelector" class="form-label">Select Client</label>
                                            <select class="form-select" id="clientTeamConfigSelector"><option>Select a client...</option></select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Select Associated Teams</label>
                                            <div id="clientTeamChecklist" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                                <small class="text-muted">Select a client to see teams.</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-success" id="saveClientTeamAssocsBtn">Save Associations</button>
                                    </div>
                                    <div class="col-md-8">
                                        <h5>3. Discover & Assign Rules</h5>
                                        <div class="row bg-light p-3 rounded mb-3">
                                            <div class="col-md-6"><label class="form-label fw-bold">Select Client</label><select class="form-select" id="categorizationConfigSelector"><option>Load configs...</option></select></div>
                                            <div class="col-md-6"><label class="form-label fw-bold">Upload Report</label><input class="form-control" type="file" id="categorizationReportUploader" accept=".xlsx" disabled></div>
                                        </div>
                                        <div id="rulesAssignmentContainer" style="display: none;">
                                            <button class="btn btn-success mb-3 save-rules-btn">Save All Rule Assignments</button>
                                            <div class="table-responsive-sm">
                                                <h6>Uncategorized Claim Edits</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Edit Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedEditsTable"></tbody></table>
                                            </div>
                                            <div class="table-responsive-sm mt-4">
                                                <h6 class="mt-4">Uncategorized Claim Notes</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Full Note Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedNotesTable"></tbody></table>
                                            </div>
                                            <button class="btn btn-success mt-3 save-rules-btn">Save All Rule Assignments</button>
                                        </div>
                                        <div id="noRulesFound" class="alert alert-info">Upload a file to begin.</div>
                                        
                                        <hr class="my-4">

                                        <h5>4. W9 Triage (from uploaded report)</h5>
                                        <p class="text-muted small">After assigning new rules, you can optionally upload the MRW9 report here to identify and re-assign W9-related claims from the main report you just uploaded.</p>
                                        <div id="w9TriageSection" style="display: none;">
                                            <div class="mb-3">
                                                <label for="triageMrw9Uploader" class="form-label fw-bold">Upload MRW9 Report</label>
                                                <input class="form-control" type="file" id="triageMrw9Uploader" accept=".xlsx,.csv">
                                            </div>
                                            <div id="triageResultsContainer" class="d-none">
                                                <p id="triageSummary"></p>
                                                <div class="table-responsive-sm border mb-3">
                                                    <table class="table table-sm table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Claim ID</th>
                                                                <th>Provider Name</th>
                                                                <th>Provider TIN</th>
                                                                <th>TIN Has W9?</th>
                                                                <th>Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="triageTableBody"></tbody>
                                                    </table>
                                                </div>
                                                <button class="btn btn-primary" id="generateAssignmentReportsBtn">Generate Assignment Reports</button>
                                            </div>
                                            <div id="triagePlaceholder" class="alert alert-secondary">
                                                Upload an MRW9 report to begin the triage process.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MANAGE EXISTING RULES PANE -->
                            <div class="tab-pane fade" id="manage-pane" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h5>Manage Existing Rules</h5>
                                        <p class="mb-0">Re-assign a rule to a different category or delete it permanently.</p>
                                    </div>
                                    <div class="d-flex align-items-end">
                                        <div class="me-3">
                                            <label for="clientRuleFilter" class="form-label">Filter by Client</label>
                                            <select class="form-select form-select-sm" id="clientRuleFilter">
                                                <option value="">Select a Client...</option>
                                            </select>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" id="downloadRulesBtn" disabled>
                                                <i class="bi bi-download"></i> Download Rules
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" id="copyRulesBtn" disabled data-bs-toggle="modal" data-bs-target="#copyRulesModal">
                                                <i class="bi bi-clipboard-plus"></i> Copy From...
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <button id="saveExistingChangesBtn" class="btn btn-success mb-3">Save All Changes to Existing Rules</button>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Claim Edit Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Edit Text</th><th>Assigned Category (Team)</th><th></th></tr></thead>
                                                <tbody id="existingEditsTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Claim Note Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Full Note Text</th><th>Assigned Category (Team)</th><th></th></tr></thead>
                                                <tbody id="existingNotesTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Modal for Copying Mappings -->
    <div class="modal fade" id="copyMappingModal" tabindex="-1" aria-labelledby="copyMappingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="copyMappingModalLabel">Copy Mappings From Existing Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select a configuration to copy its column mappings into the current form. This will replace any existing mappings in the form.</p>
                    <div class="mb-3">
                        <label for="copySourceConfig" class="form-label">Source Configuration</label>
                        <select id="copySourceConfig" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmCopyBtn">Copy Mappings</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Copying Client Rules -->
    <div class="modal fade" id="copyRulesModal" tabindex="-1" aria-labelledby="copyRulesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="copyRulesModalLabel">Copy Rules From Another Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">This will copy rules from the source client that do not already exist in the current client. It will not overwrite or delete existing rules.</p>
                    <div class="mb-3">
                        <label for="copyRulesSourceConfig" class="form-label fw-bold">1. Select Source Client</label>
                        <select id="copyRulesSourceConfig" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Select Rule Types to Copy</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="copyEditsCheckbox" checked>
                            <label class="form-check-label" for="copyEditsCheckbox">Claim Edit Rules</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="copyNotesCheckbox" checked>
                            <label class="form-check-label" for="copyNotesCheckbox">Claim Note Rules</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmCopyRulesBtn">Confirm Copy</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Custom Widget Creation Modal -->
    <div class="modal fade" id="customWidgetModal" tabindex="-1" aria-labelledby="customWidgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customWidgetModalLabel">Create Custom Report Widget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customWidgetForm">
                        <div class="mb-3">
                            <label for="widgetName" class="form-label">Widget Name</label>
                            <input type="text" class="form-control" id="widgetName" placeholder="e.g., Claims Count by Payer" required>
                        </div>
                        <div class="mb-3">
                            <label for="groupByColumn" class="form-label">Group Data By (Dimension)</label>
                            <select class="form-select" id="groupByColumn" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="metricType" class="form-label">Calculate (Metric)</label>
                            <select class="form-select" id="metricType">
                                <option value="count">Count of Claims</option>
                                <option value="sum">Sum of a Column</option>
                            </select>
                        </div>
                        <div class="mb-3" id="metricColumnContainer" style="display: none;">
                            <label for="metricColumn" class="form-label">Column to Sum</label>
                            <select class="form-select" id="metricColumn"></select>
                        </div>
                        <hr>
                        <h6>PDF Table Headers</h6>
                        <div class="mb-3">
                            <label for="tableHeader1" class="form-label">Header for Grouping Column</label>
                            <input type="text" class="form-control" id="tableHeader1" placeholder="e.g., Payer Name" required>
                        </div>
                        <div class="mb-3">
                            <label for="tableHeader2" class="form-label">Header for Metric Column</label>
                            <input type="text" class="form-control" id="tableHeader2" placeholder="e.g., Number of Claims" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveWidgetBtn">Save Widget</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // API Endpoints
    const CONFIG_API = '/.netlify/functions/configurations', TEAMS_API = '/.netlify/functions/teams', CATEGORIES_API = '/.netlify/functions/categories', RULES_API = '/.netlify/functions/client-rules', CLIENT_TEAM_API = '/.netlify/functions/client-team-associations';
    // NEW: DEDICATED API FOR UNIVERSAL TEAM REPORTS
    const TEAM_REPORTS_API = '/.netlify/functions/team-reports';


    // DOM Elements
    const configForm = document.getElementById('configForm'), configIdInput = document.getElementById('configId'), configNameInput = document.getElementById('configName'), clientNameInput = document.getElementById('clientName'), clearBtn = document.getElementById('clearBtn'), reportUploader = document.getElementById('reportUploader'), mappingSection = document.getElementById('mappingSection'), mappingTableBody = document.getElementById('mappingTableBody'), mappingHeader = document.getElementById('mappingHeader'), mappingAlert = document.getElementById('mapping-alert'), configList = document.getElementById('configList');
    const teamList = document.getElementById('teamList'), newTeamForm = document.getElementById('newTeamForm'), newTeamNameInput = document.getElementById('newTeamName'), teamCategorySelect = document.getElementById('teamCategorySelect'), categoryListContainer = document.getElementById('categoryListContainer'), newCategoryForm = document.getElementById('newCategoryForm'), newCategoryNameInput = document.getElementById('newCategoryName'), l1MonitorCheckbox = document.getElementById('l1MonitorCheckbox');
    const categorizationConfigSelector = document.getElementById('categorizationConfigSelector'), categorizationReportUploader = document.getElementById('categorizationReportUploader'), rulesAssignmentContainer = document.getElementById('rulesAssignmentContainer'), uncategorizedEditsTable = document.getElementById('uncategorizedEditsTable'), uncategorizedNotesTable = document.getElementById('uncategorizedNotesTable'), noRulesFoundDiv = document.getElementById('noRulesFound');
    const existingEditsTableBody = document.getElementById('existingEditsTableBody'), existingNotesTableBody = document.getElementById('existingNotesTableBody'), saveExistingChangesBtn = document.getElementById('saveExistingChangesBtn');
    const pdfReportTitleInput = document.getElementById('pdfReportTitle'), availableWidgetsList = document.getElementById('availableWidgets'), reportLayoutList = document.getElementById('reportLayout');
    const customWidgetForm = document.getElementById('customWidgetForm'), customWidgetModalEl = document.getElementById('customWidgetModal'), customWidgetModal = new bootstrap.Modal(customWidgetModalEl), saveWidgetBtn = document.getElementById('saveWidgetBtn'), metricTypeSelect = document.getElementById('metricType'), metricColumnContainer = document.getElementById('metricColumnContainer');
    const clientTeamConfigSelector = document.getElementById('clientTeamConfigSelector'), clientTeamChecklist = document.getElementById('clientTeamChecklist'), saveClientTeamAssocsBtn = document.getElementById('saveClientTeamAssocsBtn');
    const clientRuleFilter = document.getElementById('clientRuleFilter');
    const w9TriageSection = document.getElementById('w9TriageSection'), triageMrw9Uploader = document.getElementById('triageMrw9Uploader'), triageResultsContainer = document.getElementById('triageResultsContainer'), triagePlaceholder = document.getElementById('triagePlaceholder'), triageTableBody = document.getElementById('triageTableBody'), generateAssignmentReportsBtn = document.getElementById('generateAssignmentReportsBtn'), triageSummary = document.getElementById('triageSummary');
    const copyMappingModalEl = document.getElementById('copyMappingModal'), copyMappingModal = new bootstrap.Modal(copyMappingModalEl), copySourceConfigSelect = document.getElementById('copySourceConfig'), confirmCopyBtn = document.getElementById('confirmCopyBtn');
    const downloadRulesBtn = document.getElementById('downloadRulesBtn');
    const copyRulesBtn = document.getElementById('copyRulesBtn');
    const copyRulesModalEl = document.getElementById('copyRulesModal'), copyRulesModal = new bootstrap.Modal(copyRulesModalEl), copyRulesSourceConfigSelect = document.getElementById('copyRulesSourceConfig'), confirmCopyRulesBtn = document.getElementById('confirmCopyRulesBtn'), copyEditsCheckbox = document.getElementById('copyEditsCheckbox'), copyNotesCheckbox = document.getElementById('copyNotesCheckbox');

    // --- UNIVERSAL TEAM REPORT BUILDER DOM ELEMENTS ---
    const reportBuilderTeam = document.getElementById('reportBuilderTeam'), reportBuilderCategory = document.getElementById('reportBuilderCategory'), builderContainer = document.getElementById('builderContainer'), builderHeader = document.getElementById('builderHeader'), reportBuilderForm = document.getElementById('reportBuilderForm'), teamReportConfigIdInput = document.getElementById('teamReportConfigId'), teamPdfReportTitleInput = document.getElementById('teamPdfReportTitle'), teamReportLayoutList = document.getElementById('teamReportLayout'), teamAvailableWidgetsList = document.getElementById('teamAvailableWidgets'), saveReportLayoutBtn = document.getElementById('saveReportLayoutBtn'), deleteReportLayoutBtn = document.getElementById('deleteReportLayoutBtn');


    // Global State
    let allTeams = [], allCategories = [], allClientConfigs = [], allClientTeamAssociations = [], detectedHeaders = [], columnMappingsForCategorization = {}, mappingsForEditing = {}, currentCustomWidgets = [];
    let activeEditRules = [], activeNoteRules = [];
    let configSpecificRules = { editRulesMap: new Map(), noteRulesMap: new Map() };
    let mainReportFullData = [], triageClaimsData = [];
    let allTeamReportConfigs = []; // NEW: State for universal team report layouts

    // Disable selectors until data is loaded
    clientRuleFilter.disabled = true;
    categorizationConfigSelector.disabled = true;
    clientTeamConfigSelector.disabled = true;
    reportBuilderTeam.disabled = true;

    const standardFields = [
        { key: 'claimId', displayName: 'Claim ID / Number', required: true, type: 'string' }, { key: 'age', displayName: 'Age (in days)', required: true, type: 'number' }, { key: 'netPayment', displayName: 'Net Payment Amount', required: true, type: 'number' }, { key: 'state', displayName: 'Claim State', required: true, type: 'string' }, { key: 'status', displayName: 'Claim Status', required: true, type: 'string' }, { key: 'networkStatus', displayName: 'Network Status', required: true, type: 'string' }, { key: 'providerName', displayName: 'Billing Provider Name', required: true, type: 'string' }, { key: 'edit', displayName: 'Claim Edits', required: true, type: 'string' }, { key: 'notes', displayName: 'Claim Notes', required: true, type: 'string' }, { key: 'totalCharges', displayName: 'Total Billed Amount', required: false, type: 'number' }, { key: 'dsnp', displayName: 'DSNP Status', required: false, type: 'string' }, { key: 'payer', displayName: 'Payer Name', required: false, type: 'string' }, { key: 'claimCategory', displayName: 'Category', required: false, type: 'string' }, { key: 'claimType', displayName: 'Claim Type', required: false, type: 'string' }, { key: 'receivedDate', displayName: 'Received Date', required: false, type: 'date' }, { key: 'billingProviderTaxId', displayName: 'Billing Provider Tax ID', required: false, type: 'string' }, { key: 'billingProviderNpi', displayName: 'Billing Provider NPI', required: false, type: 'string' }, { key: 'patientName', displayName: 'Patient Name', required: false, type: 'string' }, { key: 'subscriberId', displayName: 'Subscriber ID', required: false, type: 'string' }, { key: 'renderingProviderName', displayName: 'Rendering Provider Name', required: false, type: 'string' }, { key: 'renderingProviderNpi', displayName: 'Rendering Provider NPI', required: false, type: 'string' }, { key: 'dosFrom', displayName: 'Date of Service (From)', required: false, type: 'date' }, { key: 'dosTo', displayName: 'Date of Service (To)', required: false, type: 'date' }, { key: 'cleanAge', displayName: 'Clean Age', required: false, type: 'number' }, { key: 'pbpName', displayName: 'PBP Name', required: false, type: 'string' }, { key: 'planName', displayName: 'Plan Name', required: false, type: 'string' }, { key: 'activityLog', displayName: 'Activity Log Description', required: false, type: 'string' }, { key: 'activityUser', displayName: 'Activity Performed By', required: false, type: 'string' }, { key: 'activityDate', displayName: 'Activity Performed On', required: false, type: 'date' }
    ];
    
    const availablePdfWidgets = [
        { id: 'summary', name: 'Executive Summary Cards', type: 'summary' }, { id: 'claimsByFinalStatus', name: 'Claims by Final Status', type: 'table', dataSource: 'claimsByFinalStatus', columns: [{ header: 'Status', dataKey: 'label' }, { header: 'Count', dataKey: 'data' }] }, { id: 'claimsByWorkflowState', name: 'Claims by Workflow State', type: 'table', dataSource: 'claimsByWorkflowState', columns: [{ header: 'State', dataKey: 'label' }, { header: 'Count', dataKey: 'data' }] }, { id: 'topEdits', name: 'Top 10 Claim Edits', type: 'table', dataSource: 'topEdits', columns: [{ header: 'Edit Rule', dataKey: 'label' }, { header: 'Count', dataKey: 'data' }] }, { id: 'topProvidersOverall', name: 'Top 10 Providers (Overall)', type: 'table', dataSource: 'topProvidersOverall', columns: [{ header: 'Provider Name', dataKey: 'label' }, { header: 'Count', dataKey: 'data' }] }, { id: 'agingCombined', name: 'Aging Analysis (Combined)', type: 'aging_table' }, { id: 'agingActive', name: 'Aging Analysis (Active)', type: 'aging_table' }, { id: 'agingPrebatch', name: 'Aging Analysis (Prebatch)', type: 'aging_table' }
    ];
    
    // --- CORE DATA LOADING ---
    async function loadConfigurations() {
        try {
            const response = await fetch(CONFIG_API);
            allClientConfigs = await response.json();
            window.allClientConfigs = allClientConfigs;
            configList.innerHTML = allClientConfigs.length ? '' : '<li class="list-group-item">No configurations found.</li>';
            
            const selectors = [categorizationConfigSelector, clientTeamConfigSelector, clientRuleFilter, copySourceConfigSelect, copyRulesSourceConfigSelect];
            selectors.forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = '<option selected disabled value="">Select a configuration...</option>';
                allClientConfigs.forEach(config => sel.add(new Option(config.config_name, config.id)));
                if(currentVal) sel.value = currentVal;
            });

            allClientConfigs.forEach(config => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                const nameLink = document.createElement('a');
                nameLink.href = '#';
                nameLink.className = 'config-name flex-grow-1';
                nameLink.dataset.configId = config.id;
                nameLink.textContent = config.config_name;
                li.appendChild(nameLink);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteConfig(config.id);
                li.appendChild(deleteBtn);
                configList.appendChild(li);
            });
        } catch (error) { console.error('Error loading configurations:', error); }
    }
    
    async function loadTeams() { const response = await fetch(TEAMS_API); if (response.ok) allTeams = await response.json(); }
    async function loadCategories() { const response = await fetch(CATEGORIES_API); if (response.ok) allCategories = await response.json(); }
    async function loadRulesForConfig(configId) {
        if (!configId) {
            activeEditRules = [];
            activeNoteRules = [];
            return;
        }
        const [editRes, noteRes] = await Promise.all([
            fetch(`${RULES_API}?type=edit&config_id=${configId}`),
            fetch(`${RULES_API}?type=note&config_id=${configId}`)
        ]);
        if (editRes.ok) activeEditRules = await editRes.json();
        if (noteRes.ok) activeNoteRules = await noteRes.json();
    }
    async function loadClientTeamAssociations() { const response = await fetch(CLIENT_TEAM_API); if(response.ok) allClientTeamAssociations = await response.json(); }
    // NEW: Function to load universal team report configs
    async function loadTeamReportConfigs() {
        try {
            const response = await fetch(TEAM_REPORTS_API);
            if(response.ok) allTeamReportConfigs = await response.json();
        } catch (error) {
            console.error('Error loading team report configurations:', error);
        }
    }
    
    async function loadAllData() {
        try {
            await Promise.all([ loadTeams(), loadCategories(), loadConfigurations(), loadClientTeamAssociations(), loadTeamReportConfigs() ]);
            renderTeamList();
            populateTeamDropdown();
            renderCategoryList();
            clientRuleFilter.disabled = false;
            categorizationConfigSelector.disabled = false;
            clientTeamConfigSelector.disabled = false;

            // CORRECTED: Populate the universal team builder dropdown
            reportBuilderTeam.innerHTML = '<option value="">Select a team...</option>';
            allTeams.sort((a,b) => a.team_name.localeCompare(b.team_name)).forEach(team => {
                reportBuilderTeam.add(new Option(team.team_name, team.id));
            });
            reportBuilderTeam.disabled = false;
            
        } catch (error) { console.error("Failed to load initial admin data:", error); alert("Error loading administrative data. Please check the console and refresh the page."); }
    }

    // --- CLIENT CONFIGURATION LOGIC ---
    function editConfig(configId) { 
        const config = (allClientConfigs || []).find(c => c.id === configId); 
        if (!config) return; 
        clearConfigForm(); 
        configIdInput.value = config.id; 
        configNameInput.value = config.config_name; 
        clientNameInput.value = config.config_data.clientName || ''; 
        mappingsForEditing = { ...(config.config_data.columnMappings || {}) }; 
        currentCustomWidgets = config.config_data.pdfConfig?.customWidgets || []; 
        renderMappingsFromObject(mappingsForEditing);
        populateAvailableWidgets(); 
        renderPdfLayout(config.config_data.pdfConfig); 
    }

    function renderMappingUI() { 
        mappingHeader.innerHTML = `Map Your Fields to Detected Headers: <span class="badge bg-secondary">${detectedHeaders.length} columns found</span>`; 
        mappingAlert.classList.add('d-none'); 
        mappingTableBody.innerHTML = ''; 
        standardFields.forEach(field => { 
            const row = mappingTableBody.insertRow(); 
            row.insertCell().innerHTML = `${field.displayName}${field.required ? ' <span class="text-danger">*</span>' : ''}`; 
            const cell2 = row.insertCell(); 
            const select = document.createElement('select'); 
            select.className = 'form-select form-select-sm'; 
            select.dataset.standardKey = field.key; 
            select.add(new Option(field.required ? 'Select header...' : 'Optional', '')); 
            
            const savedMapping = mappingsForEditing[field.key];
            let bestGuess = savedMapping && detectedHeaders.includes(savedMapping) ? savedMapping : '';
            
            detectedHeaders.forEach(header => { 
                const option = new Option(header, header); 
                if (header === bestGuess) option.selected = true; 
                select.add(option); 
            }); 
            cell2.appendChild(select); 
        }); 
        mappingSection.style.display = 'block'; 
    }
    
    function renderMappingsFromObject(mappings) {
        mappingHeader.innerHTML = 'Current Column Mappings';
        mappingAlert.classList.remove('d-none');
        mappingAlert.textContent = 'Upload a file to create new mappings, or copy from another configuration.';
        mappingTableBody.innerHTML = '';
        const allPossibleHeaders = [...new Set(Object.values(mappings))];

        standardFields.forEach(field => {
            const row = mappingTableBody.insertRow();
            row.insertCell().innerHTML = `${field.displayName}${field.required ? ' <span class="text-danger">*</span>' : ''}`;
            const cell2 = row.insertCell();
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm';
            select.dataset.standardKey = field.key;
            select.add(new Option(field.required ? 'Select header...' : 'Optional', ''));
            const savedValue = mappings[field.key];
            allPossibleHeaders.forEach(header => {
                const option = new Option(header, header);
                if(header === savedValue) option.selected = true;
                select.add(option);
            });
            cell2.appendChild(select);
        });
        mappingSection.style.display = 'block';
    }

    async function deleteConfig(id) { 
        if (!confirm('Are you sure you want to delete this configuration? This cannot be undone.')) return; 
        try { 
            await fetch(`${CONFIG_API}?id=${id}`, { method: 'DELETE' }); 
            alert('Configuration deleted successfully.'); 
            loadAllData(); 
        } catch (error) { alert('Failed to delete configuration.'); } 
    }
    
    // --- TEAM & CATEGORY LOGIC ---
    function renderTeamList() { teamList.innerHTML = allTeams.length ? '' : '<li class="list-group-item">No teams defined.</li>'; allTeams.forEach(team => { const li = document.createElement('li'); li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center'; li.textContent = team.team_name; const deleteBtn = document.createElement('button'); deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1 btn-delete-rule'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = () => deleteTeam(team.id); li.appendChild(deleteBtn); teamList.appendChild(li); }); }
    function populateTeamDropdown() { teamCategorySelect.innerHTML = '<option value="">Select a team to add to...</option>'; allTeams.sort((a, b) => a.team_name.localeCompare(b.team_name)).forEach(team => teamCategorySelect.add(new Option(team.team_name, team.id))); }
    async function deleteTeam(id) { if (!confirm('Are you sure? This will unassign categories from this team.')) return; try { await fetch(`${TEAMS_API}?id=${id}`, { method: 'DELETE' }); await loadAllData(); } catch (error) { alert('Failed to delete team.'); } }
    function renderCategoryList() { categoryListContainer.innerHTML = ''; const grouped = allCategories.reduce((acc, cat) => { const teamName = cat.team_name || 'Unassigned'; if (!acc[teamName]) acc[teamName] = []; acc[teamName].push(cat); return acc; }, {}); Object.keys(grouped).sort().forEach(teamName => { const card = document.createElement('div'); card.className = 'card mb-2'; card.innerHTML = `<div class="card-header py-1">${teamName}</div>`; const list = document.createElement('ul'); list.className = 'list-group list-group-flush'; grouped[teamName].sort((a,b) => a.category_name.localeCompare(b.category_name)).forEach(cat => { const li = document.createElement('li'); li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center'; const nameSpan = document.createElement('span'); nameSpan.textContent = cat.category_name; li.appendChild(nameSpan); if (cat.send_to_l1_monitor) { const l1Span = document.createElement('span'); l1Span.className = 'l1-indicator'; l1Span.textContent = '(L1 Monitor)'; nameSpan.appendChild(l1Span); } const deleteBtn = document.createElement('button'); deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1 btn-delete-rule'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = () => deleteCategory(cat.id); li.appendChild(deleteBtn); list.appendChild(li); }); card.appendChild(list); categoryListContainer.appendChild(card); }); }
    async function deleteCategory(id) { if (!confirm('Are you sure? This also deletes associated rules.')) return; try { await fetch(`${CATEGORIES_API}?id=${id}`, { method: 'DELETE' }); await loadAllData(); } catch (error) { alert('Failed to delete category.'); } }
    
    // --- PDF & WIDGET BUILDER LOGIC ---
    function initializeWidgetCreator() { const groupBySelect = document.getElementById('groupByColumn'); const metricColSelect = document.getElementById('metricColumn'); groupBySelect.innerHTML = '<option value="" disabled selected>Select a column...</option>'; metricColSelect.innerHTML = '<option value="" disabled selected>Select a column...</option>'; standardFields.filter(f => f.type === 'string' || f.type === 'date').forEach(field => { groupBySelect.add(new Option(field.displayName, field.key)); }); standardFields.filter(f => f.type === 'number').forEach(field => { metricColSelect.add(new Option(field.displayName, field.key)); }); metricTypeSelect.addEventListener('change', () => { metricColumnContainer.style.display = metricTypeSelect.value === 'sum' ? 'block' : 'none'; }); saveWidgetBtn.addEventListener('click', () => { if (!customWidgetForm.checkValidity()) { customWidgetForm.reportValidity(); return; } const newWidget = { id: `custom_${Date.now()}`, name: document.getElementById('widgetName').value, type: 'custom_table', groupBy: document.getElementById('groupByColumn').value, metricType: document.getElementById('metricType').value, metricColumn: metricTypeSelect.value === 'sum' ? document.getElementById('metricColumn').value : null, columns: [ { header: document.getElementById('tableHeader1').value, dataKey: 'label' }, { header: document.getElementById('tableHeader2').value, dataKey: 'data' } ] }; if(metricTypeSelect.value === 'sum' && !newWidget.metricColumn) { alert('Please select a column to sum.'); return; } currentCustomWidgets.push(newWidget); populateAvailableWidgets(); customWidgetModal.hide(); }); customWidgetModalEl.addEventListener('hidden.bs.modal', () => { customWidgetForm.reset(); metricColumnContainer.style.display = 'none'; }); }
    function populateAvailableWidgets() { availableWidgetsList.innerHTML = ''; const allWidgets = [...availablePdfWidgets, ...currentCustomWidgets]; allWidgets.forEach(widget => { const li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-center'; li.textContent = widget.name; const btnGroup = document.createElement('div'); if (widget.type === 'custom_table') { const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'btn btn-sm btn-outline-danger me-1'; deleteBtn.innerHTML = '<i class="bi bi-trash"></i>'; deleteBtn.onclick = (e) => { e.stopPropagation(); currentCustomWidgets = currentCustomWidgets.filter(w => w.id !== widget.id); populateAvailableWidgets(); }; btnGroup.appendChild(deleteBtn); } const addBtn = document.createElement('button'); addBtn.type = 'button'; addBtn.className = 'btn btn-sm btn-outline-primary'; addBtn.innerHTML = '<i class="bi bi-plus"></i> Add'; addBtn.onclick = () => addWidgetToLayout(widget); btnGroup.appendChild(addBtn); li.appendChild(btnGroup); availableWidgetsList.appendChild(li); }); }
    function addWidgetToLayout(widget, customTitle = '') { if (reportLayoutList.querySelector('.text-muted')) { reportLayoutList.innerHTML = ''; } const li = document.createElement('li'); li.className = 'list-group-item pdf-widget'; li.dataset.widgetId = widget.id; li.innerHTML = `<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">${widget.name}</span><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">&times;</button></div><input type="text" class="form-control form-control-sm mt-2" value="${customTitle}" placeholder="Enter custom title (optional)">`; reportLayoutList.appendChild(li); }
    function renderPdfLayout(pdfConfig) { reportLayoutList.innerHTML = ''; pdfReportTitleInput.value = pdfConfig?.reportTitle || ''; if (pdfConfig?.sections?.length > 0) { pdfConfig.sections.forEach(section => { const allWidgets = [...availablePdfWidgets, ...currentCustomWidgets]; const baseWidget = allWidgets.find(w => w.id === section.id); if (baseWidget) { addWidgetToLayout(baseWidget, section.title); } }); } else { reportLayoutList.innerHTML = '<li class="list-group-item text-muted">Add widgets from the left.</li>'; } }
    function serializePdfLayout() { const sections = Array.from(reportLayoutList.querySelectorAll('.pdf-widget')).map(li => { const widgetId = li.dataset.widgetId; const allWidgets = [...availablePdfWidgets, ...currentCustomWidgets]; const baseWidget = allWidgets.find(w => w.id === widgetId); const customTitle = li.querySelector('input').value.trim(); const definition = baseWidget.type === 'custom_table' ? baseWidget : null; return { id: widgetId, type: baseWidget.type, title: customTitle || baseWidget.name, definition }; }); return { reportTitle: pdfReportTitleInput.value.trim() || '{clientName} Daily Summary Report {date}', customWidgets: currentCustomWidgets, sections }; }

    // --- RULE MANAGEMENT LOGIC ---
    function processUploadedReport(data) {
        const detectedEdits = new Set(), detectedNotes = new Set();
        const { edit: editColumn, notes: notesColumn } = columnMappingsForCategorization;
        data.forEach(row => {
            const editValue = (row[editColumn] || '').toString().trim();
            if (editValue && !activeEditRules.some(r => r.text === editValue)) detectedEdits.add(editValue);
            const noteValue = (row[notesColumn] || '').toString().trim();
            if (noteValue && !activeNoteRules.some(r => r.text === noteValue)) detectedNotes.add(noteValue);
        });
        const sortedEdits = Array.from(detectedEdits).sort((a, b) => a.localeCompare(b));
        const sortedNotes = Array.from(detectedNotes).sort((a, b) => a.localeCompare(b));
        uncategorizedEditsTable.innerHTML = '';
        sortedEdits.forEach(text => { const row = uncategorizedEditsTable.insertRow(); row.insertCell().innerHTML = `<div class="rule-text" title="${text}">${text}</div>`; row.cells[0].firstChild.dataset.text = text; row.insertCell().innerHTML = createCategoryDropdown().outerHTML; });
        uncategorizedNotesTable.innerHTML = '';
        sortedNotes.forEach(noteText => { const row = uncategorizedNotesTable.insertRow(); row.insertCell().innerHTML = `<div class="rule-text" title="${noteText}">${noteText}</div>`; row.cells[0].firstChild.dataset.text = noteText; row.insertCell().innerHTML = createCategoryDropdown().outerHTML; });
        const hasRules = sortedEdits.length > 0 || sortedNotes.length > 0;
        rulesAssignmentContainer.style.display = hasRules ? 'block' : 'none';
        noRulesFoundDiv.textContent = hasRules ? '' : 'No new, uncategorized items were found in the uploaded file.';
        noRulesFoundDiv.style.display = hasRules ? 'none' : 'block';
    }
    function createCategoryDropdown(selectedId = '') { const select = document.createElement('select'); select.className = 'form-select form-select-sm'; select.add(new Option('Select category...', '')); allCategories.sort((a,b) => (a.team_name || 'Z').localeCompare(b.team_name || 'Z') || a.category_name.localeCompare(b.category_name)).forEach(cat => select.add(new Option(`${cat.team_name || 'Unassigned'} -> ${cat.category_name}`, cat.id))); if (selectedId) { select.value = selectedId; } return select; }
    async function saveNewRules() {
        const configId = categorizationConfigSelector.value;
        if (!configId) return alert('Cannot save rules without a selected configuration.');
        const getRulesFromTable = (table) => Array.from(table.rows).map(row => ({ row: row, text: row.querySelector('.rule-text').dataset.text, category_id: row.cells[1].querySelector('select').value })).filter(rule => rule.category_id);
        const editRulesToSave = getRulesFromTable(uncategorizedEditsTable);
        const noteRulesToSave = getRulesFromTable(uncategorizedNotesTable);
        if (editRulesToSave.length === 0 && noteRulesToSave.length === 0) return alert('No new rules were assigned to a category.');
        try {
            const bodyEdit = JSON.stringify(editRulesToSave.map(({ row, ...rest }) => rest));
            const bodyNote = JSON.stringify(noteRulesToSave.map(({ row, ...rest }) => rest));
            await Promise.all([
                editRulesToSave.length > 0 ? fetch(`${RULES_API}?type=edit&config_id=${configId}`, { method: 'POST', body: bodyEdit }) : Promise.resolve(),
                noteRulesToSave.length > 0 ? fetch(`${RULES_API}?type=note&config_id=${configId}`, { method: 'POST', body: bodyNote }) : Promise.resolve()
            ]);
            alert('Rules saved successfully!');
            editRulesToSave.forEach(rule => rule.row.remove());
            noteRulesToSave.forEach(rule => rule.row.remove());
            await loadRulesForConfig(configId);
            if (uncategorizedEditsTable.rows.length === 0 && uncategorizedNotesTable.rows.length === 0) {
                rulesAssignmentContainer.style.display = 'none';
                noRulesFoundDiv.textContent = 'Upload a file to begin.';
                noRulesFoundDiv.style.display = 'block';
            }
        } catch (error) { alert(`Failed to save rules: ${error.message}`); }
    }
    
    function renderExistingRulesTables(editRules = [], noteRules = []) {
        const renderTable = (tableBody, rules) => {
            tableBody.innerHTML = '';
            rules.sort((a, b) => a.text.localeCompare(b.text)).forEach(rule => {
                const row = tableBody.insertRow();
                row.dataset.text = rule.text;
                row.insertCell().innerHTML = `<div class="rule-text" title="${rule.text}">${rule.text}</div>`;
                const categoryCell = row.insertCell();
                categoryCell.innerHTML = createCategoryDropdown(rule.category_id).outerHTML;
                row.insertCell().innerHTML = `<button class="btn btn-danger btn-sm py-0 px-1 btn-delete-rule" data-type="${tableBody.id.includes('Edits') ? 'edit' : 'note'}" data-text="${encodeURIComponent(rule.text)}">&times;</button>`;
            });
        };
        renderTable(existingEditsTableBody, editRules);
        renderTable(existingNotesTableBody, noteRules);
    }

    async function deleteRule(type, text) {
        const configId = clientRuleFilter.value;
        if (!configId) return alert('Please select a specific client to delete a rule from.');
        if (!confirm(`Are you sure you want to delete this rule?\n\nTYPE: ${type}\nRULE: ${text}`)) return;
        try {
            const response = await fetch(`${RULES_API}?type=${type}&config_id=${configId}`, { method: 'DELETE', body: JSON.stringify({ text }) });
            if (!response.ok) throw new Error('Delete failed on server.');
            await loadRulesForConfig(configId);
            renderExistingRulesTables(activeEditRules, activeNoteRules);
            alert('Rule deleted.');
        } catch(error) { alert(`Error deleting rule: ${error.message}`); }
    };
    async function saveExistingRuleChanges() {
        const configId = clientRuleFilter.value;
        if (!configId) return alert('Please select a specific client to save changes for.');
        const getChangedRules = (tableBody) => Array.from(tableBody.rows).map(row => ({ text: row.dataset.text, category_id: row.querySelector('select').value }));
        const editRulesToUpdate = getChangedRules(existingEditsTableBody);
        const noteRulesToUpdate = getChangedRules(existingNotesTableBody);
        try {
            await Promise.all([
                editRulesToUpdate.length > 0 ? fetch(`${RULES_API}?type=edit&config_id=${configId}`, { method: 'POST', body: JSON.stringify(editRulesToUpdate) }) : Promise.resolve(),
                noteRulesToUpdate.length > 0 ? fetch(`${RULES_API}?type=note&config_id=${configId}`, { method: 'POST', body: JSON.stringify(noteRulesToUpdate) }) : Promise.resolve()
            ]);
            alert('Existing rule changes saved successfully!');
            await loadRulesForConfig(configId);
            renderExistingRulesTables(activeEditRules, activeNoteRules);
        } catch(error) { alert(`Error saving changes: ${error.message}`); }
    }
    function clearConfigForm() { configForm.reset(); configIdInput.value = ''; mappingSection.style.display = 'none'; mappingAlert.classList.add('d-none'); mappingsForEditing = {}; reportUploader.value = ''; currentCustomWidgets = []; populateAvailableWidgets(); renderPdfLayout({}); }
    function readFile(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); resolve(jsonData); } catch (err) { reject(err); } }; reader.onerror = (err) => reject(err); reader.readAsArrayBuffer(file); }); }
    
    // --- W9 TRIAGE LOGIC (INTEGRATED) ---
    const getAdminVal = (claim, standardKey) => { const mappedKey = columnMappingsForCategorization[standardKey]; return (mappedKey && claim[mappedKey] !== undefined) ? claim[mappedKey] : undefined; };
    function getTriageClaimCategory(claim) {
        const notes = (getAdminVal(claim, 'notes') || '').toLowerCase();
        const edit = getAdminVal(claim, 'edit');
        if (edit && configSpecificRules.editRulesMap.has(edit)) { return configSpecificRules.editRulesMap.get(edit); }
        if (notes) { for (const [keyword, rule] of configSpecificRules.noteRulesMap.entries()) { if (notes.includes(keyword)) return rule; } }
        return { category: 'Needs Triage', teamName: 'Needs Assignment' };
    }
    async function handleTriageMRW9File(event) {
        const file = event.target.files[0];
        if (!file || mainReportFullData.length === 0) return;
        try {
            const mrw9Data = await readFile(file);
            const headers = Object.keys(mrw9Data[0] || {});
            const findHeader = (possibleNames) => { const lowerCaseNames = possibleNames.map(n => n.toLowerCase()); return headers.find(h => lowerCaseNames.includes(h.toLowerCase().trim())); };
            const w9AttachedKey = findHeader(['w9 attached in pv (yes/no)']);
            const taxIdKey = findHeader(['billing tax id']);
            const claimIdKeyMRW9 = findHeader(['claim id']);
            let missingHeaders = [];
            if (!w9AttachedKey) missingHeaders.push("'W9 Attached in PV (YES/NO)'");
            if (!taxIdKey) missingHeaders.push("'Billing TAX ID'");
            if (!claimIdKeyMRW9) missingHeaders.push("'Claim ID'");
            if (missingHeaders.length > 0) { alert(`The MRW9 report is missing the following required columns: ${missingHeaders.join(', ')}. Please check the file and try again.`); event.target.value = ''; return; }
            const mrw9ClaimMap = new Map();
            const tinStatusMap = new Map();
            mrw9Data.forEach(row => {
                const claimId = row[claimIdKeyMRW9]?.toString().trim();
                const tin = row[taxIdKey]?.toString().trim();
                const w9Status = (row[w9AttachedKey] || '').toString().trim().toUpperCase();
                if (claimId) mrw9ClaimMap.set(claimId, row);
                if (tin && w9Status === 'YES') tinStatusMap.set(tin, 'YES');
            });
            const filteredClaims = mainReportFullData.filter(mainClaim => {
                const claimId = getAdminVal(mainClaim, 'claimId')?.toString().trim();
                if (!claimId || !mrw9ClaimMap.has(claimId)) return false;
                const status = (getAdminVal(mainClaim, 'status') || '').toUpperCase();
                const categoryInfo = getTriageClaimCategory(mainClaim);
                const teamName = categoryInfo.teamName;
                const categoryName = (categoryInfo.category || '').toUpperCase();
                return status === 'MANAGEMENTREVIEW' && teamName === 'Provider Operations' && categoryName.includes('W9');
            });
            triageClaimsData = filteredClaims.map(claim => { const tin = getAdminVal(claim, 'billingProviderTaxId')?.toString().trim(); const hasW9 = tin && tinStatusMap.has(tin) ? 'YES' : 'NO'; return { claimId: getAdminVal(claim, 'claimId'), providerName: getAdminVal(claim, 'providerName'), providerTin: tin, tinHasW9: hasW9, original: claim }; });
            renderTriageTable();
        } catch (error) { alert(`Error processing MRW9 file: ${error.message}`); }
    }
    function renderTriageTable() {
        if (triageClaimsData.length === 0) { triageSummary.textContent = 'No claims matching the triage criteria (i.e., present in both reports, with Status: Management Review, Team: Provider Ops, Category: *W9* as per the selected client\'s rules) were found.'; } else { triageSummary.textContent = `Found ${triageClaimsData.length} claims to triage. Default assignments have been suggested below.`; }
        triageTableBody.innerHTML = '';
        triageClaimsData.forEach((claim, index) => { const row = triageTableBody.insertRow(); row.insertCell().textContent = claim.claimId; row.insertCell().textContent = claim.providerName; row.insertCell().textContent = claim.providerTin; const hasW9Cell = row.insertCell(); hasW9Cell.textContent = claim.tinHasW9; hasW9Cell.style.fontWeight = 'bold'; hasW9Cell.style.color = claim.tinHasW9 === 'YES' ? '#198754' : '#dc3545'; const actionCell = row.insertCell(); const select = document.createElement('select'); select.className = 'form-select form-select-sm'; select.dataset.index = index; select.innerHTML = `<option value="prov_ops">Assign to Provider Ops</option><option value="l1_monitor">Assign to L1 Monitor</option>`; select.value = claim.tinHasW9 === 'YES' ? 'l1_monitor' : 'prov_ops'; actionCell.appendChild(select); });
        triageResultsContainer.classList.remove('d-none');
        triagePlaceholder.classList.add('d-none');
    }
    function generateTriageReports() {
        const providerOpsClaims = [];
        const l1MonitorClaims = [];
        triageTableBody.querySelectorAll('select').forEach(select => { const index = parseInt(select.dataset.index, 10); const claimData = triageClaimsData[index]; if (select.value === 'prov_ops') providerOpsClaims.push(claimData.original); else l1MonitorClaims.push(claimData.original); });
        let generatedCount = 0;
        if (providerOpsClaims.length > 0) { const ws = XLSX.utils.json_to_sheet(providerOpsClaims); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Provider Ops Assignments'); XLSX.writeFile(wb, 'Provider_Ops_W9_Assignments.xlsx'); generatedCount++; }
        if (l1MonitorClaims.length > 0) { const ws = XLSX.utils.json_to_sheet(l1MonitorClaims); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'L1 Monitor Assignments'); XLSX.writeFile(wb, 'L1_Monitor_W9_Assignments.xlsx'); generatedCount++; }
        if (generatedCount === 0) alert("No claims were available to generate reports.");
        else alert("Assignment reports generated successfully.");
    }
    
    // --- REWRITTEN: UNIVERSAL TEAM REPORT BUILDER LOGIC ---
    function populateTeamBuilderAvailableWidgets() {
        teamAvailableWidgetsList.innerHTML = '';
        // Combine default widgets and any custom widgets created in the main config form
        const allWidgets = [...availablePdfWidgets, ...currentCustomWidgets];
        allWidgets.forEach(widget => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = widget.name;
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'btn btn-sm btn-outline-primary';
            addBtn.innerHTML = '<i class="bi bi-plus"></i> Add';
            addBtn.onclick = () => addWidgetToTeamLayout(widget);
            li.appendChild(addBtn);
            teamAvailableWidgetsList.appendChild(li);
        });
    }

    function addWidgetToTeamLayout(widget, customTitle = '') {
        if (teamReportLayoutList.querySelector('.text-muted')) {
            teamReportLayoutList.innerHTML = '';
        }
        const li = document.createElement('li');
        li.className = 'list-group-item pdf-widget';
        li.dataset.widgetId = widget.id;
        li.innerHTML = `<div class="d-flex justify-content-between align-items-center"><span class="fw-bold">${widget.name}</span><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">&times;</button></div><input type="text" class="form-control form-control-sm mt-2" value="${customTitle}" placeholder="Enter custom title (optional)">`;
        teamReportLayoutList.appendChild(li);
    }

    function renderTeamPdfLayout(layout) {
        teamReportLayoutList.innerHTML = '';
        teamPdfReportTitleInput.value = layout?.reportTitle || '';
        if (layout?.sections?.length > 0) {
            const allWidgets = [...availablePdfWidgets, ...currentCustomWidgets];
            layout.sections.forEach(section => {
                const baseWidget = allWidgets.find(w => w.id === section.id);
                if (baseWidget) {
                    addWidgetToTeamLayout(baseWidget, section.title);
                }
            });
        } else {
            teamReportLayoutList.innerHTML = '<li class="list-group-item text-muted">Add widgets from the right.</li>';
        }
    }
    
    async function saveTeamReportLayout() {
        const teamId = reportBuilderTeam.value;
        const categoryId = reportBuilderCategory.value;
        const configId = teamReportConfigIdInput.value;
        if (!teamId || !categoryId) return alert('A team and category must be selected.');

        const sections = Array.from(teamReportLayoutList.querySelectorAll('.pdf-widget')).map(li => ({
            id: li.dataset.widgetId,
            title: li.querySelector('input').value.trim()
        }));

        const report_config_data = {
            reportTitle: teamPdfReportTitleInput.value.trim(),
            sections
        };
        
        const method = configId ? 'PUT' : 'POST';
        const url = configId ? `${TEAM_REPORTS_API}?id=${configId}` : TEAM_REPORTS_API;
        
        try {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ team_id: teamId, category_id: categoryId, report_config_data })
            });
            if (!res.ok) throw new Error(`Server responded with ${res.status}`);
            
            alert('Team report layout saved successfully!');
            await loadTeamReportConfigs(); // Refresh local data
            
            // Manually re-trigger the change event to reload the UI with the saved data
            reportBuilderCategory.dispatchEvent(new Event('change'));

        } catch (error) {
            console.error('Failed to save team report layout:', error);
            alert(`Failed to save layout: ${error.message}`);
        }
    }

    async function deleteTeamReportLayout() {
        const configId = teamReportConfigIdInput.value;
        if (!configId) return;
        if (!confirm('Are you sure you want to delete this report layout?')) return;
        
        try {
            const res = await fetch(`${TEAM_REPORTS_API}?id=${configId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(`Server responded with ${res.status}`);
            alert('Report layout deleted.');
            await loadTeamReportConfigs();
            // Reset UI
            builderContainer.classList.add('d-none');
            reportBuilderCategory.value = '';
        } catch (error) {
            console.error('Failed to delete team report layout:', error);
            alert(`Failed to delete layout: ${error.message}`);
        }
    }


    // --- EVENT LISTENERS ---
    configList.addEventListener('click', (e) => { if (e.target.classList.contains('config-name')) { e.preventDefault(); const configId = parseInt(e.target.dataset.configId, 10); editConfig(configId); } });
    configForm.addEventListener('submit', async (e) => { e.preventDefault(); const columnMappings = {}; mappingTableBody.querySelectorAll('select').forEach(sel => { if (sel.value) columnMappings[sel.dataset.standardKey] = sel.value; }); const id = configIdInput.value; const pdfConfig = serializePdfLayout(); let config_data = { clientName: clientNameInput.value, columnMappings, pdfConfig }; if(id){ const existingConfig = allClientConfigs.find(c=>c.id==id); if(existingConfig?.config_data?.teamReportLayouts){ config_data.teamReportLayouts = existingConfig.config_data.teamReportLayouts; } } const method = id ? 'PUT' : 'POST'; const url = id ? `${CONFIG_API}?id=${id}` : CONFIG_API; try { const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config_name: configNameInput.value, config_data }) }); if(!res.ok) throw new Error(`Server responded with ${res.status}`); alert(`Configuration ${id ? 'updated' : 'created'} successfully!`); clearConfigForm(); await loadAllData(); } catch (error) { console.error('Failed to save config:', error); alert(`Failed to save configuration: ${error.message}`); } });
    reportUploader.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; readFile(file).then(data => { const headers = Object.keys(data[0] || {}); detectedHeaders = headers.filter(h => h != null && h.toString().trim() !== ''); if (detectedHeaders.length === 0) { alert("Could not detect any column headers in the uploaded file."); return; } mappingsForEditing = {}; renderMappingUI(); }).catch(err => alert(`Error processing file: ${err.message}`)); });
    clearBtn.addEventListener('click', clearConfigForm);
    
    newTeamForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = newTeamNameInput.value.trim(); if (!name) return; try { const response = await fetch(TEAMS_API, { method: 'POST', body: JSON.stringify({ team_name: name }) }); if (!response.ok) throw new Error('Failed to add team.'); newTeamNameInput.value = ''; await loadAllData(); } catch (error) { alert(error.message); } });
    newCategoryForm.addEventListener('submit', async (e) => { e.preventDefault(); const category_name = newCategoryNameInput.value.trim(); const team_id = parseInt(teamCategorySelect.value, 10); const send_to_l1_monitor = l1MonitorCheckbox.checked; if (!category_name || !team_id) return alert('Please select a team and enter a category name.'); try { const response = await fetch(CATEGORIES_API, { method: 'POST', body: JSON.stringify({ category_name, team_id, send_to_l1_monitor }) }); if (!response.ok) throw new Error('Failed to add category.'); newCategoryNameInput.value = ''; l1MonitorCheckbox.checked = false; await loadAllData(); } catch (error) { alert(error.message); } });

    categorizationConfigSelector.addEventListener('change', async () => { 
        const selectedId = parseInt(categorizationConfigSelector.value, 10); 
        if (!selectedId) { categorizationReportUploader.disabled = true; return; }
        await loadRulesForConfig(selectedId);
        const config = (allClientConfigs || []).find(c => c.id === selectedId); 
        if (config?.config_data?.columnMappings) { 
            columnMappingsForCategorization = config.config_data.columnMappings; 
            const hasRequiredCols = columnMappingsForCategorization.edit && columnMappingsForCategorization.notes; 
            categorizationReportUploader.disabled = !hasRequiredCols; 
            if(!hasRequiredCols) alert('Selected config must map both "Claim Edits" and "Claim Notes" to discover new rules.');
            
            const getRuleDetails = (rule) => { const cat = allCategories.find(c => c.id === rule.category_id); return cat ? { ...rule, team_name: cat.team_name, category_name: cat.category_name } : null; };
            configSpecificRules.editRulesMap = new Map(activeEditRules.map(getRuleDetails).filter(Boolean).map(r => [r.text, { category: r.category_name, teamName: r.team_name }]));
            configSpecificRules.noteRulesMap = new Map(activeNoteRules.map(getRuleDetails).filter(Boolean).map(r => [r.text, { category: r.category_name, teamName: r.team_name }]));

            w9TriageSection.style.display = 'none'; triageMrw9Uploader.value = ''; triageResultsContainer.classList.add('d-none'); triageTableBody.innerHTML = '';
        } 
    });

    categorizationReportUploader.addEventListener('change', async (event) => { 
        const file = event.target.files[0]; if (!file) return; 
        try {
            mainReportFullData = await readFile(file);
            processUploadedReport(mainReportFullData);
            w9TriageSection.style.display = 'block'; triagePlaceholder.style.display = 'block'; triageResultsContainer.classList.add('d-none'); triageMrw9Uploader.value = '';
        } catch(error) { alert(`Error processing main report: ${error.message}`); }
    });

    document.querySelectorAll('.save-rules-btn').forEach(btn => btn.addEventListener('click', saveNewRules));
    saveExistingChangesBtn.addEventListener('click', saveExistingRuleChanges);
    document.getElementById('manage-pane').addEventListener('click', (e) => { if (e.target.classList.contains('btn-delete-rule')) { const type = e.target.dataset.type; const text = decodeURIComponent(e.target.dataset.text); deleteRule(type, text); } });
    
    clientTeamConfigSelector.addEventListener('change', async (e) => {
        const configId = e.target.value; if (!configId) { clientTeamChecklist.innerHTML = '<small class="text-muted">Select a client to see teams.</small>'; return; }
        const response = await fetch(`${CLIENT_TEAM_API}?config_id=${configId}`); const associatedTeamIds = await response.json(); const teamIdSet = new Set(associatedTeamIds);
        clientTeamChecklist.innerHTML = '';
        allTeams.sort((a,b) => a.team_name.localeCompare(b.team_name)).forEach(team => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `<input class="form-check-input" type="checkbox" value="${team.id}" id="team_check_${team.id}" ${teamIdSet.has(team.id) ? 'checked' : ''}><label class="form-check-label" for="team_check_${team.id}">${team.team_name}</label>`;
            clientTeamChecklist.appendChild(div);
        });
    });

    saveClientTeamAssocsBtn.addEventListener('click', async () => {
        const config_id = clientTeamConfigSelector.value; if (!config_id) { alert("Please select a client first."); return; }
        const team_ids = Array.from(clientTeamChecklist.querySelectorAll('input:checked')).map(input => parseInt(input.value, 10));
        try {
            await fetch(CLIENT_TEAM_API, { method: 'POST', body: JSON.stringify({ config_id: parseInt(config_id, 10), team_ids }) });
            alert("Client-Team associations saved successfully.");
        } catch (error) { alert(`Failed to save associations: ${error.message}`); }
    });

    clientRuleFilter.addEventListener('change', async (e) => {
        const configId = e.target.value;
        if (!configId) { renderExistingRulesTables([], []); downloadRulesBtn.disabled = true; copyRulesBtn.disabled = true; return; }
        try {
            await loadRulesForConfig(configId);
            renderExistingRulesTables(activeEditRules, activeNoteRules);
            downloadRulesBtn.disabled = false;
            copyRulesBtn.disabled = false;
            copyRulesSourceConfigSelect.innerHTML = '<option value="" selected disabled>Select a source client...</option>';
            allClientConfigs.filter(c => c.id != configId).forEach(c => copyRulesSourceConfigSelect.add(new Option(c.config_name, c.id)));
        } catch (error) { alert('Failed to load rules for this client.'); console.error(error); }
    });

    confirmCopyBtn.addEventListener('click', () => {
        const sourceId = copySourceConfigSelect.value;
        if (!sourceId) return alert('Please select a source configuration.');
        const sourceConfig = allClientConfigs.find(c => c.id == sourceId);
        if (sourceConfig && sourceConfig.config_data.columnMappings) { mappingsForEditing = { ...sourceConfig.config_data.columnMappings }; renderMappingsFromObject(mappingsForEditing); copyMappingModal.hide(); } 
        else { alert('The selected source configuration has no mappings to copy.'); }
    });
    downloadRulesBtn.addEventListener('click', () => {
        const configId = clientRuleFilter.value;
        const config = allClientConfigs.find(c => c.id == configId);
        if (!config || (activeEditRules.length === 0 && activeNoteRules.length === 0)) { return alert('No rules to download for the selected client.'); }
        const getCategoryInfo = (catId) => { const cat = allCategories.find(c => c.id === catId); return cat ? `${cat.category_name} (${cat.team_name || 'Unassigned'})` : 'N/A'; };
        const editData = activeEditRules.map(rule => ({ 'Rule Text': rule.text, 'Assigned Category (Team)': getCategoryInfo(rule.category_id) }));
        const noteData = activeNoteRules.map(rule => ({ 'Rule Text': rule.text, 'Assigned Category (Team)': getCategoryInfo(rule.category_id) }));
        const wb = XLSX.utils.book_new();
        if (editData.length > 0) { const wsEdit = XLSX.utils.json_to_sheet(editData); wsEdit['!cols'] = [{ wch: 50 }, { wch: 50 }]; XLSX.utils.book_append_sheet(wb, wsEdit, 'Claim Edit Rules'); }
        if (noteData.length > 0) { const wsNote = XLSX.utils.json_to_sheet(noteData); wsNote['!cols'] = [{ wch: 80 }, { wch: 50 }]; XLSX.utils.book_append_sheet(wb, wsNote, 'Claim Note Rules'); }
        const clientName = config.config_name.replace(/ /g, '_');
        XLSX.writeFile(wb, `${clientName}_Categorization_Rules.xlsx`);
    });
    confirmCopyRulesBtn.addEventListener('click', async () => {
        const targetConfigId = clientRuleFilter.value;
        const sourceConfigId = copyRulesSourceConfigSelect.value;
        if(!targetConfigId || !sourceConfigId) return alert('Please select both a source and target client.');
        if(!copyEditsCheckbox.checked && !copyNotesCheckbox.checked) return alert('Please select at least one rule type to copy.');
        let sourceEditRules = [], sourceNoteRules = [];
        const [editRes, noteRes] = await Promise.all([ fetch(`${RULES_API}?type=edit&config_id=${sourceConfigId}`), fetch(`${RULES_API}?type=note&config_id=${sourceConfigId}`) ]);
        if (editRes.ok) sourceEditRules = await editRes.json();
        if (noteRes.ok) sourceNoteRules = await noteRes.json();
        const existingEditTexts = new Set(activeEditRules.map(r => r.text));
        const existingNoteTexts = new Set(activeNoteRules.map(r => r.text));
        const newEditRules = copyEditsCheckbox.checked ? sourceEditRules.filter(r => !existingEditTexts.has(r.text)) : [];
        const newNoteRules = copyNotesCheckbox.checked ? sourceNoteRules.filter(r => !existingNoteTexts.has(r.text)) : [];
        if (newEditRules.length === 0 && newNoteRules.length === 0) { alert('No new rules to copy. The target client already has all the rules from the source.'); return; }
        try {
            await Promise.all([
                newEditRules.length > 0 ? fetch(`${RULES_API}?type=edit&config_id=${targetConfigId}`, { method: 'POST', body: JSON.stringify(newEditRules) }) : Promise.resolve(),
                newNoteRules.length > 0 ? fetch(`${RULES_API}?type=note&config_id=${targetConfigId}`, { method: 'POST', body: JSON.stringify(newNoteRules) }) : Promise.resolve()
            ]);
            alert(`Successfully copied ${newEditRules.length} edit rule(s) and ${newNoteRules.length} note rule(s).`);
            copyRulesModal.hide();
            await loadRulesForConfig(targetConfigId);
            renderExistingRulesTables(activeEditRules, activeNoteRules);
        } catch (error) { alert(`An error occurred while copying rules: ${error.message}`); }
    });
    
    // --- REWRITTEN/NEW EVENT LISTENERS for Universal Team Report Builder ---
    reportBuilderTeam.addEventListener('change', () => {
        const teamId = parseInt(reportBuilderTeam.value, 10);
        builderContainer.classList.add('d-none');
        reportBuilderCategory.innerHTML = '<option>Select a team...</option>';
        reportBuilderCategory.disabled = true;
        if (!teamId) return;
        
        const categoriesForTeam = allCategories.filter(c => c.team_id === teamId);
        reportBuilderCategory.innerHTML = '<option value="">Select a category...</option>';
        categoriesForTeam.sort((a,b) => a.category_name.localeCompare(b.category_name)).forEach(cat => {
            reportBuilderCategory.add(new Option(cat.category_name, cat.id));
        });
        reportBuilderCategory.disabled = false;
    });

    reportBuilderCategory.addEventListener('change', () => {
        const teamId = reportBuilderTeam.value;
        const categoryId = reportBuilderCategory.value;
        
        builderContainer.classList.add('d-none');
        reportBuilderForm.reset();
        teamReportConfigIdInput.value = ''; // Clear the hidden ID input

        if (!teamId || !categoryId) return;
        
        const team = allTeams.find(t => t.id == teamId);
        const category = allCategories.find(c => c.id == categoryId);
        if (!team || !category) return;
        
        builderHeader.textContent = `Building Universal Report For: ${team.team_name}  ${category.category_name}`;
        
        const existingConfig = allTeamReportConfigs.find(c => c.team_id == teamId && c.category_id == categoryId);
        
        if (existingConfig) {
            teamReportConfigIdInput.value = existingConfig.id;
            renderTeamPdfLayout(existingConfig.report_config_data);
            deleteReportLayoutBtn.disabled = false;
        } else {
            renderTeamPdfLayout(null); // Clear the layout for a new config
            deleteReportLayoutBtn.disabled = true;
        }
        
        // Populate the available widgets every time, as the custom widgets list might have changed
        populateTeamBuilderAvailableWidgets();
        builderContainer.classList.remove('d-none');
    });

    saveReportLayoutBtn.addEventListener('click', saveTeamReportLayout);
    deleteReportLayoutBtn.addEventListener('click', deleteTeamReportLayout);

    // Integrated Triage Event Listeners
    triageMrw9Uploader.addEventListener('change', handleTriageMRW9File);
    generateAssignmentReportsBtn.addEventListener('click', generateTriageReports);

    // --- INITIAL PAGE LOAD ---
    loadAllData();
    initializeWidgetCreator();
    populateAvailableWidgets();
});
</script>
</body>
</html>
