<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .mapping-table th { width: 30%; }
        .list-group-item h6 { margin-bottom: 0; }
        .table-responsive-sm { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Admin Console</h1>
            <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
        </div>
        
        <!-- Client Configuration Management Card (No changes) -->
        <div class="row g-5">
            <div class="col-12">
                <div class="card">
                     <div class="card-body">
                        <h2>Client Configurations</h2>
                         <div class="row">
                            <div class="col-md-7">
                                <form id="configForm">
                                    <input type="hidden" id="configId">
                                    <h5>Step 1: Basic Information</h5>
                                    <div class="mb-3"><label for="configName" class="form-label">Configuration Name</label><input type="text" class="form-control" id="configName" required></div>
                                    <div class="mb-3"><label for="clientName" class="form-label">Client Name (for PDF Reports)</label><input type="text" class="form-control" id="clientName"></div>
                                    <hr>
                                    <h5>Step 2: Upload to Map Columns</h5>
                                     <div class="mb-3"><label for="reportUploader" class="form-label">Upload XLSX File</label><input class="form-control" type="file" id="reportUploader" accept=".xlsx"></div>
                                    <div id="mappingSection" class="mt-4" style="display: none;">
                                        <h6>Map Your Fields to Detected Headers:</h6>
                                        <table class="table table-bordered table-sm mapping-table">
                                            <thead class="table-light"><tr><th>Standard Field</th><th>Client's Column Header</th></tr></thead>
                                            <tbody id="mappingTableBody"></tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                    <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                                </form>
                            </div>
                            <div class="col-md-5">
                                <h5>Existing Configurations</h5>
                                <ul class="list-group" id="configList"></ul>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Categorization Rules Section -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Global Categorization & Team Management</h2>
                        <p class="text-muted">Manage teams, define categories for each team, and create rules to automatically assign claims.</p>
                        
                        <!-- NEW: TABS FOR RULE MANAGEMENT -->
                        <ul class="nav nav-tabs" id="ruleTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover-pane" type="button" role="tab">Discover & Assign New Rules</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-pane" type="button" role="tab">Manage Existing Rules</button>
                            </li>
                        </ul>

                        <div class="tab-content pt-3">
                            <!-- DISCOVER NEW RULES PANE -->
                            <div class="tab-pane fade show active" id="discover-pane" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h5>1. Manage Teams & Categories</h5>
                                        <h6>Teams</h6>
                                        <ul class="list-group mb-3" id="teamList"></ul>
                                        <form id="newTeamForm" class="d-flex mb-4"><input type="text" id="newTeamName" class="form-control me-2" placeholder="New Team Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></form>
                                        
                                        <h6>Categories</h6>
                                        <div class="mb-3"><select class="form-select" id="teamCategorySelect"><option>Select team...</option></select></div>
                                        <form id="newCategoryForm" class="d-flex"><input type="text" id="newCategoryName" class="form-control me-2" placeholder="New Category Name" required><button type="submit" class="btn btn-primary btn-sm">Add</button></form>
                                        <div id="categoryListContainer" class="mt-3"></div>
                                    </div>
                                    <div class="col-md-8">
                                        <h5>2. Discover & Assign Rules</h5>
                                        <div class="row bg-light p-3 rounded mb-3">
                                            <div class="col-md-6"><label class="form-label fw-bold">Select Config</label><select class="form-select" id="categorizationConfigSelector"><option>Load configs...</option></select></div>
                                            <div class="col-md-6"><label class="form-label fw-bold">Upload Report</label><input class="form-control" type="file" id="categorizationReportUploader" accept=".xlsx" disabled></div>
                                        </div>
                                        <div id="rulesAssignmentContainer" style="display: none;">
                                            <button class="btn btn-success mb-3 save-rules-btn">Save All Rule Assignments</button>
                                            <div class="table-responsive-sm">
                                                <h6>Uncategorized Claim Edits</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Edit Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedEditsTable"></tbody></table>
                                            </div>
                                            <div class="table-responsive-sm mt-4">
                                                <h6 class="mt-4">Uncategorized Claim Notes</h6>
                                                <table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Full Note Text</th><th>Assign to Category</th></tr></thead><tbody id="uncategorizedNotesTable"></tbody></table>
                                            </div>
                                            <button class="btn btn-success mt-3 save-rules-btn">Save All Rule Assignments</button>
                                        </div>
                                        <div id="noRulesFound" class="alert alert-info">Upload a file to begin.</div>
                                    </div>
                                </div>
                            </div>

                            <!-- MANAGE EXISTING RULES PANE -->
                            <div class="tab-pane fade" id="manage-pane" role="tabpanel">
                                <h5>Manage Existing Rules</h5>
                                <p>Re-assign a rule to a different category or delete it permanently.</p>
                                <button id="saveExistingChangesBtn" class="btn btn-success mb-3">Save All Changes to Existing Rules</button>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Claim Edit Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Edit Text</th><th>Assigned Category</th><th></th></tr></thead>
                                                <tbody id="existingEditsTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Claim Note Rules</h6>
                                        <div class="table-responsive-sm">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light"><tr><th>Full Note Text</th><th>Assigned Category</th><th></th></tr></thead>
                                                <tbody id="existingNotesTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // API Endpoints
    const CONFIG_API = '/.netlify/functions/configurations', TEAMS_API = '/.netlify/functions/teams', CATEGORIES_API = '/.netlify/functions/categories', RULES_API = '/.netlify/functions/rules';

    // DOM Elements
    const configForm = document.getElementById('configForm'), configIdInput = document.getElementById('configId'), configNameInput = document.getElementById('configName'), clientNameInput = document.getElementById('clientName'), clearBtn = document.getElementById('clearBtn'), reportUploader = document.getElementById('reportUploader'), mappingSection = document.getElementById('mappingSection'), mappingTableBody = document.getElementById('mappingTableBody'), configList = document.getElementById('configList');
    const teamList = document.getElementById('teamList'), newTeamForm = document.getElementById('newTeamForm'), newTeamNameInput = document.getElementById('newTeamName'), teamCategorySelect = document.getElementById('teamCategorySelect'), categoryListContainer = document.getElementById('categoryListContainer'), newCategoryForm = document.getElementById('newCategoryForm'), newCategoryNameInput = document.getElementById('newCategoryName');
    const categorizationConfigSelector = document.getElementById('categorizationConfigSelector'), categorizationReportUploader = document.getElementById('categorizationReportUploader'), rulesAssignmentContainer = document.getElementById('rulesAssignmentContainer'), uncategorizedEditsTable = document.getElementById('uncategorizedEditsTable'), uncategorizedNotesTable = document.getElementById('uncategorizedNotesTable'), noRulesFoundDiv = document.getElementById('noRulesFound');
    const existingEditsTableBody = document.getElementById('existingEditsTableBody'), existingNotesTableBody = document.getElementById('existingNotesTableBody'), saveExistingChangesBtn = document.getElementById('saveExistingChangesBtn');

    // Global State
    let allTeams = [], allCategories = [], detectedHeaders = [], columnMappingsForCategorization = {};
    let existingEditRules = new Map(), existingNoteRules = new Map();
    const standardFields = [ { key: 'claimId', displayName: 'Claim ID / Number', required: true }, { key: 'age', displayName: 'Age (in days)', required: true }, { key: 'netPayment', displayName: 'Net Payment Amount', required: true }, { key: 'state', displayName: 'Claim State', required: true }, { key: 'status', displayName: 'Claim Status', required: true }, { key: 'networkStatus', displayName: 'Network Status', required: true }, { key: 'providerName', displayName: 'Billing Provider Name', required: true }, { key: 'edit', displayName: 'Claim Edits', required: true }, { key: 'notes', displayName: 'Claim Notes', required: true }, { key: 'dsnp', displayName: 'DSNP Status', required: false }, { key: 'totalCharges', displayName: 'Total Billed Amount', required: false }, ];
    
    // --- CORE DATA LOADING ---
    async function loadConfigurations() { /* Unchanged from previous version */ }
    async function loadTeams() { /* Unchanged */ }
    async function loadCategories() { /* Unchanged */ }
    async function loadRules() {
        try {
            const [editRes, noteRes] = await Promise.all([ fetch(`${RULES_API}?type=edit`), fetch(`${RULES_API}?type=note`) ]);
            const editRulesData = await editRes.json();
            const noteRulesData = await noteRes.json();
            existingEditRules = new Map(editRulesData.map(r => [r.text, { category_id: r.category_id, category_name: r.category_name, team_name: r.team_name }]));
            existingNoteRules = new Map(noteRulesData.map(r => [r.text, { category_id: r.category_id, category_name: r.category_name, team_name: r.team_name }]));
            renderExistingRulesTables(); // Render the new "Manage" tab
        } catch (error) { console.error("Failed to load existing rules:", error); }
    }
    async function loadAllData() { await Promise.all([loadTeams(), loadCategories(), loadRules(), loadConfigurations()]); }

    // --- CLIENT CONFIGURATION LOGIC (Unchanged) ---
    function renderMappingUI() { /* Unchanged */ }
    async function deleteConfig(id) { /* Unchanged */ }

    // --- TEAM & CATEGORY LOGIC (Unchanged) ---
    function renderTeamList() { /* Unchanged */ }
    function populateTeamDropdown() { /* Unchanged */ }
    async function deleteTeam(id) { /* Unchanged */ }
    function renderCategoryList() { /* Unchanged */ }
    async function deleteCategory(id) { /* Unchanged */ }

    // --- RULE MANAGEMENT LOGIC ---
    function processUploadedReport(data) {
        const detectedEdits = new Set(), detectedNotes = new Set();
        const { edit: editColumn, notes: notesColumn } = columnMappingsForCategorization;
        data.forEach(row => {
            const editValue = (row[editColumn] || '').toString().trim();
            if (editValue && !existingEditRules.has(editValue)) detectedEdits.add(editValue);
            const noteValue = (row[notesColumn] || '').toString().trim();
            if (noteValue && !existingNoteRules.has(noteValue)) detectedNotes.add(noteValue);
        });
        const sortedEdits = Array.from(detectedEdits).sort((a, b) => a.localeCompare(b));
        const sortedNotes = Array.from(detectedNotes).sort((a, b) => a.localeCompare(b));
        uncategorizedEditsTable.innerHTML = '';
        sortedEdits.forEach(text => uncategorizedEditsTable.insertRow().innerHTML = `<td>${text}</td><td>${createCategoryDropdown().outerHTML}</td>`);
        uncategorizedNotesTable.innerHTML = '';
        sortedNotes.forEach(noteText => uncategorizedNotesTable.insertRow().innerHTML = `<td>${noteText}</td><td>${createCategoryDropdown().outerHTML}</td>`);
        const hasRules = sortedEdits.length > 0 || sortedNotes.length > 0;
        rulesAssignmentContainer.style.display = hasRules ? 'block' : 'none';
        noRulesFoundDiv.textContent = hasRules ? '' : 'No new, uncategorized items found in the uploaded file.';
        noRulesFoundDiv.style.display = hasRules ? 'none' : 'block';
    }
    
    function createCategoryDropdown(selectedId = '') {
        const select = document.createElement('select');
        select.className = 'form-select form-select-sm';
        select.add(new Option('Select category...', ''));
        allCategories.sort((a,b) => (a.team_name || '').localeCompare(b.team_name || '') || a.category_name.localeCompare(b.category_name))
            .forEach(cat => select.add(new Option(`${cat.team_name} -> ${cat.category_name}`, cat.id)));
        if (selectedId) select.value = selectedId;
        return select;
    }

    function addOptionToAllDropdowns(newCategory) {
        document.querySelectorAll('select.form-select-sm').forEach(select => {
            select.add(new Option(`${newCategory.team_name} -> ${newCategory.category_name}`, newCategory.id));
        });
    }

    function removeOptionFromAllDropdowns(categoryId) {
        document.querySelectorAll('select.form-select-sm').forEach(select => {
            const optionToRemove = select.querySelector(`option[value="${categoryId}"]`);
            if (optionToRemove) optionToRemove.remove();
        });
    }

    // *** THIS FUNCTION IS MODIFIED FOR THE FIX ***
    async function saveNewRules() {
        const getRulesFromTable = (table) => Array.from(table.rows).map(row => ({
            row: row,
            text: row.cells[0].textContent,
            category_id: row.cells[1].querySelector('select').value
        })).filter(rule => rule.category_id);

        const editRulesToSave = getRulesFromTable(uncategorizedEditsTable);
        const noteRulesToSave = getRulesFromTable(uncategorizedNotesTable);

        if (editRulesToSave.length === 0 && noteRulesToSave.length === 0) {
            return alert('No new rules were assigned to a category.');
        }

        try {
            await Promise.all([
                editRulesToSave.length > 0 ? fetch(`${RULES_API}?type=edit`, { method: 'POST', body: JSON.stringify(editRulesToSave) }) : Promise.resolve(),
                noteRulesToSave.length > 0 ? fetch(`${RULES_API}?type=note`, { method: 'POST', body: JSON.stringify(noteRulesToSave) }) : Promise.resolve()
            ]);
            
            alert('Rules saved successfully!');
            
            // Remove saved rows and update state
            editRulesToSave.forEach(rule => {
                existingEditRules.set(rule.text, { category_id: rule.category_id }); // Update state
                rule.row.remove(); // Remove from UI
            });
            noteRulesToSave.forEach(rule => {
                existingNoteRules.set(rule.text, { category_id: rule.category_id }); // Update state
                rule.row.remove(); // Remove from UI
            });

            renderExistingRulesTables(); // Refresh the manage tab with new rules
            
            // Hide container if no rules are left
            if (uncategorizedEditsTable.rows.length === 0 && uncategorizedNotesTable.rows.length === 0) {
                rulesAssignmentContainer.style.display = 'none';
                noRulesFoundDiv.textContent = 'Upload a file to begin.';
                noRulesFoundDiv.style.display = 'block';
            }

        } catch (error) {
            alert(`Failed to save rules: ${error.message}`);
        }
    }
    
    // *** NEW FUNCTIONS FOR THE "MANAGE" TAB ***
    function renderExistingRulesTables() {
        existingEditsTableBody.innerHTML = '';
        Array.from(existingEditRules.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([text, rule]) => {
            const row = existingEditsTableBody.insertRow();
            row.dataset.text = text; // Store original text for updates
            row.innerHTML = `
                <td>${text}</td>
                <td>${createCategoryDropdown(rule.category_id).outerHTML}</td>
                <td><button class="btn btn-danger btn-sm py-0 px-1" onclick="deleteRule('edit', '${text.replace(/'/g, "\\'")}')">&times;</button></td>
            `;
        });

        existingNotesTableBody.innerHTML = '';
        Array.from(existingNoteRules.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([text, rule]) => {
            const row = existingNotesTableBody.insertRow();
            row.dataset.text = text;
            row.innerHTML = `
                <td>${text}</td>
                <td>${createCategoryDropdown(rule.category_id).outerHTML}</td>
                <td><button class="btn btn-danger btn-sm py-0 px-1" onclick="deleteRule('note', '${text.replace(/'/g, "\\'")}')">&times;</button></td>
            `;
        });
    }
    
    window.deleteRule = async (type, text) => {
        if (!confirm(`Are you sure you want to delete this rule?\n\nTYPE: ${type}\nRULE: ${text}`)) return;
        try {
            const response = await fetch(`${RULES_API}?type=${type}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            if (!response.ok) throw new Error('Delete failed on server.');

            // Remove from UI and state
            const tableBody = type === 'edit' ? existingEditsTableBody : existingNotesTableBody;
            tableBody.querySelector(`tr[data-text="${text}"]`)?.remove();
            const stateMap = type === 'edit' ? existingEditRules : existingNoteRules;
            stateMap.delete(text);
            alert('Rule deleted.');
        } catch(error) {
            alert(`Error deleting rule: ${error.message}`);
        }
    };
    
    async function saveExistingRuleChanges() {
        const getChangedRules = (tableBody) => Array.from(tableBody.rows).map(row => ({
            text: row.dataset.text,
            category_id: row.querySelector('select').value
        })).filter(rule => rule.category_id);

        const editRulesToUpdate = getChangedRules(existingEditsTableBody);
        const noteRulesToUpdate = getChangedRules(existingNotesTableBody);
        
        try {
            await Promise.all([
                editRulesToUpdate.length > 0 ? fetch(`${RULES_API}?type=edit`, { method: 'POST', body: JSON.stringify(editRulesToUpdate) }) : Promise.resolve(),
                noteRulesToUpdate.length > 0 ? fetch(`${RULES_API}?type=note`, { method: 'POST', body: JSON.stringify(noteRulesToUpdate) }) : Promise.resolve()
            ]);
            alert('Existing rule changes saved successfully!');
            await loadRules(); // Reload to get fresh data
        } catch(error) {
            alert(`Error saving changes: ${error.message}`);
        }
    }


    // --- EVENT LISTENERS ---
    configForm.addEventListener('submit', async (e) => { e.preventDefault(); const columnMappings = {}; mappingTableBody.querySelectorAll('select').forEach(sel => { if (sel.value) columnMappings[sel.dataset.standardKey] = sel.value; }); const id = configIdInput.value; const config_data = { clientName: clientNameInput.value, columnMappings }; const method = id ? 'PUT' : 'POST'; const url = id ? `${CONFIG_API}?id=${id}` : CONFIG_API; try { await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config_name: configNameInput.value, config_data }) }); alert(`Configuration ${id ? 'updated' : 'created'}!`); configForm.reset(); mappingSection.style.display = 'none'; loadConfigurations(); } catch (error) { alert('Failed to save configuration.'); } });
    reportUploader.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 }); detectedHeaders = json[0] || []; renderMappingUI(); }; reader.readAsArrayBuffer(file); });
    clearBtn.addEventListener('click', () => { configForm.reset(); mappingSection.style.display = 'none'; });
    newTeamForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = newTeamNameInput.value.trim(); if (!name) return; try { await fetch(TEAMS_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team_name: name }) }); newTeamNameInput.value = ''; await loadTeams(); } catch (error) { alert('Failed to add team. It may already exist.'); } });
    newCategoryForm.addEventListener('submit', async (e) => { e.preventDefault(); const category_name = newCategoryNameInput.value.trim(); const team_id = parseInt(teamCategorySelect.value, 10); if (!category_name || !team_id) return alert('Please select a team and enter a category name.'); try { const response = await fetch(CATEGORIES_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category_name, team_id }) }); if (!response.ok) throw new Error('Failed to create category'); const newCategoryData = await response.json(); const team = allTeams.find(t => t.id === team_id); const newCategory = { ...newCategoryData, team_name: team ? team.team_name : 'Unknown' }; allCategories.push(newCategory); renderCategoryList(); addOptionToAllDropdowns(newCategory); newCategoryNameInput.value = ''; } catch (error) { alert('Failed to add category. It may already exist.'); } });
    categorizationConfigSelector.addEventListener('change', () => { const selectedId = parseInt(categorizationConfigSelector.value, 10); const config = (window.allClientConfigs || []).find(c => c.id === selectedId); if (config?.config_data?.columnMappings) { columnMappingsForCategorization = config.config_data.columnMappings; const hasRequiredCols = columnMappingsForCategorization.edit && columnMappingsForCategorization.notes; categorizationReportUploader.disabled = !hasRequiredCols; if(!hasRequiredCols) alert('Selected config must map both "Claim Edits" and "Claim Notes".') } });
    categorizationReportUploader.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const dataJson = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); processUploadedReport(dataJson); }; reader.readAsArrayBuffer(file); });
    document.querySelectorAll('.save-rules-btn').forEach(btn => btn.addEventListener('click', saveNewRules));
    saveExistingChangesBtn.addEventListener('click', saveExistingRuleChanges);

    // --- INITIAL PAGE LOAD ---
    loadAllData();
});
</script>
</body>
</html>
