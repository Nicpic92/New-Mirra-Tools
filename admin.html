<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .mapping-table th { width: 30%; }
        .list-group-item h6 { margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Admin Console</h1>
            <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
        </div>
        
        <!-- Client Configuration Management -->
        <div class="row g-5">
            <div class="col-12">
                <div class="card">
                     <div class="card-body">
                        <h2 id="formTitle">Client Configurations</h2>
                        <p class="text-muted">Manage settings for individual clients and their column mappings.</p>
                         <div class="row">
                            <div class="col-md-7">
                                <form id="configForm">
                                    <input type="hidden" id="configId">
                                    <h5>Step 1: Basic Information</h5>
                                    <div class="mb-3"><label for="configName" class="form-label">Configuration Name</label><input type="text" class="form-control" id="configName" required></div>
                                    <div class="mb-3"><label for="clientName" class="form-label">Client Name (for PDF Reports)</label><input type="text" class="form-control" id="clientName"></div>
                                    <hr>
                                    <h5>Step 2: Upload to Map Columns</h5>
                                     <div class="mb-3"><label for="reportUploader" class="form-label">Upload XLSX File</label><input class="form-control" type="file" id="reportUploader" accept=".xlsx"></div>
                                    <div id="mappingSection" class="mt-4" style="display: none;">
                                        <h6>Map Your Fields to Detected Headers:</h6>
                                        <table class="table table-bordered table-sm mapping-table">
                                            <thead class="table-light"><tr><th>Standard Field</th><th>Client's Column Header</th></tr></thead>
                                            <tbody id="mappingTableBody"></tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                    <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                                </form>
                            </div>
                            <div class="col-md-5">
                                <h5>Existing Configurations</h5>
                                <ul class="list-group" id="configList"></ul>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Categorization Rules Section -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Global Categorization & Team Management</h2>
                        <p class="text-muted">Manage teams, define categories for each team, and create rules to automatically assign claims.</p>
                        
                        <div class="row">
                            <!-- Team and Category Management -->
                            <div class="col-md-4">
                                <h5>1. Manage Teams</h5>
                                <ul class="list-group mb-3" id="teamList"></ul>
                                <form id="newTeamForm" class="d-flex mb-4">
                                    <input type="text" id="newTeamName" class="form-control me-2" placeholder="New Team Name" required>
                                    <button type="submit" class="btn btn-primary btn-sm">Add Team</button>
                                </form>

                                <h5>2. Manage Categories</h5>
                                <div class="mb-3">
                                    <label for="teamCategorySelect" class="form-label">Select Team</label>
                                    <select class="form-select" id="teamCategorySelect"><option>Select a team to add category to...</option></select>
                                </div>
                                <form id="newCategoryForm" class="d-flex">
                                    <input type="text" id="newCategoryName" class="form-control me-2" placeholder="New Category Name" required>
                                    <button type="submit" class="btn btn-primary btn-sm">Add Category</button>
                                </form>
                                <div id="categoryListContainer" class="mt-3"></div>
                            </div>
                            <!-- Rules Assignment -->
                            <div class="col-md-8">
                                <h5>3. Assign Rules</h5>
                                <p class="small">Upload a report to discover new, uncategorized claim edits and note keywords. Then assign them to a category.</p>
                                <div class="row bg-light p-3 rounded mb-3">
                                    <div class="col-md-6">
                                        <label for="categorizationConfigSelector" class="form-label fw-bold">Select Config to Read Columns</label>
                                        <select class="form-select" id="categorizationConfigSelector"><option>Load configs first...</option></select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="categorizationReportUploader" class="form-label fw-bold">Upload Report to Find Rules</label>
                                        <input class="form-control" type="file" id="categorizationReportUploader" accept=".xlsx" disabled>
                                    </div>
                                </div>
                                
                                <div id="rulesAssignmentContainer" style="display: none;">
                                    <button class="btn btn-success mb-3 save-rules-btn">Save All Rule Assignments</button>

                                    <h6>Uncategorized Claim Edits (Alphabetical)</h6>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light"><tr><th>Edit Text</th><th>Assign to Category</th></tr></thead>
                                        <tbody id="uncategorizedEditsTable"></tbody>
                                    </table>
                                    
                                    <h6 class="mt-4">Uncategorized Claim Notes (Alphabetical)</h6>
                                    <table class="table table-sm table-bordered">
                                       <thead class="table-light"><tr><th>Full Note Text</th><th>Assign to Category</th></tr></thead>
                                       <tbody id="uncategorizedNotesTable"></tbody>
                                    </table>

                                    <button class="btn btn-success mt-3 save-rules-btn">Save All Rule Assignments</button>
                                </div>
                                <div id="noRulesFound" class="alert alert-info">Upload a file to begin.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- API ENDPOINTS ---
    const CONFIG_API = '/.netlify/functions/configurations';
    const TEAMS_API = '/.netlify/functions/teams';
    const CATEGORIES_API = '/.netlify/functions/categories';
    const RULES_API = '/.netlify/functions/rules';

    // --- DOM ELEMENTS ---
    const configForm = document.getElementById('configForm'), configIdInput = document.getElementById('configId'), configNameInput = document.getElementById('configName'), clientNameInput = document.getElementById('clientName'), clearBtn = document.getElementById('clearBtn'), reportUploader = document.getElementById('reportUploader'), mappingSection = document.getElementById('mappingSection'), mappingTableBody = document.getElementById('mappingTableBody'), configList = document.getElementById('configList');
    const teamList = document.getElementById('teamList'), newTeamForm = document.getElementById('newTeamForm'), newTeamNameInput = document.getElementById('newTeamName'), teamCategorySelect = document.getElementById('teamCategorySelect'), categoryListContainer = document.getElementById('categoryListContainer'), newCategoryForm = document.getElementById('newCategoryForm'), newCategoryNameInput = document.getElementById('newCategoryName');
    const categorizationConfigSelector = document.getElementById('categorizationConfigSelector'), categorizationReportUploader = document.getElementById('categorizationReportUploader'), rulesAssignmentContainer = document.getElementById('rulesAssignmentContainer'), uncategorizedEditsTable = document.getElementById('uncategorizedEditsTable'), uncategorizedNotesTable = document.getElementById('uncategorizedNotesTable'), noRulesFoundDiv = document.getElementById('noRulesFound');
    
    // --- GLOBAL STATE ---
    let allTeams = [], allCategories = [], detectedHeaders = [], columnMappingsForCategorization = {};
    let existingEditRules = new Map(), existingNoteRules = new Map();
    const standardFields = [ { key: 'claimId', displayName: 'Claim ID / Number', required: true }, { key: 'age', displayName: 'Age (in days)', required: true }, { key: 'netPayment', displayName: 'Net Payment Amount', required: true }, { key: 'state', displayName: 'Claim State', required: true }, { key: 'status', displayName: 'Claim Status', required: true }, { key: 'networkStatus', displayName: 'Network Status', required: true }, { key: 'providerName', displayName: 'Billing Provider Name', required: true }, { key: 'edit', displayName: 'Claim Edits', required: true }, { key: 'notes', displayName: 'Claim Notes', required: true }, { key: 'dsnp', displayName: 'DSNP Status', required: false }, { key: 'totalCharges', displayName: 'Total Billed Amount', required: false }, ];
    
    // --- CORE DATA LOADING ---
    async function loadConfigurations() {
        try {
            const response = await fetch(CONFIG_API);
            const configs = await response.json();
            window.allClientConfigs = configs; 
            configList.innerHTML = configs.length ? '' : '<li class="list-group-item">No configurations found.</li>';
            categorizationConfigSelector.innerHTML = '<option selected disabled value="">Select a configuration...</option>';
            configs.forEach(config => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = config.config_name;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm'; deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteConfig(config.id);
                li.appendChild(deleteBtn);
                configList.appendChild(li);
                categorizationConfigSelector.add(new Option(config.config_name, config.id));
            });
        } catch (error) { console.error('Error loading configurations:', error); }
    }
    
    async function loadTeams() {
        try {
            const response = await fetch(TEAMS_API);
            allTeams = await response.json();
            renderTeamList();
            populateTeamDropdown();
        } catch (error) { console.error("Failed to load teams:", error); }
    }
    
    async function loadCategories() {
        try {
            const response = await fetch(CATEGORIES_API);
            allCategories = await response.json();
            renderCategoryList();
        } catch (error) { console.error("Failed to load categories:", error); }
    }

    async function loadRules() {
        try {
            const [editRes, noteRes] = await Promise.all([ fetch(`${RULES_API}?type=edit`), fetch(`${RULES_API}?type=note`) ]);
            existingEditRules = new Map((await editRes.json()).map(rule => [rule.text, rule.category_id]));
            existingNoteRules = new Map((await noteRes.json()).map(rule => [rule.text, rule.category_id]));
        } catch (error) { console.error("Failed to load existing rules:", error); }
    }

    async function loadAllData() {
        await Promise.all([loadTeams(), loadCategories(), loadRules(), loadConfigurations()]);
    }

    // --- CLIENT CONFIGURATION LOGIC ---
    function renderMappingUI() {
        mappingTableBody.innerHTML = '';
        standardFields.forEach(field => {
            const row = mappingTableBody.insertRow();
            row.insertCell().innerHTML = `${field.displayName}${field.required ? ' <span class="text-danger">*</span>' : ''}`;
            const cell2 = row.insertCell();
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm';
            select.dataset.standardKey = field.key;
            select.add(new Option(field.required ? 'Select header...' : 'Optional', ''));
            detectedHeaders.forEach(header => select.add(new Option(header, header)));
            cell2.appendChild(select);
        });
        mappingSection.style.display = 'block';
    }

    async function deleteConfig(id) {
        if (!confirm('Are you sure?')) return;
        try {
            await fetch(`${CONFIG_API}?id=${id}`, { method: 'DELETE' });
            alert('Configuration deleted.');
            loadConfigurations();
        } catch (error) { alert('Failed to delete configuration.'); }
    }
    
    // --- TEAM & CATEGORY LOGIC ---
    function renderTeamList() {
        teamList.innerHTML = allTeams.length ? '' : '<li class="list-group-item">No teams defined.</li>';
        allTeams.forEach(team => {
            const li = document.createElement('li');
            li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
            li.textContent = team.team_name;
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = () => deleteTeam(team.id);
            li.appendChild(deleteBtn);
            teamList.appendChild(li);
        });
    }

    function populateTeamDropdown() {
        teamCategorySelect.innerHTML = '<option value="">Select a team to add to...</option>';
        allTeams.sort((a, b) => a.team_name.localeCompare(b.team_name)).forEach(team => teamCategorySelect.add(new Option(team.team_name, team.id)));
    }
    
    async function deleteTeam(id) {
        if (!confirm('Are you sure? This will unassign categories from this team.')) return;
        try {
            await fetch(`${TEAMS_API}?id=${id}`, { method: 'DELETE' });
            await loadAllData();
        } catch (error) { alert('Failed to delete team.'); }
    }
    
    function renderCategoryList() {
        categoryListContainer.innerHTML = '';
        const grouped = allCategories.reduce((acc, cat) => {
            const teamName = cat.team_name || 'Unassigned';
            if (!acc[teamName]) acc[teamName] = [];
            acc[teamName].push(cat);
            return acc;
        }, {});
        Object.keys(grouped).sort().forEach(teamName => {
            const card = document.createElement('div');
            card.className = 'card mb-2';
            card.innerHTML = `<div class="card-header py-1">${teamName}</div>`;
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            grouped[teamName].sort((a,b) => a.category_name.localeCompare(b.category_name)).forEach(cat => {
                const li = document.createElement('li');
                li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
                li.textContent = cat.category_name;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => deleteCategory(cat.id);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
            card.appendChild(list);
            categoryListContainer.appendChild(card);
        });
    }

    async function deleteCategory(id) {
        if (!confirm('Are you sure? This also deletes associated rules.')) return;
        try {
            const response = await fetch(`${CATEGORIES_API}?id=${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Delete failed');
            const index = allCategories.findIndex(cat => cat.id === id);
            if (index > -1) allCategories.splice(index, 1);
            renderCategoryList();
            removeOptionFromAllDropdowns(id);
            await loadRules();
        } catch (error) { alert('Failed to delete category.'); }
    }

    // --- RULE MANAGEMENT LOGIC ---
    function processUploadedReport(data) {
        const detectedEdits = new Set(), detectedNotes = new Set();
        const { edit: editColumn, notes: notesColumn } = columnMappingsForCategorization;
        data.forEach(row => {
            const editValue = row[editColumn];
            if (editValue && !existingEditRules.has(editValue)) detectedEdits.add(editValue);
            const noteValue = (row[notesColumn] || '').toString().trim();
            if (noteValue && !existingNoteRules.has(noteValue)) detectedNotes.add(noteValue);
        });
        const sortedEdits = Array.from(detectedEdits).sort((a, b) => a.localeCompare(b));
        const sortedNotes = Array.from(detectedNotes).sort((a, b) => a.localeCompare(b));
        uncategorizedEditsTable.innerHTML = '';
        sortedEdits.forEach(text => {
            const row = uncategorizedEditsTable.insertRow();
            row.insertCell().textContent = text;
            row.insertCell().appendChild(createCategoryDropdown());
        });
        uncategorizedNotesTable.innerHTML = '';
        sortedNotes.forEach(noteText => {
            const row = uncategorizedNotesTable.insertRow();
            row.insertCell().textContent = noteText;
            row.insertCell().appendChild(createCategoryDropdown());
        });
        const hasRules = sortedEdits.length > 0 || sortedNotes.length > 0;
        rulesAssignmentContainer.style.display = hasRules ? 'block' : 'none';
        noRulesFoundDiv.textContent = hasRules ? '' : 'No new, uncategorized items found in the uploaded file.';
        noRulesFoundDiv.style.display = hasRules ? 'none' : 'block';
    }
    
    function createCategoryDropdown() {
        const select = document.createElement('select');
        select.className = 'form-select form-select-sm';
        select.add(new Option('Select category...', ''));
        allCategories.sort((a,b) => (a.team_name || '').localeCompare(b.team_name || '') || a.category_name.localeCompare(b.category_name))
            .forEach(cat => {
                select.add(new Option(`${cat.team_name} -> ${cat.category_name}`, cat.id));
            });
        return select;
    }

    function addOptionToAllDropdowns(newCategory) {
        const allSelects = document.querySelectorAll('#uncategorizedEditsTable select, #uncategorizedNotesTable select');
        const newOption = new Option(`${newCategory.team_name} -> ${newCategory.category_name}`, newCategory.id);
        allSelects.forEach(select => {
            select.add(newOption.cloneNode(true));
            // Re-sort the options in each dropdown
            Array.from(select.options)
                .sort((a, b) => (a.value === "") ? -1 : (b.value === "") ? 1 : a.text.localeCompare(b.text))
                .forEach(option => select.add(option));
        });
    }

    function removeOptionFromAllDropdowns(categoryId) {
        const allSelects = document.querySelectorAll('#uncategorizedEditsTable select, #uncategorizedNotesTable select');
        allSelects.forEach(select => {
            const optionToRemove = select.querySelector(`option[value="${categoryId}"]`);
            if (optionToRemove) optionToRemove.remove();
        });
    }

    function saveRules() {
        const getRulesFromTable = (table) => Array.from(table.rows).map(row => ({
            text: row.cells[0].textContent,
            category_id: row.cells[1].querySelector('select').value
        })).filter(rule => rule.category_id);
        const editRulesToSave = getRulesFromTable(uncategorizedEditsTable);
        const noteRulesToSave = getRulesFromTable(uncategorizedNotesTable);
        Promise.all([
            editRulesToSave.length > 0 ? fetch(`${RULES_API}?type=edit`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(editRulesToSave) }) : Promise.resolve(),
            noteRulesToSave.length > 0 ? fetch(`${RULES_API}?type=note`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(noteRulesToSave) }) : Promise.resolve()
        ]).then(() => {
            if (editRulesToSave.length || noteRulesToSave.length) {
                alert('Rules saved successfully!');
                rulesAssignmentContainer.style.display = 'none';
                noRulesFoundDiv.textContent = 'Upload a file to begin.';
                noRulesFoundDiv.style.display = 'block';
                return loadRules();
            } else {
                alert('No new rules were assigned.');
            }
        }).catch(error => { alert(`Failed to save rules: ${error.message}`); });
    }

    // --- EVENT LISTENERS ---
    configForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const columnMappings = {};
        mappingTableBody.querySelectorAll('select').forEach(sel => { if (sel.value) columnMappings[sel.dataset.standardKey] = sel.value; });
        const id = configIdInput.value;
        const config_data = { clientName: clientNameInput.value, columnMappings };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${CONFIG_API}?id=${id}` : CONFIG_API;
        try {
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config_name: configNameInput.value, config_data }) });
            alert(`Configuration ${id ? 'updated' : 'created'}!`);
            configForm.reset();
            mappingSection.style.display = 'none';
            loadConfigurations();
        } catch (error) { alert('Failed to save configuration.'); }
    });

    reportUploader.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            detectedHeaders = json[0] || [];
            renderMappingUI();
        };
        reader.readAsArrayBuffer(file);
    });

    clearBtn.addEventListener('click', () => {
        configForm.reset();
        mappingSection.style.display = 'none';
    });

    newTeamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = newTeamNameInput.value.trim();
        if (!name) return;
        try {
            await fetch(TEAMS_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team_name: name }) });
            newTeamNameInput.value = '';
            await loadTeams();
        } catch (error) { alert('Failed to add team. It may already exist.'); }
    });

    newCategoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const category_name = newCategoryNameInput.value.trim();
        const team_id = parseInt(teamCategorySelect.value, 10);
        if (!category_name || !team_id) return alert('Please select a team and enter a category name.');
        try {
            const response = await fetch(CATEGORIES_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category_name, team_id }) });
            if (!response.ok) throw new Error('Failed to create category');
            const newCategoryData = await response.json();
            const team = allTeams.find(t => t.id === team_id);
            const newCategory = { ...newCategoryData, team_name: team ? team.team_name : 'Unknown' };
            allCategories.push(newCategory);
            renderCategoryList();
            addOptionToAllDropdowns(newCategory);
            newCategoryNameInput.value = '';
        } catch (error) { alert('Failed to add category. It may already exist.'); }
    });

    categorizationConfigSelector.addEventListener('change', () => {
        const selectedId = parseInt(categorizationConfigSelector.value, 10);
        const config = (window.allClientConfigs || []).find(c => c.id === selectedId);
        if (config?.config_data?.columnMappings) {
            columnMappingsForCategorization = config.config_data.columnMappings;
            const hasRequiredCols = columnMappingsForCategorization.edit && columnMappingsForCategorization.notes;
            categorizationReportUploader.disabled = !hasRequiredCols;
            if(!hasRequiredCols) alert('Selected config must map both "Claim Edits" and "Claim Notes".')
        }
    });

    categorizationReportUploader.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const dataJson = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            processUploadedReport(dataJson);
        };
        reader.readAsArrayBuffer(file);
    });

    document.querySelectorAll('.save-rules-btn').forEach(btn => btn.addEventListener('click', saveRules));

    // --- INITIAL PAGE LOAD ---
    loadAllData();
});
</script>
</body>
</html>
