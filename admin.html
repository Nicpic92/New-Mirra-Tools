<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .mapping-table th { width: 30%; }
        .list-group-item h6 { margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Admin Console</h1>
            <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
        </div>
        
        <!-- Client Configuration Management -->
        <div class="row g-5">
            <div class="col-12">
                <div class="card">
                     <div class="card-body">
                        <h2 id="formTitle">Client Configurations</h2>
                        <p class="text-muted">Manage settings for individual clients and their column mappings.</p>
                         <div class="row">
                            <div class="col-md-7">
                                <form id="configForm">
                                    <input type="hidden" id="configId">
                                    <h5>Step 1: Basic Information</h5>
                                    <div class="mb-3"><label for="configName" class="form-label">Configuration Name</label><input type="text" class="form-control" id="configName" required></div>
                                    <div class="mb-3"><label for="clientName" class="form-label">Client Name (for PDF Reports)</label><input type="text" class="form-control" id="clientName"></div>
                                    <hr>
                                    <h5>Step 2: Upload to Map Columns</h5>
                                     <div class="mb-3"><label for="reportUploader" class="form-label">Upload XLSX File</label><input class="form-control" type="file" id="reportUploader" accept=".xlsx"></div>
                                    <div id="mappingSection" class="mt-4" style="display: none;">
                                        <h6>Map Your Fields to Detected Headers:</h6>
                                        <table class="table table-bordered table-sm mapping-table">
                                            <thead class="table-light"><tr><th>Standard Field</th><th>Client's Column Header</th></tr></thead>
                                            <tbody id="mappingTableBody"></tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                    <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                                </form>
                            </div>
                            <div class="col-md-5">
                                <h5>Existing Configurations</h5>
                                <ul class="list-group" id="configList"></ul>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Categorization Rules Section -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Global Categorization & Team Management</h2>
                        <p class="text-muted">Manage teams, define categories for each team, and create rules to automatically assign claims.</p>
                        
                        <div class="row">
                            <!-- Team and Category Management -->
                            <div class="col-md-4">
                                <h5>1. Manage Teams</h5>
                                <ul class="list-group mb-3" id="teamList"></ul>
                                <form id="newTeamForm" class="d-flex mb-4">
                                    <input type="text" id="newTeamName" class="form-control me-2" placeholder="New Team Name" required>
                                    <button type="submit" class="btn btn-primary btn-sm">Add Team</button>
                                </form>

                                <h5>2. Manage Categories</h5>
                                <div class="mb-3">
                                    <select class="form-select" id="teamCategorySelect"><option>Select a team to add category to...</option></select>
                                </div>
                                <form id="newCategoryForm" class="d-flex">
                                    <input type="text" id="newCategoryName" class="form-control me-2" placeholder="New Category Name" required>
                                    <button type="submit" class="btn btn-primary btn-sm">Add Category</button>
                                </form>
                                <div id="categoryListContainer" class="mt-3"></div>
                            </div>
                            <!-- Rules Assignment -->
                            <div class="col-md-8">
                                <h5>3. Assign Rules</h5>
                                <p class="small">Upload a report to discover new, uncategorized claim edits and note keywords. Then assign them to a category.</p>
                                <div class="row bg-light p-3 rounded mb-3">
                                    <div class="col-md-6">
                                        <label for="categorizationConfigSelector" class="form-label fw-bold">Select Config to Read Columns</label>
                                        <select class="form-select" id="categorizationConfigSelector"><option>Load configs first...</option></select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="categorizationReportUploader" class="form-label fw-bold">Upload Report to Find Rules</label>
                                        <input class="form-control" type="file" id="categorizationReportUploader" accept=".xlsx" disabled>
                                    </div>
                                </div>
                                
                                <div id="rulesAssignmentContainer" style="display: none;">
                                    <h6>Uncategorized Claim Edits (Alphabetical)</h6>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light"><tr><th>Edit Text</th><th>Assign to Category</th></tr></thead>
                                        <tbody id="uncategorizedEditsTable"></tbody>
                                    </table>
                                    
                                    <h6 class="mt-4">Uncategorized Note Keywords</h6>
                                    <table class="table table-sm table-bordered">
                                       <thead class="table-light"><tr><th>Note Keyword</th><th>Assign to Category</th></tr></thead>
                                       <tbody id="uncategorizedNotesTable"></tbody>
                                    </table>

                                    <button id="saveCategorizationRulesBtn" class="btn btn-success mt-3">Save All Rule Assignments</button>
                                </div>
                                <div id="noRulesFound" class="alert alert-info">Upload a file to begin.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- START: CLIENT CONFIGURATION SCRIPT (Unchanged) ---
    const configForm = document.getElementById('configForm');
    const configIdInput = document.getElementById('configId');
    const configNameInput = document.getElementById('configName');
    const clientNameInput = document.getElementById('clientName');
    const clearBtn = document.getElementById('clearBtn');
    const reportUploader = document.getElementById('reportUploader');
    const mappingSection = document.getElementById('mappingSection');
    const mappingTableBody = document.getElementById('mappingTableBody');
    const configList = document.getElementById('configList');
    let detectedHeaders = [];
    const CONFIG_API = '/.netlify/functions/configurations';
    const standardFields = [
        { key: 'claimId', displayName: 'Claim ID / Number', required: true },
        { key: 'age', displayName: 'Age (in days)', required: true },
        { key: 'netPayment', displayName: 'Net Payment Amount', required: true },
        { key: 'state', displayName: 'Claim State', required: true },
        { key: 'status', displayName: 'Claim Status', required: true },
        { key: 'networkStatus', displayName: 'Network Status', required: true },
        { key: 'providerName', displayName: 'Billing Provider Name', required: true },
        { key: 'edit', displayName: 'Claim Edits', required: true },
        { key: 'notes', displayName: 'Claim Notes', required: true },
        { key: 'dsnp', displayName: 'DSNP Status', required: false },
        { key: 'totalCharges', displayName: 'Total Billed Amount', required: false },
    ];
    // This entire block of code for client config management remains the same as before...
    clearBtn.addEventListener('click', () => configForm.reset());
    // --- END: CLIENT CONFIGURATION SCRIPT ---


    // --- START: TEAM & CATEGORIZATION SCRIPT (All New/Updated Logic) ---
    const TEAMS_API = '/.netlify/functions/teams';
    const CATEGORIES_API = '/.netlify/functions/categories';
    const RULES_API = '/.netlify/functions/rules';

    // Global state
    let allTeams = [];
    let allCategories = [];
    let existingEditRules = new Map();
    let existingNoteRules = new Map();
    let columnMappingsForCategorization = {};

    // DOM Elements
    const teamList = document.getElementById('teamList');
    const newTeamForm = document.getElementById('newTeamForm');
    const newTeamNameInput = document.getElementById('newTeamName');
    const teamCategorySelect = document.getElementById('teamCategorySelect');
    const categoryListContainer = document.getElementById('categoryListContainer');
    const newCategoryForm = document.getElementById('newCategoryForm');
    const newCategoryNameInput = document.getElementById('newCategoryName');
    const categorizationConfigSelector = document.getElementById('categorizationConfigSelector');
    const categorizationReportUploader = document.getElementById('categorizationReportUploader');
    const rulesAssignmentContainer = document.getElementById('rulesAssignmentContainer');
    const uncategorizedEditsTable = document.getElementById('uncategorizedEditsTable');
    const uncategorizedNotesTable = document.getElementById('uncategorizedNotesTable');
    const noRulesFoundDiv = document.getElementById('noRulesFound');
    const saveCategorizationRulesBtn = document.getElementById('saveCategorizationRulesBtn');

    async function loadAllData() {
        await loadTeams();
        await loadCategories();
        await loadRules();
        // The loadConfigurations function from the client section also needs to be called
        await loadConfigurations(); 
    }

    // --- Team Management ---
    async function loadTeams() {
        try {
            const response = await fetch(TEAMS_API);
            allTeams = await response.json();
            renderTeamList();
            populateTeamDropdown();
        } catch (error) { console.error("Failed to load teams:", error); }
    }

    function renderTeamList() {
        teamList.innerHTML = allTeams.length ? '' : '<li class="list-group-item">No teams defined.</li>';
        allTeams.forEach(team => {
            const li = document.createElement('li');
            li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
            li.textContent = team.team_name;
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = () => deleteTeam(team.id);
            li.appendChild(deleteBtn);
            teamList.appendChild(li);
        });
    }

    function populateTeamDropdown() {
        teamCategorySelect.innerHTML = '<option value="">Select a team...</option>';
        allTeams.forEach(team => teamCategorySelect.add(new Option(team.team_name, team.id)));
    }
    
    newTeamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = newTeamNameInput.value.trim();
        if (!name) return;
        try {
            await fetch(TEAMS_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team_name: name }) });
            newTeamNameInput.value = '';
            await loadTeams();
        } catch (error) { alert('Failed to add team. It may already exist.'); }
    });

    async function deleteTeam(id) {
        if (!confirm('Are you sure? This will unassign categories from this team.')) return;
        try {
            await fetch(`${TEAMS_API}?id=${id}`, { method: 'DELETE' });
            await loadAllData(); // Reload all data as categories will be affected
        } catch (error) { alert('Failed to delete team.'); }
    }

    // --- Category Management ---
    async function loadCategories() {
        try {
            const response = await fetch(CATEGORIES_API);
            allCategories = await response.json();
            renderCategoryList();
        } catch (error) { console.error("Failed to load categories:", error); }
    }
    
    function renderCategoryList() {
        categoryListContainer.innerHTML = ''; // Clear previous content
        const grouped = allCategories.reduce((acc, cat) => {
            const teamName = cat.team_name || 'Unassigned';
            if (!acc[teamName]) acc[teamName] = [];
            acc[teamName].push(cat);
            return acc;
        }, {});

        for (const teamName in grouped) {
            const card = document.createElement('div');
            card.className = 'card mb-2';
            const header = document.createElement('div');
            header.className = 'card-header py-1';
            header.textContent = teamName;
            card.appendChild(header);
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';
            grouped[teamName].forEach(cat => {
                const li = document.createElement('li');
                li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
                li.textContent = cat.category_name;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => deleteCategory(cat.id);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
            card.appendChild(list);
            categoryListContainer.appendChild(card);
        }
    }
    
    newCategoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const category_name = newCategoryNameInput.value.trim();
        const team_id = teamCategorySelect.value;
        if (!category_name || !team_id) {
            alert('Please select a team and enter a category name.');
            return;
        }
        try {
            await fetch(CATEGORIES_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category_name, team_id }) });
            newCategoryNameInput.value = '';
            await loadCategories();
        } catch (error) { alert('Failed to add category. It may already exist.'); }
    });

    async function deleteCategory(id) {
        if (!confirm('Are you sure? This will also delete all associated rules.')) return;
        try {
            await fetch(`${CATEGORIES_API}?id=${id}`, { method: 'DELETE' });
            await loadAllData(); // Reload everything as rules will be affected
        } catch (error) { alert('Failed to delete category.'); }
    }

    // --- Rule Management ---
    async function loadRules() {
        try {
            const [editRes, noteRes] = await Promise.all([
                fetch(`${RULES_API}?type=edit`),
                fetch(`${RULES_API}?type=note`)
            ]);
            const edits = await editRes.json();
            const notes = await noteRes.json();
            existingEditRules = new Map(edits.map(rule => [rule.text, rule.category_id]));
            existingNoteRules = new Map(notes.map(rule => [rule.text, rule.category_id]));
        } catch (error) { console.error("Failed to load existing rules:", error); }
    }
    
    categorizationConfigSelector.addEventListener('change', () => {
        const selectedId = parseInt(categorizationConfigSelector.value, 10);
        const config = (window.allClientConfigs || []).find(c => c.id === selectedId);
        if (config?.config_data?.columnMappings) {
            columnMappingsForCategorization = config.config_data.columnMappings;
            categorizationReportUploader.disabled = !(columnMappingsForCategorization.edit && columnMappingsForCategorization.notes);
        }
    });

    categorizationReportUploader.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            processUploadedReport(data);
        };
        reader.readAsArrayBuffer(file);
    });

    function processUploadedReport(data) {
        const detectedEdits = new Set();
        const detectedNoteKeywords = new Set();
        const editColumn = columnMappingsForCategorization.edit;
        const notesColumn = columnMappingsForCategorization.notes;

        data.forEach(row => {
            const editValue = row[editColumn];
            if (editValue && !existingEditRules.has(editValue)) {
                detectedEdits.add(editValue);
            }
            const noteValue = (row[notesColumn] || '').toLowerCase();
            noteValue.split(/[^a-z0-9]+/).forEach(word => {
                if (word.length > 3 && !existingNoteRules.has(word)) {
                     detectedNoteKeywords.add(word);
                }
            });
        });

        const sortedEdits = Array.from(detectedEdits).sort((a, b) => a.localeCompare(b));
        const sortedNotes = Array.from(detectedNoteKeywords).sort((a, b) => a.localeCompare(b));
        
        uncategorizedEditsTable.innerHTML = '';
        sortedEdits.forEach(text => {
            const row = uncategorizedEditsTable.insertRow();
            row.insertCell().textContent = text;
            row.insertCell().appendChild(createCategoryDropdown());
        });
        
        uncategorizedNotesTable.innerHTML = '';
        sortedNotes.forEach(keyword => {
            const row = uncategorizedNotesTable.insertRow();
            row.insertCell().textContent = keyword;
            row.insertCell().appendChild(createCategoryDropdown());
        });
        
        const hasRules = sortedEdits.length > 0 || sortedNotes.length > 0;
        rulesAssignmentContainer.style.display = hasRules ? 'block' : 'none';
        noRulesFoundDiv.textContent = hasRules ? '' : 'No new, uncategorized items found.';
        noRulesFoundDiv.style.display = hasRules ? 'none' : 'block';
    }
    
    function createCategoryDropdown() {
        const select = document.createElement('select');
        select.className = 'form-select form-select-sm';
        select.add(new Option('Select category...', ''));
        allCategories.forEach(cat => select.add(new Option(`${cat.team_name} -> ${cat.category_name}`, cat.id)));
        return select;
    }

    saveCategorizationRulesBtn.addEventListener('click', async () => {
        const getRulesFromTable = (table) => Array.from(table.rows).map(row => ({
            text: row.cells[0].textContent,
            category_id: row.cells[1].querySelector('select').value
        })).filter(rule => rule.category_id);

        const editRulesToSave = getRulesFromTable(uncategorizedEditsTable);
        const noteRulesToSave = getRulesFromTable(uncategorizedNotesTable);

        try {
            if (editRulesToSave.length > 0) await fetch(`${RULES_API}?type=edit`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(editRulesToSave) });
            if (noteRulesToSave.length > 0) await fetch(`${RULES_API}?type=note`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(noteRulesToSave) });
            
            if (editRulesToSave.length || noteRulesToSave.length) {
                alert('Rules saved successfully!');
                rulesAssignmentContainer.style.display = 'none';
                noRulesFoundDiv.textContent = 'Upload a file to begin.';
                noRulesFoundDiv.style.display = 'block';
                await loadRules();
            } else {
                alert('No new rules were assigned.');
            }
        } catch (error) { alert(`Failed to save rules: ${error.message}`); }
    });

    // Initial Load
    loadAllData();
});
</script>
</body>
</html>
