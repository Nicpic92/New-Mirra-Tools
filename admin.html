<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Report Configurations</h1>
        <p>Manage the saved settings for the claims dashboard.</p>
        
        <div class="row">
            <!-- List of existing configurations -->
            <div class="col-md-6">
                <h2>Existing Configurations</h2>
                <ul class="list-group" id="configList">
                    <!-- Configurations will be loaded here -->
                </ul>
            </div>

            <!-- Form to add or edit a configuration -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h2 id="formTitle">Add New Configuration</h2>
                        <form id="configForm">
                            <input type="hidden" id="configId">
                            <div class="mb-3">
                                <label for="configName" class="form-label">Configuration Name</label>
                                <input type="text" class="form-control" id="configName" placeholder="e.g., Q1 Report, High-Risk Providers" required>
                            </div>
                            <div class="mb-3">
                                <label for="clientName" class="form-label">Client Name</label>
                                <input type="text" class="form-control" id="clientName" placeholder="Client Name for Reports">
                            </div>
                            <div class="mb-3">
                                <label for="agingCalc" class="form-label">Aging Calculation Basis</label>
                                <select class="form-select" id="agingCalc">
                                    <option value="legacy">31+ (Legacy/30-Day)</option>
                                    <option value="cms">31-59 / 60+ (CMS/60-Day)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Configuration</button>
                            <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const configList = document.getElementById('configList');
    const configForm = document.getElementById('configForm');
    const formTitle = document.getElementById('formTitle');
    const configIdInput = document.getElementById('configId');
    const configNameInput = document.getElementById('configName');
    const clientNameInput = document.getElementById('clientName');
    const agingCalcInput = document.getElementById('agingCalc');
    const clearBtn = document.getElementById('clearBtn');
    
    // API endpoint for our function
    const API_ENDPOINT = '/.netlify/functions/configurations';

    // Load and display all configurations
    async function loadConfigurations() {
        try {
            const response = await fetch(API_ENDPOINT);
            const configs = await response.json();
            configList.innerHTML = ''; // Clear list
            if (configs.length === 0) {
                configList.innerHTML = '<li class="list-group-item">No configurations found.</li>';
                return;
            }
            configs.forEach(config => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = config.config_name;
                
                const buttonsDiv = document.createElement('div');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteConfig(config.id);
                
                buttonsDiv.appendChild(deleteBtn);
                li.appendChild(buttonsDiv);
                
                configList.appendChild(li);
            });
        } catch (error) {
            console.error('Error loading configurations:', error);
            alert('Failed to load configurations.');
        }
    }

    // Handle form submission for creating or updating
    configForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = configIdInput.value;
        const config_name = configNameInput.value;
        const config_data = {
            clientName: clientNameInput.value,
            agingCalc: agingCalcInput.value
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_ENDPOINT}?id=${id}` : API_ENDPOINT;

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ config_name, config_data })
            });
            if (!response.ok) throw new Error('Save operation failed');
            
            alert(`Configuration successfully ${id ? 'updated' : 'created'}!`);
            clearForm();
            loadConfigurations();
        } catch (error) {
            console.error('Error saving configuration:', error);
            alert('Failed to save configuration.');
        }
    });

    // Delete a configuration
    async function deleteConfig(id) {
        if (!confirm('Are you sure you want to delete this configuration?')) return;
        try {
            const response = await fetch(`${API_ENDPOINT}?id=${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Delete failed');
            alert('Configuration deleted.');
            loadConfigurations();
        } catch (error) {
            console.error('Error deleting:', error);
            alert('Failed to delete configuration.');
        }
    }
    
    // Clear the form to its default state
    function clearForm() {
        configForm.reset();
        configIdInput.value = '';
        formTitle.textContent = 'Add New Configuration';
    }
    
    clearBtn.addEventListener('click', clearForm);

    // Initial load
    loadConfigurations();
});
</script>
</body>
</html>
