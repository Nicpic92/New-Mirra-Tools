<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Report Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .mapping-table th { width: 30%; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Report Configurations</h1>
            <a href="/" class="btn btn-outline-primary">Go to Dashboard</a>
        </div>
        
        <!-- Existing Configuration Management -->
        <div class="row g-5">
            <!-- Form to add or edit a configuration -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-body">
                        <h2 id="formTitle">Add/Edit Client Configuration</h2>
                        <p class="text-muted">Manage the saved settings for individual clients, including their specific column mappings.</p>
                        <form id="configForm">
                            <input type="hidden" id="configId">
                            <h5>Step 1: Basic Information</h5>
                            <div class="mb-3">
                                <label for="configName" class="form-label">Configuration Name</label>
                                <input type="text" class="form-control" id="configName" placeholder="e.g., Q1 Report, High-Risk Providers" required>
                            </div>
                            <div class="mb-3">
                                <label for="clientName" class="form-label">Client Name (for PDF Reports)</label>
                                <input type="text" class="form-control" id="clientName" placeholder="Client Name for Reports">
                            </div>
                            <hr>
                            <h5>Step 2: Upload Sample Report to Map Columns</h5>
                             <div class="mb-3">
                                <label for="reportUploader" class="form-label">Upload XLSX File</label>
                                <input class="form-control" type="file" id="reportUploader" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                            </div>
                            <div id="mappingSection" class="mt-4" style="display: none;">
                                <h6>Map Your Fields to Detected Headers:</h6>
                                <table class="table table-bordered table-sm mapping-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Standard Field</th>
                                            <th>Client's Column Header</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mappingTableBody"></tbody>
                                </table>
                            </div>
                            <hr>
                            <button type="submit" class="btn btn-primary">Save Configuration</button>
                            <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                        </form>
                    </div>
                </div>
            </div>
            <!-- List of existing configurations -->
            <div class="col-md-5">
                <h2>Existing Configurations</h2>
                <ul class="list-group" id="configList"></ul>
            </div>
        </div>

        <!-- NEW SECTION FOR CATEGORIZATION RULES -->
        <div class="row g-5 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2 id="categorizationTitle">Global Categorization Rules</h2>
                        <p class="text-muted">Configure how claim edits and note keywords are categorized. These rules are global and apply to all clients. Upload a report to discover new, uncategorized items.</p>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="categorizationConfigSelector" class="form-label fw-bold">1. Select Config to Read Columns</label>
                                <select class="form-select" id="categorizationConfigSelector">
                                    <option>Load client configs first...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="categorizationReportUploader" class="form-label fw-bold">2. Upload Report to Find New Rules</label>
                                <input class="form-control" type="file" id="categorizationReportUploader" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" disabled>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Manage Categories</h5>
                                <ul class="list-group mb-3" id="categoryList"></ul>
                                <form id="newCategoryForm" class="d-flex">
                                    <input type="text" id="newCategoryName" class="form-control me-2" placeholder="New Category Name" required>
                                    <button type="submit" class="btn btn-primary btn-sm">Add</button>
                                </form>
                            </div>
                            <div class="col-md-8">
                                <h5>Assign Rules</h5>
                                <p class="small">Newly detected, uncategorized claim edits and note keywords from your upload will appear here. Assign them to a category.</p>
                                
                                <div id="rulesAssignmentContainer" style="display: none;">
                                    <h6>Uncategorized Claim Edits</h6>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light"><tr><th>Edit Text</th><th>Assign to Category</th></tr></thead>
                                        <tbody id="uncategorizedEditsTable"></tbody>
                                    </table>
                                    
                                    <h6 class="mt-4">Uncategorized Note Keywords</h6>
                                    <table class="table table-sm table-bordered">
                                       <thead class="table-light"><tr><th>Note Keyword</th><th>Assign to Category</th></tr></thead>
                                       <tbody id="uncategorizedNotesTable"></tbody>
                                    </table>

                                    <button id="saveCategorizationRulesBtn" class="btn btn-success mt-3">Save All Assignments</button>
                                </div>
                                <div id="noRulesFound" class="alert alert-info">Upload a file to begin.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- START: ORIGINAL CLIENT CONFIGURATION SCRIPT ---
    const configForm = document.getElementById('configForm');
    const formTitle = document.getElementById('formTitle');
    const configIdInput = document.getElementById('configId');
    const configNameInput = document.getElementById('configName');
    const clientNameInput = document.getElementById('clientName');
    const clearBtn = document.getElementById('clearBtn');
    const reportUploader = document.getElementById('reportUploader');
    const mappingSection = document.getElementById('mappingSection');
    const mappingTableBody = document.getElementById('mappingTableBody');
    const configList = document.getElementById('configList');
    let detectedHeaders = [];
    const API_ENDPOINT = '/.netlify/functions/configurations';
    const standardFields = [
        { key: 'claimId',        displayName: 'Claim ID / Number',    required: true },
        { key: 'age',            displayName: 'Age (in days)',        required: true },
        { key: 'netPayment',     displayName: 'Net Payment Amount',   required: true },
        { key: 'state',          displayName: 'Claim State',          required: true },
        { key: 'status',         displayName: 'Claim Status',         required: true },
        { key: 'networkStatus',  displayName: 'Network Status',       required: true },
        { key: 'providerName',   displayName: 'Billing Provider Name',required: true },
        { key: 'dsnp',           displayName: 'DSNP Status',          required: false },
        { key: 'edit',           displayName: 'Claim Edits',          required: true }, // Made required for categorization
        { key: 'notes',          displayName: 'Claim Notes',          required: true }, // Made required for categorization
    ];
    reportUploader.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            detectedHeaders = json[0] || [];
            renderMappingUI();
        };
        reader.readAsArrayBuffer(file);
    });

    function renderMappingUI() {
        mappingTableBody.innerHTML = '';
        standardFields.forEach(field => {
            const row = document.createElement('tr');
            row.insertCell().innerHTML = `${field.displayName}${field.required ? ' <span class="text-danger">*</span>' : ''}`;
            const cell2 = row.insertCell();
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm';
            select.dataset.standardKey = field.key;
            select.add(new Option(field.required ? 'Select a header...' : 'Optional', ''));
            detectedHeaders.forEach(header => { select.add(new Option(header, header)); });
            cell2.appendChild(select);
            mappingTableBody.appendChild(row);
        });
        mappingSection.style.display = 'block';
    }

    async function loadConfigurations() {
        try {
            const response = await fetch(API_ENDPOINT);
            const configs = await response.json();
            configList.innerHTML = configs.length ? '' : '<li class="list-group-item">No configurations found.</li>';
            
            // Also populate the selector in the categorization section
            const categorizationSelector = document.getElementById('categorizationConfigSelector');
            categorizationSelector.innerHTML = '<option selected disabled value="">Select a configuration...</option>';
            window.allClientConfigs = configs; // Make available globally for categorization script

            configs.forEach(config => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = config.config_name;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteConfig(config.id);
                li.appendChild(deleteBtn);
                configList.appendChild(li);

                categorizationSelector.add(new Option(config.config_name, config.id));
            });
        } catch (error) {
            console.error('Error loading configurations:', error);
        }
    }

    configForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const columnMappings = {};
        mappingTableBody.querySelectorAll('select').forEach(sel => { if (sel.value) { columnMappings[sel.dataset.standardKey] = sel.value; } });
        const id = configIdInput.value;
        const config_name = configNameInput.value;
        // Note: The 'agingCalc' input was removed from the HTML for simplicity, but if you re-add it, include it here.
        const config_data = { clientName: clientNameInput.value, columnMappings };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_ENDPOINT}?id=${id}` : API_ENDPOINT;
        try {
            const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config_name, config_data }) });
            if (!response.ok) throw new Error('Save failed');
            alert(`Configuration ${id ? 'updated' : 'created'}!`);
            clearForm();
            loadConfigurations();
        } catch (error) {
            console.error('Error saving:', error);
            alert('Failed to save configuration.');
        }
    });

    async function deleteConfig(id) {
        if (!confirm('Are you sure?')) return;
        try {
            const response = await fetch(`${API_ENDPOINT}?id=${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Delete failed');
            alert('Configuration deleted.');
            loadConfigurations();
        } catch (error) {
            console.error('Error deleting:', error);
        }
    }
    
    function clearForm() {
        configForm.reset();
        configIdInput.value = '';
        formTitle.textContent = 'Add New Configuration';
        mappingSection.style.display = 'none';
    }
    
    clearBtn.addEventListener('click', clearForm);
    loadConfigurations();
    // --- END: ORIGINAL CLIENT CONFIGURATION SCRIPT ---


    // --- START: NEW CATEGORIZATION UI SCRIPT ---
    const categorizationConfigSelector = document.getElementById('categorizationConfigSelector');
    const categorizationReportUploader = document.getElementById('categorizationReportUploader');
    const categoryList = document.getElementById('categoryList');
    const newCategoryForm = document.getElementById('newCategoryForm');
    const newCategoryNameInput = document.getElementById('newCategoryName');
    const uncategorizedEditsTable = document.getElementById('uncategorizedEditsTable');
    const uncategorizedNotesTable = document.getElementById('uncategorizedNotesTable');
    const saveCategorizationRulesBtn = document.getElementById('saveCategorizationRulesBtn');
    const rulesAssignmentContainer = document.getElementById('rulesAssignmentContainer');
    const noRulesFoundDiv = document.getElementById('noRulesFound');
    
    let allCategories = [];
    let existingEditRules = new Map();
    let existingNoteRules = new Map();
    let columnMappingsForCategorization = {};
    const CATEGORIES_API = '/.netlify/functions/categories';
    const RULES_API = '/.netlify/functions/rules';

    async function loadCategories() {
        try {
            const response = await fetch(CATEGORIES_API);
            allCategories = await response.json();
            renderCategoryList();
        } catch (error) {
            console.error("Failed to load categories:", error);
        }
    }

    async function loadRules() {
        try {
            const [editRes, noteRes] = await Promise.all([
                fetch(`${RULES_API}?type=edit`),
                fetch(`${RULES_API}?type=note`)
            ]);
            const edits = await editRes.json();
            const notes = await noteRes.json();
            existingEditRules = new Map(edits.map(rule => [rule.text, rule.category_id]));
            existingNoteRules = new Map(notes.map(rule => [rule.text, rule.category_id]));
        } catch (error) {
            console.error("Failed to load existing rules:", error);
        }
    }

    function renderCategoryList() {
        categoryList.innerHTML = allCategories.length ? '' : '<li class="list-group-item">No categories defined.</li>';
        allCategories.forEach(cat => {
            const li = document.createElement('li');
            li.className = 'list-group-item py-1 d-flex justify-content-between align-items-center';
            li.textContent = cat.category_name;
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline-danger btn-sm py-0 px-1';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = () => deleteCategory(cat.id);
            li.appendChild(deleteBtn);
            categoryList.appendChild(li);
        });
    }

    function createCategoryDropdown() {
        const select = document.createElement('select');
        select.className = 'form-select form-select-sm';
        select.add(new Option('Select category...', ''));
        allCategories.forEach(cat => select.add(new Option(cat.category_name, cat.id)));
        return select;
    }

    categorizationConfigSelector.addEventListener('change', () => {
        const selectedId = parseInt(categorizationConfigSelector.value, 10);
        const config = window.allClientConfigs.find(c => c.id === selectedId);
        if (config?.config_data?.columnMappings) {
            columnMappingsForCategorization = config.config_data.columnMappings;
            if (columnMappingsForCategorization.edit && columnMappingsForCategorization.notes) {
                categorizationReportUploader.disabled = false;
            } else {
                alert('This configuration is missing mappings for "Claim Edits" or "Claim Notes".');
                categorizationReportUploader.disabled = true;
            }
        }
    });

    categorizationReportUploader.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            processUploadedReport(data);
        };
        reader.readAsArrayBuffer(file);
    });

    function processUploadedReport(data) {
        const detectedEdits = new Set();
        const detectedNoteKeywords = new Set();
        const editColumn = columnMappingsForCategorization.edit;
        const notesColumn = columnMappingsForCategorization.notes;

        data.forEach(row => {
            const editValue = row[editColumn];
            if (editValue && !existingEditRules.has(editValue)) {
                detectedEdits.add(editValue);
            }
            const noteValue = (row[notesColumn] || '').toLowerCase();
            // A simple keyword extractor - splits by non-alphanumeric characters
            noteValue.split(/[^a-z0-9]+/).forEach(word => {
                // Filter out common/short words
                if (word.length > 3 && !existingNoteRules.has(word)) {
                     detectedNoteKeywords.add(word);
                }
            });
        });

        uncategorizedEditsTable.innerHTML = '';
        detectedEdits.forEach(editText => {
            const row = uncategorizedEditsTable.insertRow();
            row.insertCell().textContent = editText;
            row.insertCell().appendChild(createCategoryDropdown());
        });
        
        uncategorizedNotesTable.innerHTML = '';
        detectedNoteKeywords.forEach(keyword => {
            const row = uncategorizedNotesTable.insertRow();
            row.insertCell().textContent = keyword;
            row.insertCell().appendChild(createCategoryDropdown());
        });
        
        const hasRules = detectedEdits.size > 0 || detectedNoteKeywords.size > 0;
        rulesAssignmentContainer.style.display = hasRules ? 'block' : 'none';
        noRulesFoundDiv.style.display = hasRules ? 'none' : 'block';
        noRulesFoundDiv.textContent = 'No new, uncategorized edits or notes were found in the uploaded file.';
    }

    newCategoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = newCategoryNameInput.value.trim();
        if (!name) return;
        try {
            const response = await fetch(CATEGORIES_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category_name: name }) });
            if (!response.ok) throw new Error('Failed to create category');
            newCategoryNameInput.value = '';
            await loadCategories();
        } catch (error) {
            alert('Failed to add category. It may already exist.');
        }
    });

    async function deleteCategory(id) {
        if (!confirm('Are you sure? Deleting a category will also delete all associated rules.')) return;
        try {
            const response = await fetch(`${CATEGORIES_API}?id=${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Delete failed');
            await loadCategories();
        } catch (error) {
            alert('Failed to delete category.');
        }
    }

    saveCategorizationRulesBtn.addEventListener('click', async () => {
        const getRulesFromTable = (table) => Array.from(table.querySelectorAll('tr')).map(row => ({
            text: row.cells[0].textContent,
            category_id: row.cells[1].querySelector('select').value
        })).filter(rule => rule.text && rule.category_id);

        const editRulesToSave = getRulesFromTable(uncategorizedEditsTable);
        const noteRulesToSave = getRulesFromTable(uncategorizedNotesTable);

        try {
            let saved = false;
            if (editRulesToSave.length > 0) {
                const res = await fetch(`${RULES_API}?type=edit`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(editRulesToSave) });
                if (!res.ok) throw new Error('Failed to save edit rules');
                saved = true;
            }
            if (noteRulesToSave.length > 0) {
                const res = await fetch(`${RULES_API}?type=note`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(noteRulesToSave) });
                if (!res.ok) throw new Error('Failed to save note rules');
                saved = true;
            }
            if (saved) {
                alert('Rules saved successfully!');
                uncategorizedEditsTable.innerHTML = '';
                uncategorizedNotesTable.innerHTML = '';
                rulesAssignmentContainer.style.display = 'none';
                noRulesFoundDiv.style.display = 'block';
                noRulesFoundDiv.textContent = 'Upload a file to begin.';
                await loadRules();
            } else {
                alert('No new rules were assigned to a category.');
            }
        } catch (error) {
            alert(`Failed to save rules: ${error.message}`);
        }
    });

    loadCategories();
    loadRules();
    // --- END: NEW CATEGORIZATION UI SCRIPT ---
});
</script>
</body>
</html>
